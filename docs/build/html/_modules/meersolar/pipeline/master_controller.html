<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />

    <!-- Generated with Sphinx 7.4.7 and Furo 2024.01.29 -->
        <title>meersolar.pipeline.master_controller - MeerSOLAR</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=25136de1" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">MeerSOLAR</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../../_static/logo.png" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../../../_static/logo.png" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">MeerSOLAR</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../install.html">Installation</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Installation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../install_conda.html">Install Conda: Anaconda or Miniconda</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../activate_conda.html">Create and Activate Conda Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../install_meersolar.html">Install MeerSOLAR</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../idia_setup.html">Installation on IDIA-ilifu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../initial_setup.html">Initial Setup</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../tutorial.html">Tutorial</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Tutorial</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../flowchart.html">MeerSOLAR Flowchart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../runpipeline.html">Run MeerSOLAR Pipeline</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../logger.html">Monitoring MeerSOLAR Pipeline Jobs</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Monitoring MeerSOLAR Pipeline Jobs</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../locallogger.html">Local GUI Logger</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../remotelogger.html">Remote MeerSOLAR Logger</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../output.html">Directory Structure and Data Products</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kill.html">Stop MeerSOLAR Job</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../cli.html">Command line tools</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Command line tools</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../basic_cli.html">Basic CLI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../adv_cli.html">Advanced CLI</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../ack.html">Acknowledging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lic.html">LICENSE</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../meersolar.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../meersolar.pipeline.html">Meersolar Pipeline Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../meersolar.crystalball.html">Crystalball Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../meersolar.data.html">MeerSOLAR Pre-compiled Modules</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for meersolar.pipeline.master_controller</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">meersolar.pipeline.basic_func</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">logfile</span> <span class="o">=</span> <span class="n">casalog</span><span class="o">.</span><span class="n">logfile</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">logfile</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<div class="viewcode-block" id="run_flag">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.master_controller.run_flag">[docs]</a>
<span class="k">def</span> <span class="nf">run_flag</span><span class="p">(</span>
    <span class="n">msname</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">flag_calibrators</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cpu_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">mem_frac</span><span class="o">=</span><span class="mf">0.8</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run flagging jobs</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname: str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Working directory</span>
<span class="sd">    flag_calibrators : bool, optional</span>
<span class="sd">        Flag calibrator fields</span>
<span class="sd">    jobid : int, optional</span>
<span class="sd">        Job ID</span>
<span class="sd">    cpu_frac : float, optional</span>
<span class="sd">        CPU fraction to use</span>
<span class="sd">    mem_frac : float, optional</span>
<span class="sd">        Memory fraction to use</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Flagging ....&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1">########################</span>
    <span class="c1"># Calibrator ms flagging</span>
    <span class="c1">########################</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flag_calibrators</span><span class="p">:</span>
        <span class="n">flagfield_type</span> <span class="o">=</span> <span class="s2">&quot;cal&quot;</span>
        <span class="n">flagging_cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;run_flag </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot; --datacolumn DATA --use_tfcrop&quot;</span>
            <span class="o">+</span> <span class="s2">&quot; --cpu_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --mem_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --workdir &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --jobid &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flagfield_type</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span>
        <span class="n">flagging_cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;run_flag </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot; --datacolumn DATA --use_tfcrop --flagdimension freq&quot;</span>
            <span class="o">+</span> <span class="s2">&quot; --cpu_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --mem_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --workdir &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --jobid &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">flag_basename</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;flagging_</span><span class="si">{</span><span class="n">flagfield_type</span><span class="si">}</span><span class="s2">_&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.ms&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">logfile</span> <span class="o">=</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs/&quot;</span> <span class="o">+</span> <span class="n">flag_basename</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span>
    <span class="n">flagging_cmd</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; --logfile </span><span class="si">{</span><span class="n">logfile</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">batch_file</span> <span class="o">=</span> <span class="n">create_batch_script_nonhpc</span><span class="p">(</span><span class="n">flagging_cmd</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">flag_basename</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">flagging_cmd</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;bash &quot;</span> <span class="o">+</span> <span class="n">batch_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting to finish flagging...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">finished_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/.Finished_&quot;</span> <span class="o">+</span> <span class="n">flag_basename</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">success_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">finished_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">success_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initial flagging is done successfully.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initial flagging is not done successfully.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="run_import_model">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.master_controller.run_import_model">[docs]</a>
<span class="k">def</span> <span class="nf">run_import_model</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cpu_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">mem_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Importing calibrator models</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname: str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Working directory</span>
<span class="sd">    cpu_frac : float, optional</span>
<span class="sd">        CPU fraction to use</span>
<span class="sd">    mem_frac : float, optional</span>
<span class="sd">        Memory fraction to use</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Importing model of calibrators....&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">import_model_cmd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;import_model </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="o">+</span> <span class="s2">&quot; --workdir &quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
        <span class="o">+</span> <span class="s2">&quot; --cpu_frac &quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">)</span>
        <span class="o">+</span> <span class="s2">&quot; --mem_frac &quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">)</span>
        <span class="o">+</span> <span class="s2">&quot; --jobid &quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">model_basename</span> <span class="o">=</span> <span class="s2">&quot;modeling_&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.ms&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">logfile</span> <span class="o">=</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs/&quot;</span> <span class="o">+</span> <span class="n">model_basename</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span>
    <span class="n">import_model_cmd</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; --logfile </span><span class="si">{</span><span class="n">logfile</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">batch_file</span> <span class="o">=</span> <span class="n">create_batch_script_nonhpc</span><span class="p">(</span><span class="n">import_model_cmd</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">model_basename</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">import_model_cmd</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;bash &quot;</span> <span class="o">+</span> <span class="n">batch_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting to finish visibility simulation for calibrators...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">finished_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/.Finished_&quot;</span> <span class="o">+</span> <span class="n">model_basename</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">success_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">finished_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">success_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Visibility simulation for calibrator fields are done successfully.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Visibility simulation for calibrator fields are not done successfully.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="run_basic_cal_jobs">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.master_controller.run_basic_cal_jobs">[docs]</a>
<span class="k">def</span> <span class="nf">run_basic_cal_jobs</span><span class="p">(</span>
    <span class="n">msname</span><span class="p">,</span>
    <span class="n">workdir</span><span class="p">,</span>
    <span class="n">caldir</span><span class="p">,</span>
    <span class="n">perform_polcal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">jobid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">cpu_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">mem_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">keep_backup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform basic calibration</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname: str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Working directory</span>
<span class="sd">    caldir : str</span>
<span class="sd">        Caltable directory</span>
<span class="sd">    perform_polcal : bool, optional</span>
<span class="sd">        Perform full polarization calibration</span>
<span class="sd">    cpu_frac : float, optional</span>
<span class="sd">        CPU fraction to use</span>
<span class="sd">    mem_frac : float, optional</span>
<span class="sd">        Memory fraction to use</span>
<span class="sd">    keep_backup : bool, optional</span>
<span class="sd">        Keep backups</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message for basic calibration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Performing basic calibration .....&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">cal_basename</span> <span class="o">=</span> <span class="s2">&quot;basic_cal&quot;</span>
    <span class="n">basic_cal_cmd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;run_basic_cal </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="o">+</span> <span class="s2">&quot; --workdir &quot;</span>
        <span class="o">+</span> <span class="n">workdir</span>
        <span class="o">+</span> <span class="s2">&quot; --caldir &quot;</span>
        <span class="o">+</span> <span class="n">caldir</span>
        <span class="o">+</span> <span class="s2">&quot; --cpu_frac &quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">)</span>
        <span class="o">+</span> <span class="s2">&quot; --mem_frac &quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">)</span>
        <span class="o">+</span> <span class="s2">&quot; --jobid &quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">perform_polcal</span><span class="p">:</span>
        <span class="n">basic_cal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --perform_polcal&quot;</span>
    <span class="k">if</span> <span class="n">keep_backup</span><span class="p">:</span>
        <span class="n">basic_cal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --keep_backup&quot;</span>
    <span class="n">logfile</span> <span class="o">=</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs/&quot;</span> <span class="o">+</span> <span class="n">cal_basename</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span>
    <span class="n">basic_cal_cmd</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; --logfile </span><span class="si">{</span><span class="n">logfile</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">batch_file</span> <span class="o">=</span> <span class="n">create_batch_script_nonhpc</span><span class="p">(</span><span class="n">basic_cal_cmd</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">cal_basename</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">basic_cal_cmd</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;bash &quot;</span> <span class="o">+</span> <span class="n">batch_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting to finish calibration...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">finished_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/.Finished_&quot;</span> <span class="o">+</span> <span class="n">cal_basename</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">success_index_cal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">finished_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">success_index_cal</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Basic calibration is done successfully.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Basic calibration is unsuccessful.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">success_index_cal</span></div>



<div class="viewcode-block" id="run_noise_diode_cal">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.master_controller.run_noise_diode_cal">[docs]</a>
<span class="k">def</span> <span class="nf">run_noise_diode_cal</span><span class="p">(</span>
    <span class="n">msname</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">caldir</span><span class="p">,</span> <span class="n">keep_backup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cpu_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">mem_frac</span><span class="o">=</span><span class="mf">0.8</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform noise diode based flux calibration</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname: str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Working directory</span>
<span class="sd">    caldir : str</span>
<span class="sd">        Caltable directory</span>
<span class="sd">    keep_backup : bool, optional</span>
<span class="sd">        Keep backup</span>
<span class="sd">    cpu_frac : float, optional</span>
<span class="sd">        CPU fraction to use</span>
<span class="sd">    mem_frac : float, optional</span>
<span class="sd">        Memory fraction to use</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message for noise diode based flux calibration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Performing noise diode based flux calibration .....&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">msname</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">noisecal_basename</span> <span class="o">=</span> <span class="s2">&quot;noise_cal&quot;</span>
        <span class="n">noise_cal_cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;run_fluxcal </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot; --workdir &quot;</span>
            <span class="o">+</span> <span class="n">workdir</span>
            <span class="o">+</span> <span class="s2">&quot; --caldir &quot;</span>
            <span class="o">+</span> <span class="n">caldir</span>
            <span class="o">+</span> <span class="s2">&quot; --cpu_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --mem_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --jobid &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">logfile</span> <span class="o">=</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs/&quot;</span> <span class="o">+</span> <span class="n">noisecal_basename</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span>
        <span class="n">noise_cal_cmd</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; --logfile </span><span class="si">{</span><span class="n">logfile</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">batch_file</span> <span class="o">=</span> <span class="n">create_batch_script_nonhpc</span><span class="p">(</span>
            <span class="n">noise_cal_cmd</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">noisecal_basename</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">noise_cal_cmd</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;bash &quot;</span> <span class="o">+</span> <span class="n">batch_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting to finish noise-diode based flux calibration...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">finished_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/.Finished_&quot;</span> <span class="o">+</span> <span class="n">noisecal_basename</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">success_index_noisecal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">finished_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">success_index_noisecal</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Noise-diode based flux-calibration is done successfully.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="run_partion">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.master_controller.run_partion">[docs]</a>
<span class="k">def</span> <span class="nf">run_partion</span><span class="p">(</span>
    <span class="n">msname</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">split_fullpol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cpu_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">mem_frac</span><span class="o">=</span><span class="mf">0.8</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform basic calibration</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname: str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Working directory</span>
<span class="sd">    split_fullpol : bool, optional</span>
<span class="sd">        Perform full polar split</span>
<span class="sd">    cpu_frac : float, optional</span>
<span class="sd">        CPU fraction to use</span>
<span class="sd">    mem_frac : float, optional</span>
<span class="sd">        Memory fraction to use</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Partitioning measurement set ...&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">nchan</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">nchan</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">timesforfield</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">timeres</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">exposuretime</span><span class="p">(</span><span class="n">scan</span><span class="p">)[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">timeres</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">nchan</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nchan</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">timeres</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">timebin</span> <span class="o">=</span> <span class="s2">&quot;8s&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">timebin</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">target_scans</span><span class="p">,</span> <span class="n">cal_scans</span><span class="p">,</span> <span class="n">f_scans</span><span class="p">,</span> <span class="n">g_scans</span><span class="p">,</span> <span class="n">p_scans</span> <span class="o">=</span> <span class="n">get_cal_target_scans</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">cal_scans_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">cal_scans</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">cal_scans</span><span class="p">:</span>
        <span class="n">noise_cal_scan</span> <span class="o">=</span> <span class="n">determine_noise_diode_cal_scan</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">noise_cal_scan</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing noise-diode scan: </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">cal_scans_copy</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">cal_scans</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">cal_scans_copy</span><span class="p">)</span>
    <span class="n">cal_scans</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">cal_scans</span><span class="p">])</span>
    <span class="n">calibrator_ms</span> <span class="o">=</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/calibrator.ms&quot;</span>
    <span class="n">split_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;run_partition </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="s2"> --outputms </span><span class="si">{</span><span class="n">calibrator_ms</span><span class="si">}</span><span class="s2"> --scans </span><span class="si">{</span><span class="n">cal_scans</span><span class="si">}</span><span class="s2"> --timebin </span><span class="si">{</span><span class="n">timebin</span><span class="si">}</span><span class="s2"> --width </span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2"> --cpu_frac </span><span class="si">{</span><span class="n">cpu_frac</span><span class="si">}</span><span class="s2"> --mem_frac </span><span class="si">{</span><span class="n">mem_frac</span><span class="si">}</span><span class="s2"> --workdir </span><span class="si">{</span><span class="n">workdir</span><span class="si">}</span><span class="s2"> --jobid </span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">split_fullpol</span><span class="p">:</span>
        <span class="n">split_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --split_fullpol&quot;</span>
    <span class="c1">####################################</span>
    <span class="c1"># Partition fields</span>
    <span class="c1">####################################</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">########################################&quot;</span><span class="p">)</span>
    <span class="n">partition_basename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;partition_cal&quot;</span>
    <span class="n">logfile</span> <span class="o">=</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs/&quot;</span> <span class="o">+</span> <span class="n">partition_basename</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span>
    <span class="n">split_cmd</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; --logfile </span><span class="si">{</span><span class="n">logfile</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">batch_file</span> <span class="o">=</span> <span class="n">create_batch_script_nonhpc</span><span class="p">(</span><span class="n">split_cmd</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">partition_basename</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">split_cmd</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;bash &quot;</span> <span class="o">+</span> <span class="n">batch_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting to finish partitioning...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">finished_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/.Finished_&quot;</span> <span class="o">+</span> <span class="n">partition_basename</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Partitioning is finished.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">calibrator_ms</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calibrator ms: </span><span class="si">{</span><span class="n">calibrator_ms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calibrator fields could not be partitioned.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="run_target_split_jobs">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.master_controller.run_target_split_jobs">[docs]</a>
<span class="k">def</span> <span class="nf">run_target_split_jobs</span><span class="p">(</span>
    <span class="n">msname</span><span class="p">,</span>
    <span class="n">workdir</span><span class="p">,</span>
    <span class="n">datacolumn</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
    <span class="n">spw</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">timeres</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">freqres</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">target_freq_chunk</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">n_spectral_chunk</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">target_scans</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;targets&quot;</span><span class="p">,</span>
    <span class="n">split_fullpol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">merge_spws</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">time_window</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">time_interval</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">jobid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">cpu_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">mem_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">max_cpu_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">max_mem_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split target scans</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname: str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Working directory</span>
<span class="sd">    datacolumn : str, optional</span>
<span class="sd">        Data column</span>
<span class="sd">    spw : str, optional</span>
<span class="sd">        Spectral window to split</span>
<span class="sd">    timeres : float, optional</span>
<span class="sd">        Time bin to average in seconds</span>
<span class="sd">    freqres : float, optional</span>
<span class="sd">        Frequency averaging in MHz</span>
<span class="sd">    target_freq_chunk : float, optional</span>
<span class="sd">        Target frequency chunk in MHz</span>
<span class="sd">    n_spectral_chunk : int, optional</span>
<span class="sd">        Number of spectral chunks to split</span>
<span class="sd">    target_scans : list, optional</span>
<span class="sd">        Target scans</span>
<span class="sd">    prefix : str, optional</span>
<span class="sd">        Prefix of splited targets</span>
<span class="sd">    split_fullpol : bool, optional</span>
<span class="sd">        Split full polar data or not</span>
<span class="sd">    merge_spws : bool, optional</span>
<span class="sd">        Merge spectral windows</span>
<span class="sd">    time_window : float, optional</span>
<span class="sd">        Time window in seconds</span>
<span class="sd">    time_interval : float, optional</span>
<span class="sd">        Time interval in seconds</span>
<span class="sd">    cpu_frac : float, optional</span>
<span class="sd">        CPU fraction to use</span>
<span class="sd">    mem_frac : float, optional</span>
<span class="sd">        Memory fraction to use</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message for spliting target scans</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;spliting target scans .....&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">msname</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">split_basename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;split_</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">split_cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;run_target_split </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot; --workdir &quot;</span>
            <span class="o">+</span> <span class="n">workdir</span>
            <span class="o">+</span> <span class="s2">&quot; --datacolumn &quot;</span>
            <span class="o">+</span> <span class="n">datacolumn</span>
            <span class="o">+</span> <span class="s2">&quot; --freqres &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">freqres</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --timeres &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeres</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --cpu_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --mem_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --spectral_chunk &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">target_freq_chunk</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --max_cpu_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_cpu_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --max_mem_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_mem_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --n_spectral_chunk &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_spectral_chunk</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --prefix &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --time_window &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_window</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --time_interval &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_interval</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --jobid &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">split_fullpol</span><span class="p">:</span>
            <span class="n">split_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --split_fullpol&quot;</span>
        <span class="k">if</span> <span class="n">merge_spws</span><span class="p">:</span>
            <span class="n">split_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --merge_spws&quot;</span>
        <span class="k">if</span> <span class="n">spw</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">split_cmd</span> <span class="o">=</span> <span class="n">split_cmd</span> <span class="o">+</span> <span class="s2">&quot; --spw &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_scans</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">split_cmd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">split_cmd</span> <span class="o">+</span> <span class="s2">&quot; --scans &quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">target_scans</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="n">logfile</span> <span class="o">=</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs/&quot;</span> <span class="o">+</span> <span class="n">split_basename</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span>
        <span class="n">split_cmd</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; --logfile </span><span class="si">{</span><span class="n">logfile</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">batch_file</span> <span class="o">=</span> <span class="n">create_batch_script_nonhpc</span><span class="p">(</span><span class="n">split_cmd</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">split_basename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">split_cmd</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;bash &quot;</span> <span class="o">+</span> <span class="n">batch_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="run_solar_siderealcor_jobs">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.master_controller.run_solar_siderealcor_jobs">[docs]</a>
<span class="k">def</span> <span class="nf">run_solar_siderealcor_jobs</span><span class="p">(</span>
    <span class="n">mslist</span><span class="p">,</span>
    <span class="n">workdir</span><span class="p">,</span>
    <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;targets&quot;</span><span class="p">,</span>
    <span class="n">jobid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">cpu_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">mem_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">max_cpu_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">max_mem_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply sidereal motion correction of the Sun</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mslist: str</span>
<span class="sd">        List of the measurement sets</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Work directory</span>
<span class="sd">    prefix : str, optional</span>
<span class="sd">        Measurement set prefix</span>
<span class="sd">    cpu_frac : float, optional</span>
<span class="sd">        CPU fraction to use</span>
<span class="sd">    mem_frac : float, optional</span>
<span class="sd">        Memory fraction to use</span>
<span class="sd">    max_cpu_frac : float, optional</span>
<span class="sd">        Maximum CPU fraction to use</span>
<span class="sd">    max_mem_frac : float, optional</span>
<span class="sd">        Maximum memory fraction to use</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Correcting sidereal motion .....&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">mslist</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mslist</span><span class="p">)</span>
        <span class="n">sidereal_basename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cor_sidereal_</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sidereal_cor_cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;run_solar_siderealcor </span><span class="si">{</span><span class="n">mslist</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot; --workdir &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --cpu_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --mem_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --max_cpu_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_cpu_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --max_mem_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_mem_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --jobid &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logfile</span> <span class="o">=</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs/&quot;</span> <span class="o">+</span> <span class="n">sidereal_basename</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span>
        <span class="n">sidereal_cor_cmd</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; --logfile </span><span class="si">{</span><span class="n">logfile</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">batch_file</span> <span class="o">=</span> <span class="n">create_batch_script_nonhpc</span><span class="p">(</span>
            <span class="n">sidereal_cor_cmd</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">sidereal_basename</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sidereal_cor_cmd</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;bash &quot;</span> <span class="o">+</span> <span class="n">batch_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting to finish sidereal correction...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">finished_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/.Finished_&quot;</span> <span class="o">+</span> <span class="n">sidereal_basename</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">success_index_cal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">finished_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">success_index_cal</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sidereal motion correction is done successfully.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sidereal motion correction is unsuccessful.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">success_index_cal</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="run_apply_pbcor">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.master_controller.run_apply_pbcor">[docs]</a>
<span class="k">def</span> <span class="nf">run_apply_pbcor</span><span class="p">(</span>
    <span class="n">imagedir</span><span class="p">,</span>
    <span class="n">workdir</span><span class="p">,</span>
    <span class="n">apply_parang</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">jobid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">cpu_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">mem_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply primary beam corrections on all images</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    imagedir: str</span>
<span class="sd">        Image directory name</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Work directory</span>
<span class="sd">    apply_parang : bool, optional</span>
<span class="sd">        Apply parallactic angle correction</span>
<span class="sd">    cpu_frac : float, optional</span>
<span class="sd">        CPU fraction to use</span>
<span class="sd">    mem_frac : float, optional</span>
<span class="sd">        Memory fraction to use</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message for applying primary beam correction on all images</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying primary beam corrections on all images .....&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">applypbcor_basename</span> <span class="o">=</span> <span class="s2">&quot;apply_pbcor&quot;</span>
        <span class="n">applypbcor_cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;run_meerpbcor </span><span class="si">{</span><span class="n">imagedir</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot; --workdir &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --cpu_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --mem_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --jobid &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">apply_parang</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">applypbcor_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --no_apply_parang&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logfile</span> <span class="o">=</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs/&quot;</span> <span class="o">+</span> <span class="n">applypbcor_basename</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span>
        <span class="n">applypbcor_cmd</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; --logfile </span><span class="si">{</span><span class="n">logfile</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">batch_file</span> <span class="o">=</span> <span class="n">create_batch_script_nonhpc</span><span class="p">(</span>
            <span class="n">applypbcor_cmd</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">applypbcor_basename</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">applypbcor_cmd</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;bash &quot;</span> <span class="o">+</span> <span class="n">batch_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting to finish apply primary beam correction...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">finished_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/.Finished_&quot;</span> <span class="o">+</span> <span class="n">applypbcor_basename</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">success_index_cal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">finished_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">success_index_cal</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying primary beam correction is done successfully.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying primary beam correction is unsuccessful.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">success_index_cal</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="run_apply_basiccal_sol">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.master_controller.run_apply_basiccal_sol">[docs]</a>
<span class="k">def</span> <span class="nf">run_apply_basiccal_sol</span><span class="p">(</span>
    <span class="n">target_mslist</span><span class="p">,</span>
    <span class="n">workdir</span><span class="p">,</span>
    <span class="n">caldir</span><span class="p">,</span>
    <span class="n">use_only_bandpass</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">overwrite_datacolumn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">applymode</span><span class="o">=</span><span class="s2">&quot;calflag&quot;</span><span class="p">,</span>
    <span class="n">jobid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">cpu_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">mem_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply basic calibration solutions on splited target scans</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    target_mslist: list</span>
<span class="sd">        Target measurement set list</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Working directory</span>
<span class="sd">    caldir : str</span>
<span class="sd">        Caltable directory</span>
<span class="sd">    use_only_bandpass : bool</span>
<span class="sd">        Use only bandpass solutions</span>
<span class="sd">    applymode : str, optional</span>
<span class="sd">        Applycal mode</span>
<span class="sd">    cpu_frac : float, optional</span>
<span class="sd">        CPU fraction to use</span>
<span class="sd">    mem_frac : float, optional</span>
<span class="sd">        Memory fraction to use</span>
<span class="sd">    overwrite_datacolumn : bool</span>
<span class="sd">        Overwrite data column or not</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message for applying calibration solutions and spliting target scans</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying basic calibration solutions on target scans .....&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">applycal_basename</span> <span class="o">=</span> <span class="s2">&quot;apply_basiccal&quot;</span>
        <span class="n">mslist</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_mslist</span><span class="p">)</span>
        <span class="n">applycal_cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;run_apply_basiccal </span><span class="si">{</span><span class="n">mslist</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot; --workdir &quot;</span>
            <span class="o">+</span> <span class="n">workdir</span>
            <span class="o">+</span> <span class="s2">&quot; --caldir &quot;</span>
            <span class="o">+</span> <span class="n">caldir</span>
            <span class="o">+</span> <span class="s2">&quot; --cpu_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --mem_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --applymode &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">applymode</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --jobid &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">use_only_bandpass</span><span class="p">:</span>
            <span class="n">applycal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --use_only_bandpass&quot;</span>
        <span class="k">if</span> <span class="n">overwrite_datacolumn</span><span class="p">:</span>
            <span class="n">applycal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --overwrite_datacolumn&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logfile</span> <span class="o">=</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs/&quot;</span> <span class="o">+</span> <span class="n">applycal_basename</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span>
        <span class="n">applycal_cmd</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; --logfile </span><span class="si">{</span><span class="n">logfile</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">batch_file</span> <span class="o">=</span> <span class="n">create_batch_script_nonhpc</span><span class="p">(</span>
            <span class="n">applycal_cmd</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">applycal_basename</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">applycal_cmd</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;bash &quot;</span> <span class="o">+</span> <span class="n">batch_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting to finish applycal...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">finished_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/.Finished_&quot;</span> <span class="o">+</span> <span class="n">applycal_basename</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">success_index_cal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">finished_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">success_index_cal</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying basic calibration is done successfully.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying basic calibration is unsuccessful.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">success_index_cal</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="run_apply_selfcal_sol">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.master_controller.run_apply_selfcal_sol">[docs]</a>
<span class="k">def</span> <span class="nf">run_apply_selfcal_sol</span><span class="p">(</span>
    <span class="n">target_mslist</span><span class="p">,</span>
    <span class="n">workdir</span><span class="p">,</span>
    <span class="n">caldir</span><span class="p">,</span>
    <span class="n">overwrite_datacolumn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">applymode</span><span class="o">=</span><span class="s2">&quot;calflag&quot;</span><span class="p">,</span>
    <span class="n">jobid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">cpu_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">mem_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply self-calibration solutions on splited target scans</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    target_mslist: list</span>
<span class="sd">        Target measurement set list</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Working directory</span>
<span class="sd">    caldir : str</span>
<span class="sd">        Caltable directory</span>
<span class="sd">    use_only_bandpass : bool</span>
<span class="sd">        Use only bandpass solutions</span>
<span class="sd">    applymode : str, optional</span>
<span class="sd">        Applycal mode</span>
<span class="sd">    cpu_frac : float, optional</span>
<span class="sd">        CPU fraction to use</span>
<span class="sd">    mem_frac : float, optional</span>
<span class="sd">        Memory fraction to use</span>
<span class="sd">    overwrite_datacolumn : bool</span>
<span class="sd">        Overwrite data column or not</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message for applying calibration solutions and spliting target scans</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying self-calibration solutions on target scans .....&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">applycal_basename</span> <span class="o">=</span> <span class="s2">&quot;apply_selfcal&quot;</span>
        <span class="n">mslist</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_mslist</span><span class="p">)</span>
        <span class="n">applycal_cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;run_apply_selfcal </span><span class="si">{</span><span class="n">mslist</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot; --workdir &quot;</span>
            <span class="o">+</span> <span class="n">workdir</span>
            <span class="o">+</span> <span class="s2">&quot; --caldir &quot;</span>
            <span class="o">+</span> <span class="n">caldir</span>
            <span class="o">+</span> <span class="s2">&quot; --cpu_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --mem_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --applymode &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">applymode</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --jobid &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">overwrite_datacolumn</span><span class="p">:</span>
            <span class="n">applycal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --overwrite_datacolumn&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logfile</span> <span class="o">=</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs/&quot;</span> <span class="o">+</span> <span class="n">applycal_basename</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span>
        <span class="n">applycal_cmd</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; --logfile </span><span class="si">{</span><span class="n">logfile</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">batch_file</span> <span class="o">=</span> <span class="n">create_batch_script_nonhpc</span><span class="p">(</span>
            <span class="n">applycal_cmd</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">applycal_basename</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">applycal_cmd</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;bash &quot;</span> <span class="o">+</span> <span class="n">batch_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting to finish applycal...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">finished_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/.Finished_&quot;</span> <span class="o">+</span> <span class="n">applycal_basename</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">success_index_cal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">finished_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">success_index_cal</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying self-calibration is done successfully.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying self-calibration is unsuccessful.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">success_index_cal</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="run_selfcal_jobs">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.master_controller.run_selfcal_jobs">[docs]</a>
<span class="k">def</span> <span class="nf">run_selfcal_jobs</span><span class="p">(</span>
    <span class="n">mslist</span><span class="p">,</span>
    <span class="n">workdir</span><span class="p">,</span>
    <span class="n">caldir</span><span class="p">,</span>
    <span class="n">start_thresh</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
    <span class="n">stop_thresh</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">max_DR</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">min_iter</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">conv_frac</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="n">solint</span><span class="o">=</span><span class="s2">&quot;60s&quot;</span><span class="p">,</span>
    <span class="n">do_apcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">solar_selfcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">keep_backup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">uvrange</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">minuv</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;briggs&quot;</span><span class="p">,</span>
    <span class="n">robust</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">applymode</span><span class="o">=</span><span class="s2">&quot;calonly&quot;</span><span class="p">,</span>
    <span class="n">min_tol_factor</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
    <span class="n">jobid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">cpu_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">mem_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Self-calibration on target scans</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mslist: list</span>
<span class="sd">        Target measurement set list</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Working directory</span>
<span class="sd">    caldir : str</span>
<span class="sd">        Caltable directory</span>
<span class="sd">    cpu_frac : float, optional</span>
<span class="sd">        CPU fraction to use</span>
<span class="sd">    mem_frac : float, optional</span>
<span class="sd">        Memory fraction to use</span>
<span class="sd">    start_threshold : int, optional</span>
<span class="sd">        Start CLEAN threhold</span>
<span class="sd">    end_threshold : int, optional</span>
<span class="sd">        End CLEAN threshold</span>
<span class="sd">    max_iter : int, optional</span>
<span class="sd">        Maximum numbers of selfcal iterations</span>
<span class="sd">    max_DR : float, optional</span>
<span class="sd">        Maximum dynamic range</span>
<span class="sd">    min_iter : int, optional</span>
<span class="sd">        Minimum numbers of seflcal iterations at different stages</span>
<span class="sd">    conv_frac : float, optional</span>
<span class="sd">        Dynamic range fractional change to consider as converged</span>
<span class="sd">    uvrange : str, optional</span>
<span class="sd">        UV-range for calibration</span>
<span class="sd">    minuv : float, optionial</span>
<span class="sd">        Minimum UV-lambda to use in imaging</span>
<span class="sd">    weight : str, optional</span>
<span class="sd">        Image weighitng scheme</span>
<span class="sd">    robust : float, optional</span>
<span class="sd">        Robustness parameter for briggs weighting</span>
<span class="sd">    solint : str, optional</span>
<span class="sd">        Solutions interval</span>
<span class="sd">    do_apcal : bool, optional</span>
<span class="sd">        Perform ap-selfcal or not</span>
<span class="sd">    min_tol_factor : float, optional</span>
<span class="sd">        Minimum tolerance in temporal variation in imaging</span>
<span class="sd">    applymode : str, optional</span>
<span class="sd">        Solution apply mode</span>
<span class="sd">    solar_selfcal : bool, optional</span>
<span class="sd">        Whether is is solar selfcal or not</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message for self-calibration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Performing self-calibration of target scans .....&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">selfcal_basename</span> <span class="o">=</span> <span class="s2">&quot;selfcal_targets&quot;</span>
        <span class="n">mslist</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mslist</span><span class="p">)</span>
        <span class="n">selfcal_cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;run_selfcal </span><span class="si">{</span><span class="n">mslist</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot; --workdir &quot;</span>
            <span class="o">+</span> <span class="n">workdir</span>
            <span class="o">+</span> <span class="s2">&quot; --caldir &quot;</span>
            <span class="o">+</span> <span class="n">caldir</span>
            <span class="o">+</span> <span class="s2">&quot; --cpu_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --mem_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --jobid &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">start_thresh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">selfcal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --start_thresh &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_thresh</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stop_thresh</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">stop_thresh</span> <span class="o">&lt;</span> <span class="n">start_thresh</span><span class="p">:</span>
                <span class="n">selfcal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --stop_thresh &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stop_thresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">selfcal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --max_iter &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_iter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_DR</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">selfcal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --max_DR &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_DR</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">min_iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">selfcal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --min_iter &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">min_iter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conv_frac</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">selfcal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --conv_frac &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">conv_frac</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">solint</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">selfcal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --solint &quot;</span> <span class="o">+</span> <span class="n">solint</span>
        <span class="k">if</span> <span class="n">uvrange</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">selfcal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --uvrange &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">uvrange</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">minuv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">selfcal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --minuv &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minuv</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">applymode</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">selfcal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --applymode &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">applymode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">min_tol_factor</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">selfcal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --min_tol_factor &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">min_tol_factor</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">weight</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">selfcal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --weight &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">robust</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">selfcal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --robust &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">robust</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_apcal</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">selfcal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --no_apcal&quot;</span>
        <span class="k">if</span> <span class="n">solar_selfcal</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">selfcal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --no_solar_selfcal&quot;</span>
        <span class="k">if</span> <span class="n">keep_backup</span><span class="p">:</span>
            <span class="n">selfcal_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --keep_backup&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">batch_file</span> <span class="o">=</span> <span class="n">create_batch_script_nonhpc</span><span class="p">(</span><span class="n">selfcal_cmd</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">selfcal_basename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">selfcal_cmd</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;bash &quot;</span> <span class="o">+</span> <span class="n">batch_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting to finish self-calibration...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">finished_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/.Finished_&quot;</span> <span class="o">+</span> <span class="n">selfcal_basename</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">success_index_cal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">finished_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">success_index_cal</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Self-calibration is done successfully.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Self-calibration is unsuccessful.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">success_index_cal</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="run_imaging_jobs">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.master_controller.run_imaging_jobs">[docs]</a>
<span class="k">def</span> <span class="nf">run_imaging_jobs</span><span class="p">(</span>
    <span class="n">mslist</span><span class="p">,</span>
    <span class="n">workdir</span><span class="p">,</span>
    <span class="n">outdir</span><span class="p">,</span>
    <span class="n">freqrange</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">timerange</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">minuv</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;briggs&quot;</span><span class="p">,</span>
    <span class="n">robust</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">pol</span><span class="o">=</span><span class="s2">&quot;IQUV&quot;</span><span class="p">,</span>
    <span class="n">freqres</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">timeres</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">band</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">use_multiscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">use_solar_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cutout_rsun</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
    <span class="n">make_overlay</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">savemodel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">saveres</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">jobid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">cpu_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">mem_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Self-calibration on target scans</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mslist: list</span>
<span class="sd">        Target measurement set list</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Working directory</span>
<span class="sd">    outdir : str</span>
<span class="sd">        Output image directory</span>
<span class="sd">    freqrange : str, optional</span>
<span class="sd">        Frequency range to image in MHz</span>
<span class="sd">    timerange : str, optional</span>
<span class="sd">        Time range to image (YYYY/MM/DD/hh:mm:ss~YYYY/MM/DD/hh:mm:ss)</span>
<span class="sd">    cpu_frac : float, optional</span>
<span class="sd">        CPU fraction to use</span>
<span class="sd">    mem_frac : float, optional</span>
<span class="sd">        Memory fraction to use</span>
<span class="sd">    minuv : float, optionial</span>
<span class="sd">        Minimum UV-lambda to use in imaging</span>
<span class="sd">    weight : str, optional</span>
<span class="sd">        Imaging weighting</span>
<span class="sd">    robust : float, optional</span>
<span class="sd">        Briggs weighting robust parameter (-1 to 1)</span>
<span class="sd">    pol : str, optional</span>
<span class="sd">        Stokes parameters to image</span>
<span class="sd">    freqres : float, optional</span>
<span class="sd">        Frequency resolution of spectral chunk in MHz (default : -1, no spectral chunking)</span>
<span class="sd">    timeres : float, optional</span>
<span class="sd">        Time resolution of temporal chunks in MHz (default : -1, no temporal chunking)</span>
<span class="sd">    band : str, optional</span>
<span class="sd">        Band name</span>
<span class="sd">    threshold : float, optional</span>
<span class="sd">        CLEAN threshold</span>
<span class="sd">    use_multiscale : bool, optional</span>
<span class="sd">        Use multiscale or not</span>
<span class="sd">    use_solar_mask : bool, optional</span>
<span class="sd">        Use solar mask or not</span>
<span class="sd">    cutout_rsun : float, optional</span>
<span class="sd">        Cutout image size from center in solar radii (default : 2.5 solar radii)</span>
<span class="sd">    make_overlay : bool, optional</span>
<span class="sd">        Make SUVI MeerKAT overlay</span>
<span class="sd">    savemodel : bool, optional</span>
<span class="sd">        Save model images or not</span>
<span class="sd">    saveres : bool, optional</span>
<span class="sd">        Save residual images or not</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message for imaging</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Performing imaging of target scans .....&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">imaging_basename</span> <span class="o">=</span> <span class="s2">&quot;imaging_targets&quot;</span>
        <span class="n">mslist</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mslist</span><span class="p">)</span>
        <span class="n">imaging_cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;run_imaging </span><span class="si">{</span><span class="n">mslist</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot; --workdir &quot;</span>
            <span class="o">+</span> <span class="n">workdir</span>
            <span class="o">+</span> <span class="s2">&quot; --outdir &quot;</span>
            <span class="o">+</span> <span class="n">outdir</span>
            <span class="o">+</span> <span class="s2">&quot; --cpu_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --mem_frac &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --pol &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pol</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --freqres &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">freqres</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --timeres &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeres</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --weight &quot;</span>
            <span class="o">+</span> <span class="n">weight</span>
            <span class="o">+</span> <span class="s2">&quot; --robust &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">robust</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --minuv_l &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minuv</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --threshold &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --cutout_rsun &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cutout_rsun</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; --jobid &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">use_solar_mask</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">imaging_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --no_solar_mask&quot;</span>
        <span class="k">if</span> <span class="n">savemodel</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">imaging_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --no_savemodel&quot;</span>
        <span class="k">if</span> <span class="n">saveres</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">imaging_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --no_saveres&quot;</span>
        <span class="k">if</span> <span class="n">use_multiscale</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">imaging_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --no_multiscale&quot;</span>
        <span class="k">if</span> <span class="n">make_overlay</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">imaging_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --no_make_overlay&quot;</span>
        <span class="k">if</span> <span class="n">freqrange</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">imaging_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --freqrange &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">freqrange</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timerange</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">imaging_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --timerange &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timerange</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">band</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">imaging_cmd</span> <span class="o">+=</span> <span class="s2">&quot; --band &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">batch_file</span> <span class="o">=</span> <span class="n">create_batch_script_nonhpc</span><span class="p">(</span><span class="n">imaging_cmd</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">imaging_basename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">imaging_cmd</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;bash &quot;</span> <span class="o">+</span> <span class="n">batch_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting to finish imaging...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">finished_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/.Finished_&quot;</span> <span class="o">+</span> <span class="n">imaging_basename</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">success_index_cal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">finished_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">success_index_cal</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Imaging is done successfully.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Imaging is unsuccessful.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">success_index_cal</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="run_ds_jobs">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.master_controller.run_ds_jobs">[docs]</a>
<span class="k">def</span> <span class="nf">run_ds_jobs</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">target_scans</span><span class="o">=</span><span class="p">[],</span> <span class="n">jobid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cpu_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">mem_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make dynamic spectra of the target scans</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Name of the work directory</span>
<span class="sd">    outdir : str</span>
<span class="sd">        Output directory</span>
<span class="sd">    target_scans : list, optional</span>
<span class="sd">        Target scans</span>
<span class="sd">    cpu_frac : float, optional</span>
<span class="sd">        CPU fraction to use</span>
<span class="sd">    mem_frac : float, optional</span>
<span class="sd">        Memory fraction to use</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Making dynamic spectra of target scans .....&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ds_basename</span> <span class="o">=</span> <span class="s2">&quot;ds_targets&quot;</span>
        <span class="n">target_scans</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">target_scans</span><span class="p">])</span>
        <span class="n">ds_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;run_makeds </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="s2"> --workdir </span><span class="si">{</span><span class="n">workdir</span><span class="si">}</span><span class="s2"> --outdir </span><span class="si">{</span><span class="n">outdir</span><span class="si">}</span><span class="s2"> --cpu_frac </span><span class="si">{</span><span class="n">cpu_frac</span><span class="si">}</span><span class="s2"> --mem_frac </span><span class="si">{</span><span class="n">mem_frac</span><span class="si">}</span><span class="s2"> --jobid </span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2"> --target_scans </span><span class="si">{</span><span class="n">target_scans</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logfile</span> <span class="o">=</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs/&quot;</span> <span class="o">+</span> <span class="n">ds_basename</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span>
        <span class="n">ds_cmd</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; --logfile </span><span class="si">{</span><span class="n">logfile</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">batch_file</span> <span class="o">=</span> <span class="n">create_batch_script_nonhpc</span><span class="p">(</span><span class="n">ds_cmd</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">ds_basename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ds_cmd</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;bash &quot;</span> <span class="o">+</span> <span class="n">batch_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting to finish making of dynamic spectra...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">finished_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/.Finished_&quot;</span> <span class="o">+</span> <span class="n">ds_basename</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">success_index_cal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">finished_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">success_index_cal</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dynamic spectra are successfully made.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dynamic spectra are not made successfully.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">success_index_cal</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="check_status">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.master_controller.check_status">[docs]</a>
<span class="k">def</span> <span class="nf">check_status</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">basename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check job status</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Work directory</span>
<span class="sd">    basename : str</span>
<span class="sd">        Basename</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        Finished or not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">finished_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/.Finished_&quot;</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">success_index_split_target</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">finished_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">success_index_split_target</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="start_ping_logger">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.master_controller.start_ping_logger">[docs]</a>
<span class="k">def</span> <span class="nf">start_ping_logger</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="n">remote_jobid</span><span class="p">,</span> <span class="n">waittime</span><span class="p">,</span> <span class="n">remote_link</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run ping remote logger in background</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    jobid : int</span>
<span class="sd">        Job ID</span>
<span class="sd">    remote_jobid : str</span>
<span class="sd">        Remote log job ID</span>
<span class="sd">    waittime : float</span>
<span class="sd">        Wait time before process ends in hour</span>
<span class="sd">    remote_link : str, optional</span>
<span class="sd">        Remote logger link</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        PID of the background job</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">remote_link</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">waittime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">stop_event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">ping_logger</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="n">remote_jobid</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">,</span> <span class="n">remote_link</span><span class="p">),</span>
            <span class="n">daemon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">stop_after_delay</span><span class="p">():</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">waittime</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>
            <span class="n">stop_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>

        <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">stop_after_delay</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span></div>



<div class="viewcode-block" id="exit_job">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.master_controller.exit_job">[docs]</a>
<span class="k">def</span> <span class="nf">exit_job</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">mspath</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total time taken: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">s.&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">mspath</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mspath</span> <span class="o">+</span> <span class="s2">&quot;/dask-scratch-space&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">mspath</span> <span class="o">+</span> <span class="s2">&quot;/dask-scratch-space &quot;</span> <span class="o">+</span> <span class="n">mspath</span> <span class="o">+</span> <span class="s2">&quot;/tmp&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">workdir</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/dask-scratch-space&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/dask-scratch-space &quot;</span> <span class="o">+</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/tmp&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="master_control">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.master_controller.master_control">[docs]</a>
<span class="k">def</span> <span class="nf">master_control</span><span class="p">(</span>
    <span class="n">msname</span><span class="p">,</span>
    <span class="n">workdir</span><span class="p">,</span>
    <span class="n">outdir</span><span class="p">,</span>
    <span class="n">solar_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># Pre-calibration</span>
    <span class="n">do_forcereset_weightflag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">do_cal_partition</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">do_cal_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">do_import_model</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># Basic calibration</span>
    <span class="n">do_basic_cal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">do_noise_cal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">do_applycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># Target data preparation</span>
    <span class="n">do_target_split</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">target_scans</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">freqrange</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">timerange</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">uvrange</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="c1"># Polarization calibration</span>
    <span class="n">do_polcal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="c1"># Self-calibration</span>
    <span class="n">do_selfcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">do_selfcal_split</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">do_apply_selfcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">do_ap_selfcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">solar_selfcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">solint</span><span class="o">=</span><span class="s2">&quot;5min&quot;</span><span class="p">,</span>
    <span class="c1"># Sidereal correction</span>
    <span class="n">do_sidereal_cor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="c1"># Dynamic spectra</span>
    <span class="n">make_ds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># Imaging</span>
    <span class="n">do_imaging</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">do_pbcor</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;briggs&quot;</span><span class="p">,</span>
    <span class="n">robust</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">minuv</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">image_freqres</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">image_timeres</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">pol</span><span class="o">=</span><span class="s2">&quot;IQUV&quot;</span><span class="p">,</span>
    <span class="n">apply_parang</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">clean_threshold</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">use_multiscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">use_solar_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cutout_rsun</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
    <span class="n">make_overlay</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># Resource settings</span>
    <span class="n">cpu_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">mem_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">n_nodes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">keep_backup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="c1"># Remote logging</span>
    <span class="n">remote_logger</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">remote_logger_waittime</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Master controller of the entire pipeline</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Measurement set name</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Work directory path</span>
<span class="sd">    outdir : str</span>
<span class="sd">        Output directory</span>
<span class="sd">    solar_data : bool, optional</span>
<span class="sd">        Whether it is solar data or not</span>

<span class="sd">    do_forcereset_weightflag : bool, optional</span>
<span class="sd">        Reset weights and flags of the input ms</span>
<span class="sd">    do_cal_partition : bool, optional</span>
<span class="sd">        Make calibrator multi-MS</span>
<span class="sd">    do_cal_flag : bool, optional</span>
<span class="sd">        Perform flagging on calibrator</span>
<span class="sd">    do_import_model : bool, optional</span>
<span class="sd">        Import model visibilities of flux and polarization calibrators</span>

<span class="sd">    do_basic_cal : bool, optional</span>
<span class="sd">        Perform basic calibration</span>
<span class="sd">    do_noise_cal : bool, optional</span>
<span class="sd">        Peform calibration of solar attenuators using noise diode (only used if solar_data=True)</span>
<span class="sd">    do_applycal : bool, optional</span>
<span class="sd">        Apply basic calibration on target scans</span>

<span class="sd">    do_target_split : bool, optional</span>
<span class="sd">        Split target scans into chunks</span>
<span class="sd">    target_scans : list, optional</span>
<span class="sd">        Target scans to self-cal and image</span>
<span class="sd">    freqrange : str, optional</span>
<span class="sd">        Frequency range to image in MHz (xx1~xx2,xx3~xx4,)</span>
<span class="sd">    timerange : str, optional</span>
<span class="sd">        Time range to image in YYYY/MM/DD/hh:mm:ss format (tt1~tt2,tt3~tt4,...)</span>
<span class="sd">    uvrange : str, optional</span>
<span class="sd">        UV-range for calibration</span>

<span class="sd">    do_polcal : bool, optional</span>
<span class="sd">        Perform full-polarization calibration and imaging</span>

<span class="sd">    do_selfcal : bool, optional</span>
<span class="sd">        Perform self-calibration</span>
<span class="sd">    do_selfcal_split : bool, optional</span>
<span class="sd">        Split data after each round of self-calibration</span>
<span class="sd">    do_apply_selfcal : bool, optional</span>
<span class="sd">        Apply self-calibration solutions</span>
<span class="sd">    do_ap_selfcal : bool, optional</span>
<span class="sd">        Perform amplitude-phase self-cal or not</span>
<span class="sd">    solar_selfcal : bool, optional</span>
<span class="sd">        Whether self-calibration is performing on solar observation or not</span>
<span class="sd">    solint : str, optional</span>
<span class="sd">        Solution intervals in self-cal</span>

<span class="sd">    do_sidereal_cor : bool, optional</span>
<span class="sd">        Perform solar sidereal motion correction or not</span>

<span class="sd">    make_ds : bool, optional</span>
<span class="sd">        Make dynamic spectra</span>

<span class="sd">    do_imaging : bool, optional</span>
<span class="sd">        Perform final imaging</span>
<span class="sd">    do_pbcor : bool, optional</span>
<span class="sd">        Perform primary beam correction</span>
<span class="sd">    weight : str, optional</span>
<span class="sd">        Image weighting</span>
<span class="sd">    robust : float, optional</span>
<span class="sd">        Robust parameter for briggs weighting (-1 to 1)</span>
<span class="sd">    minuv : float, optional</span>
<span class="sd">        Minimum UV-lambda for final imaging</span>
<span class="sd">    image_freqres : float, optional</span>
<span class="sd">        Image frequency resolution in MHz (-1 means full bandwidth)</span>
<span class="sd">    image_timeres : float, optional</span>
<span class="sd">        Image temporal resolution in seconds (-1 means full scan duration)</span>
<span class="sd">    pol : str, optional</span>
<span class="sd">        Stokes parameters of final imaging</span>
<span class="sd">    apply_parang : bool, optional</span>
<span class="sd">        Apply parallactic angle correction</span>
<span class="sd">    clean_threshold : float, optional</span>
<span class="sd">        CLEAN threshold of final imaging</span>
<span class="sd">    use_multiscale : bool, optional</span>
<span class="sd">        Use multiscale scales or not</span>
<span class="sd">    use_solar_mask : bool, optional</span>
<span class="sd">        Use solar mask</span>
<span class="sd">    cutout_rsun : float, optional</span>
<span class="sd">        Cutout image size from center in solar radii (default : 2.5 solar radii)</span>
<span class="sd">    make_overlay : bool, optional</span>
<span class="sd">        Make SUVI MeerKAT overlay</span>

<span class="sd">    cpu_frac : float, optional</span>
<span class="sd">        CPU fraction to use</span>
<span class="sd">    mem_frac : float, optional</span>
<span class="sd">        Memory fraction to use</span>
<span class="sd">    n_nodes: int, optional</span>
<span class="sd">        Number of nodes to use (Only for cluster architecture)</span>
<span class="sd">    keep_backup : bool, optional</span>
<span class="sd">        Keep backup of self-cal rounds and final models and residual images</span>

<span class="sd">    remote_logger : bool, optional</span>
<span class="sd">        Enable remote logging of the pipeline status</span>
<span class="sd">    remote_logger_waittime : int, optional</span>
<span class="sd">        Wait time (in seconds) before connecting to remote logger</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">meersolar.pipeline.init_data</span> <span class="kn">import</span> <span class="n">init_meersolar_data</span>
    <span class="n">init_meersolar_data</span><span class="p">()</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide a valid measurement set location.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">exit_job</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">mspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="c1">###################################</span>
    <span class="c1"># Preparing working directories</span>
    <span class="c1">###################################</span>
    <span class="k">if</span> <span class="n">workdir</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;/workdir&quot;</span>
    <span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outdir</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">outdir</span><span class="o">=</span><span class="n">workdir</span>
    <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">caldir</span><span class="o">=</span><span class="n">outdir</span><span class="o">+</span><span class="s2">&quot;/caltables&quot;</span>  
    <span class="n">caldir</span><span class="o">=</span><span class="n">caldir</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>  
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">caldir</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mspath</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mspath</span> <span class="o">+</span> <span class="s2">&quot;/dask-scratch-space&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">mspath</span> <span class="o">+</span> <span class="s2">&quot;/dask-scratch-space &quot;</span> <span class="o">+</span> <span class="n">mspath</span> <span class="o">+</span> <span class="s2">&quot;/tmp&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">workdir</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/dask-scratch-space&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/dask-scratch-space &quot;</span> <span class="o">+</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/tmp&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1">####################################</span>
        <span class="c1"># Job and process IDs</span>
        <span class="c1">####################################</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="n">jobid</span> <span class="o">=</span> <span class="n">get_jobid</span><span class="p">()</span>
        <span class="n">main_job_file</span> <span class="o">=</span> <span class="n">save_main_process_info</span><span class="p">(</span>
            <span class="n">pid</span><span class="p">,</span>
            <span class="n">jobid</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">msname</span><span class="p">),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">workdir</span><span class="p">),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">outdir</span><span class="p">),</span>
            <span class="n">cpu_frac</span><span class="p">,</span>
            <span class="n">mem_frac</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MeerSOLAR Job ID: </span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Work directory: </span><span class="si">{</span><span class="n">workdir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final product directory: </span><span class="si">{</span><span class="n">outdir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###########################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1">#####################################</span>
        <span class="c1"># Moving into work directory</span>
        <span class="c1">#####################################</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
        <span class="n">cpu_frac_bkp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">)</span>
        <span class="n">mem_frac_bkp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remote_logger</span><span class="p">:</span>
            <span class="n">remote_link</span> <span class="o">=</span> <span class="n">get_remote_logger_link</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">remote_link</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide a valid remote link.&quot;</span><span class="p">)</span>
                <span class="n">remote_logger</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">remote_logger</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">emails</span> <span class="o">=</span> <span class="n">get_emails</span><span class="p">()</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">emails</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">email_subject</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MeerSOLAR Logger Details: </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">email_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;MeerSOLAR user,</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;MeerSOLAR Job ID: </span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Best,</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;MeerSOLAR&quot;</span>
                <span class="p">)</span>
                <span class="kn">from</span> <span class="nn">meersolar.data.sendmail</span> <span class="kn">import</span> <span class="n">send_paircars_notification</span> <span class="k">as</span> <span class="n">send_notification</span>
                <span class="n">success_msg</span><span class="p">,</span> <span class="n">error_msg</span> <span class="o">=</span> <span class="n">send_notification</span><span class="p">(</span><span class="n">emails</span><span class="p">,</span> <span class="n">email_subject</span><span class="p">,</span> <span class="n">email_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">####################################</span>
            <span class="c1"># Job name and logging password</span>
            <span class="c1">####################################</span>
            <span class="n">hostname</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">job_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hostname</span><span class="si">}</span><span class="s2"> :: </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2"> :: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.ms&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">timestamp1</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">T%H%M%S&quot;</span><span class="p">)</span>
            <span class="n">remote_job_id</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hostname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp1</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.ms&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">generate_password</span><span class="p">()</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workdir</span><span class="si">}</span><span class="s2">/jobname_password.npy&quot;</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">job_name</span><span class="p">,</span> <span class="n">password</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;############################################################################&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">remote_link</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job ID: </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remote access password: </span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;#############################################################################&quot;</span>
            <span class="p">)</span>
            <span class="n">emails</span> <span class="o">=</span> <span class="n">get_emails</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">emails</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">email_subject</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;MeerSOLAR Logger Details: </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">email_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;MeerSOLAR user,</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;MeerSOLAR Job ID: </span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Remote logger Job ID: </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Remote access password: </span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Best,</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;MeerSOLAR&quot;</span>
                <span class="p">)</span>
                <span class="kn">from</span> <span class="nn">meersolar.data.sendmail</span> <span class="kn">import</span> <span class="n">send_paircars_notification</span> <span class="k">as</span> <span class="n">send_notification</span>
                <span class="n">success_msg</span><span class="p">,</span> <span class="n">error_msg</span> <span class="o">=</span> <span class="n">send_notification</span><span class="p">(</span><span class="n">emails</span><span class="p">,</span> <span class="n">email_subject</span><span class="p">,</span> <span class="n">email_msg</span><span class="p">)</span>

        <span class="c1">#####################################</span>
        <span class="c1"># Settings for solar data</span>
        <span class="c1">#####################################</span>
        <span class="k">if</span> <span class="n">solar_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_solar_mask</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Use solar mask during CLEANing.&quot;</span><span class="p">)</span>
                <span class="n">use_solar_mask</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">solar_selfcal</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">solar_selfcal</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">full_FoV</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">do_noise_cal</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Turning off noise diode based calibration for non-solar observation.&quot;</span>
                <span class="p">)</span>
                <span class="n">do_noise_cal</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">use_solar_mask</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stop using solar mask during CLEANing.&quot;</span><span class="p">)</span>
                <span class="n">use_solar_mask</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">solar_selfcal</span><span class="p">:</span>
                <span class="n">solar_selfcal</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">full_FoV</span><span class="o">=</span><span class="kc">True</span>

        <span class="c1">###################################################</span>
        <span class="c1"># Target spliting spectral and temporal chunks</span>
        <span class="c1">##################################################</span>
        <span class="k">if</span> <span class="n">image_timeres</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">3660</span><span class="p">):</span>  <span class="c1"># If more than 2 hours</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Image time integration is more than 2 hours, which may cause smearing due to solar differential rotation.&quot;</span>
            <span class="p">)</span>

        <span class="c1">#################################################</span>
        <span class="c1"># Determining maximum allowed frequency averaging</span>
        <span class="c1">#################################################</span>
        <span class="n">max_freqres</span> <span class="o">=</span> <span class="n">calc_bw_smearing_freqwidth</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span><span class="n">full_FoV</span><span class="o">=</span><span class="n">full_FoV</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">image_freqres</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">freqavg</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">image_freqres</span><span class="p">,</span> <span class="n">max_freqres</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">freqavg</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">max_freqres</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1">################################################</span>
        <span class="c1"># Determining maximum allowed temporal averaging</span>
        <span class="c1">################################################</span>
        <span class="k">if</span> <span class="n">solar_data</span><span class="p">:</span> <span class="c1"># For solar data, it is assumed Sun is tracked. </span>
            <span class="n">max_timeres</span> <span class="o">=</span> <span class="n">calc_time_smearing_timewidth</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_timeres</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="n">calc_time_smearing_timewidth</span><span class="p">(</span><span class="n">msname</span><span class="p">),</span> <span class="n">max_time_solar_smearing</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">image_timeres</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">timeavg</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">image_timeres</span><span class="p">,</span> <span class="n">max_timeres</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timeavg</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">max_timeres</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1">#########################################</span>
        <span class="c1"># Target ms frequency chunk based on band</span>
        <span class="c1">#########################################</span>
        <span class="n">bad_spws</span> <span class="o">=</span> <span class="n">get_bad_chans</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;0:&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="n">good_start</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">good_end</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bad_spws</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">start_chan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bad_spws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">end_chan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bad_spws</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">good_start</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_chan</span><span class="p">)</span>
            <span class="n">good_end</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end_chan</span><span class="p">)</span>
        <span class="n">start_chan</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">good_start</span><span class="p">)</span>
        <span class="n">end_chan</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">good_end</span><span class="p">)</span>
        <span class="n">spw</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;0:</span><span class="si">{</span><span class="n">start_chan</span><span class="si">}</span><span class="s2">~</span><span class="si">{</span><span class="n">end_chan</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1">#############################################################</span>
        <span class="c1"># Determining numbers of spectral chunks for parallel imaging</span>
        <span class="c1">#############################################################</span>
        <span class="k">if</span> <span class="n">image_freqres</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">target_freq_chunk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">nchunk</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
            <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
            <span class="n">chanres</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanres</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;MHz&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">total_bw</span> <span class="o">=</span> <span class="n">chanres</span> <span class="o">*</span> <span class="p">(</span><span class="n">end_chan</span> <span class="o">-</span> <span class="n">start_chan</span><span class="p">)</span>
            <span class="n">nchunk</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">total_bw</span><span class="o">/</span><span class="n">image_freqres</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nchunk</span><span class="o">&gt;</span><span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">n_nodes</span><span class="p">):</span> <span class="c1"># Maximum 4 chunking or number of compute nodes</span>
                <span class="n">nchunk</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">n_nodes</span><span class="p">)</span>
                <span class="n">target_freq_chunk</span><span class="o">=</span><span class="n">total_bw</span><span class="o">/</span><span class="n">nchunk</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nchnuk</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">target_freq_chunk</span><span class="o">=</span><span class="n">image_freqres</span>
        
        <span class="c1">#############################</span>
        <span class="c1"># Reset any previous weights</span>
        <span class="c1">############################</span>
        <span class="n">cpu_usage</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Average over 1 second</span>
        <span class="n">total_cpus</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(</span><span class="n">logical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">available_cpus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_cpus</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cpu_usage</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">))</span>
        <span class="n">available_cpus</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">available_cpus</span><span class="p">)</span>  <span class="c1"># Avoid zero workers</span>
        <span class="n">reset_weights_and_flags</span><span class="p">(</span>
            <span class="n">msname</span><span class="p">,</span> <span class="n">n_threads</span><span class="o">=</span><span class="n">available_cpus</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="n">do_forcereset_weightflag</span>
        <span class="p">)</span>

        <span class="c1">#######################################</span>
        <span class="c1"># Run dynamic spectra making</span>
        <span class="c1">#######################################</span>
        <span class="k">if</span> <span class="n">make_ds</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">run_ds_jobs</span><span class="p">(</span>
                <span class="n">msname</span><span class="p">,</span>
                <span class="n">workdir</span><span class="p">,</span>
                <span class="n">outdir</span><span class="p">,</span>
                <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span>
                <span class="n">target_scans</span><span class="o">=</span><span class="n">target_scans</span><span class="p">,</span>
                <span class="n">cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;!!!! WARNING: Dynamic spectra could not be made. !!!!&quot;</span><span class="p">)</span>

        <span class="c1">########################################</span>
        <span class="c1"># Run noise-diode based flux calibration</span>
        <span class="c1">########################################</span>
        <span class="k">if</span> <span class="n">do_noise_cal</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">run_noise_diode_cal</span><span class="p">(</span>
                <span class="n">msname</span><span class="p">,</span>
                <span class="n">workdir</span><span class="p">,</span>
                <span class="n">caldir</span><span class="p">,</span>
                <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span>
                <span class="n">keep_backup</span><span class="o">=</span><span class="n">keep_backup</span><span class="p">,</span>
                <span class="n">cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>  <span class="c1"># Run noise diode based flux calibration</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;!!!! WARNING: Error in running noise-diode based flux calibration. Flux density calibration may not be correct. !!!!&quot;</span>
                <span class="p">)</span>

        <span class="c1">##############################</span>
        <span class="c1"># Run partitioning jobs</span>
        <span class="c1">##############################</span>
        <span class="c1"># If do partition or calibrator ms is not present in case of basic calibration is requested</span>
        <span class="n">calibrator_msname</span> <span class="o">=</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/calibrator.ms&quot;</span>
        <span class="k">if</span> <span class="n">do_basic_cal</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">do_cal_partition</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">calibrator_msname</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span>
        <span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">run_partion</span><span class="p">(</span>
                <span class="n">msname</span><span class="p">,</span>
                <span class="n">workdir</span><span class="p">,</span>
                <span class="n">split_fullpol</span><span class="o">=</span><span class="n">do_polcal</span><span class="p">,</span>
                <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span>
                <span class="n">cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;!!!! WARNING: Error in partitioning calibrator fields. !!!!&quot;</span><span class="p">)</span>
                <span class="n">exit_job</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">mspath</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remote_logger</span><span class="p">:</span>
                    <span class="n">pid</span> <span class="o">=</span> <span class="n">start_ping_logger</span><span class="p">(</span>
                        <span class="n">jobid</span><span class="p">,</span>
                        <span class="n">remote_job_id</span><span class="p">,</span>
                        <span class="n">remote_logger_waittime</span><span class="p">,</span>
                        <span class="n">remote_link</span><span class="o">=</span><span class="n">remote_link</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">meersolar_cachedir</span> <span class="o">=</span> <span class="n">get_meersolar_cachedir</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">save_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">meersolar_cachedir</span><span class="si">}</span><span class="s2">/pids/pids_</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">1</span>

        <span class="c1">##################################</span>
        <span class="c1"># Run flagging jobs on calibrators</span>
        <span class="c1">##################################</span>
        <span class="c1"># Only if basic calibration is requested</span>
        <span class="k">if</span> <span class="n">do_cal_flag</span> <span class="ow">and</span> <span class="n">do_basic_cal</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">calibrator_msname</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calibrator ms: </span><span class="si">{</span><span class="n">calibrator_ms</span><span class="si">}</span><span class="s2"> is not present.&quot;</span><span class="p">)</span>
                <span class="n">exit_job</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">mspath</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remote_logger</span><span class="p">:</span>
                    <span class="n">pid</span> <span class="o">=</span> <span class="n">start_ping_logger</span><span class="p">(</span>
                        <span class="n">jobid</span><span class="p">,</span>
                        <span class="n">remote_job_id</span><span class="p">,</span>
                        <span class="n">remote_logger_waittime</span><span class="p">,</span>
                        <span class="n">remote_link</span><span class="o">=</span><span class="n">remote_link</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">meersolar_cachedir</span> <span class="o">=</span> <span class="n">get_meersolar_cachedir</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">save_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">meersolar_cachedir</span><span class="si">}</span><span class="s2">/pids/pids_</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">run_flag</span><span class="p">(</span>
                <span class="n">calibrator_msname</span><span class="p">,</span>
                <span class="n">workdir</span><span class="p">,</span>
                <span class="n">flag_calibrators</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span>
                <span class="n">cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;!!!! WARNING: Flagging error. Examine calibration solutions with caution. !!!!&quot;</span>
                <span class="p">)</span>

        <span class="c1">#################################</span>
        <span class="c1"># Import model</span>
        <span class="c1">#################################</span>
        <span class="c1"># Only if basic calibration is requested</span>
        <span class="k">if</span> <span class="n">do_import_model</span> <span class="ow">and</span> <span class="n">do_basic_cal</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">calibrator_msname</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calibrator ms: </span><span class="si">{</span><span class="n">calibrator_ms</span><span class="si">}</span><span class="s2"> is not present.&quot;</span><span class="p">)</span>
                <span class="n">exit_job</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">mspath</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remote_logger</span><span class="p">:</span>
                    <span class="n">pid</span> <span class="o">=</span> <span class="n">start_ping_logger</span><span class="p">(</span>
                        <span class="n">jobid</span><span class="p">,</span>
                        <span class="n">remote_job_id</span><span class="p">,</span>
                        <span class="n">remote_logger_waittime</span><span class="p">,</span>
                        <span class="n">remote_link</span><span class="o">=</span><span class="n">remote_link</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">meersolar_cachedir</span> <span class="o">=</span> <span class="n">get_meersolar_cachedir</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">save_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">meersolar_cachedir</span><span class="si">}</span><span class="s2">/pids/pids_</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="n">fluxcal_fields</span><span class="p">,</span> <span class="n">fluxcal_scans</span> <span class="o">=</span> <span class="n">get_fluxcals</span><span class="p">(</span><span class="n">calibrator_msname</span><span class="p">)</span>
            <span class="n">phasecal_fields</span><span class="p">,</span> <span class="n">phasecal_scans</span><span class="p">,</span> <span class="n">phasecal_fluxes</span> <span class="o">=</span> <span class="n">get_phasecals</span><span class="p">(</span>
                <span class="n">calibrator_msname</span>
            <span class="p">)</span>
            <span class="n">calibrator_field</span> <span class="o">=</span> <span class="n">fluxcal_fields</span> <span class="o">+</span> <span class="n">phasecal_fields</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">run_import_model</span><span class="p">(</span>
                <span class="n">calibrator_msname</span><span class="p">,</span>
                <span class="n">workdir</span><span class="p">,</span>
                <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span>
                <span class="n">cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>  <span class="c1"># Run model import</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;!!!! WARNING: Error in importing calibrator models. Not continuing calibration. !!!!&quot;</span>
                <span class="p">)</span>
                <span class="n">exit_job</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">mspath</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remote_logger</span><span class="p">:</span>
                    <span class="n">pid</span> <span class="o">=</span> <span class="n">start_ping_logger</span><span class="p">(</span>
                        <span class="n">jobid</span><span class="p">,</span>
                        <span class="n">remote_job_id</span><span class="p">,</span>
                        <span class="n">remote_logger_waittime</span><span class="p">,</span>
                        <span class="n">remote_link</span><span class="o">=</span><span class="n">remote_link</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">meersolar_cachedir</span> <span class="o">=</span> <span class="n">get_meersolar_cachedir</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">save_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">meersolar_cachedir</span><span class="si">}</span><span class="s2">/pids/pids_</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">1</span>

        <span class="c1">###############################</span>
        <span class="c1"># Run basic calibration</span>
        <span class="c1">###############################</span>
        <span class="n">use_only_bandpass</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">do_basic_cal</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">calibrator_msname</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calibrator ms: </span><span class="si">{</span><span class="n">calibrator_ms</span><span class="si">}</span><span class="s2"> is not present.&quot;</span><span class="p">)</span>
                <span class="n">exit_job</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">mspath</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remote_logger</span><span class="p">:</span>
                    <span class="n">pid</span> <span class="o">=</span> <span class="n">start_ping_logger</span><span class="p">(</span>
                        <span class="n">jobid</span><span class="p">,</span>
                        <span class="n">remote_job_id</span><span class="p">,</span>
                        <span class="n">remote_logger_waittime</span><span class="p">,</span>
                        <span class="n">remote_link</span><span class="o">=</span><span class="n">remote_link</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">meersolar_cachedir</span> <span class="o">=</span> <span class="n">get_meersolar_cachedir</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">save_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">meersolar_cachedir</span><span class="si">}</span><span class="s2">/pids/pids_</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">run_basic_cal_jobs</span><span class="p">(</span>
                <span class="n">calibrator_msname</span><span class="p">,</span>
                <span class="n">workdir</span><span class="p">,</span>
                <span class="n">caldir</span><span class="p">,</span>
                <span class="n">perform_polcal</span><span class="o">=</span><span class="n">do_polcal</span><span class="p">,</span>
                <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span>
                <span class="n">cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">keep_backup</span><span class="o">=</span><span class="n">keep_backup</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># Run basic calibration</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;!!!! WARNING: Error in basic calibration. Not continuing further. !!!!&quot;</span>
                <span class="p">)</span>
                <span class="n">exit_job</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">mspath</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remote_logger</span><span class="p">:</span>
                    <span class="n">pid</span> <span class="o">=</span> <span class="n">start_ping_logger</span><span class="p">(</span>
                        <span class="n">jobid</span><span class="p">,</span>
                        <span class="n">remote_job_id</span><span class="p">,</span>
                        <span class="n">remote_logger_waittime</span><span class="p">,</span>
                        <span class="n">remote_link</span><span class="o">=</span><span class="n">remote_link</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">meersolar_cachedir</span> <span class="o">=</span> <span class="n">get_meersolar_cachedir</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">save_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">meersolar_cachedir</span><span class="si">}</span><span class="s2">/pids/pids_</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">1</span>

        <span class="c1">##########################################</span>
        <span class="c1"># Checking presence of necessary caltables</span>
        <span class="c1">##########################################</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">caldir</span> <span class="o">+</span> <span class="s2">&quot;/*.bcal&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No bandpass table is present in calibration directory : </span><span class="si">{</span><span class="n">caldir</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">exit_job</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">mspath</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remote_logger</span><span class="p">:</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="n">start_ping_logger</span><span class="p">(</span>
                    <span class="n">jobid</span><span class="p">,</span>
                    <span class="n">remote_job_id</span><span class="p">,</span>
                    <span class="n">remote_logger_waittime</span><span class="p">,</span>
                    <span class="n">remote_link</span><span class="o">=</span><span class="n">remote_link</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">meersolar_cachedir</span> <span class="o">=</span> <span class="n">get_meersolar_cachedir</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">save_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">meersolar_cachedir</span><span class="si">}</span><span class="s2">/pids/pids_</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">caldir</span> <span class="o">+</span> <span class="s2">&quot;/*.gcal&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No time-dependent gaintable is present in calibration directory : </span><span class="si">{</span><span class="n">caldir</span><span class="si">}</span><span class="s2">. Applying only bandpass solutions.&quot;</span>
            <span class="p">)</span>
            <span class="n">use_only_bandpass</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1">############################################</span>
        <span class="c1"># Spliting for self-cals</span>
        <span class="c1">############################################</span>
        <span class="c1"># Spliting only if self-cal is requested</span>
        <span class="k">if</span> <span class="n">do_selfcal</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">do_selfcal_split</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">selfcal_target_mslist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/selfcals_scan*.ms&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selfcal_target_mslist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;No measurement set is present for self-calibration. Spliting them..&quot;</span>
                    <span class="p">)</span>
                    <span class="n">do_selfcal_split</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">do_selfcal_split</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;selfcals&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">time_interval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">solint</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;s&quot;</span> <span class="ow">in</span> <span class="n">solint</span><span class="p">:</span>
                        <span class="n">time_interval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">solint</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="s2">&quot;min&quot;</span> <span class="ow">in</span> <span class="n">solint</span><span class="p">:</span>
                        <span class="n">time_interval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">solint</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">60</span>
                    <span class="k">elif</span> <span class="n">solint</span> <span class="o">==</span> <span class="s2">&quot;int&quot;</span><span class="p">:</span>
                        <span class="n">time_interval</span> <span class="o">=</span> <span class="n">image_timeres</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">time_interval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">run_target_split_jobs</span><span class="p">(</span>
                    <span class="n">msname</span><span class="p">,</span>
                    <span class="n">workdir</span><span class="p">,</span>
                    <span class="n">datacolumn</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
                    <span class="n">freqres</span><span class="o">=</span><span class="n">freqavg</span><span class="p">,</span>
                    <span class="n">timeres</span><span class="o">=</span><span class="n">timeavg</span><span class="p">,</span>
                    <span class="n">target_freq_chunk</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                    <span class="n">n_spectral_chunk</span><span class="o">=</span><span class="n">nchunk</span><span class="p">,</span>  <span class="c1"># Number of target spectral chunk</span>
                    <span class="n">target_scans</span><span class="o">=</span><span class="n">target_scans</span><span class="p">,</span>
                    <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
                    <span class="n">merge_spws</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">time_window</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">time_interval</span><span class="p">),</span>
                    <span class="n">time_interval</span><span class="o">=</span><span class="n">time_interval</span><span class="p">,</span>
                    <span class="n">split_fullpol</span><span class="o">=</span><span class="n">do_polcal</span><span class="p">,</span>
                    <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span>
                    <span class="n">cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">max_cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">max_mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;!!!! WARNING: Error in running spliting target scans for selfcal. !!!!&quot;</span>
                    <span class="p">)</span>
                    <span class="n">do_selfcal</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting to finish spliting of target scans for selfcal...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">split_basename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;split_</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">finished_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                            <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/.Finished_&quot;</span> <span class="o">+</span> <span class="n">split_basename</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">success_index_split_target</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">finished_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">success_index_split_target</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;Spliting target scans are done successfully for selfcal.</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;!!!! WARNING: Error in spliting target scans for selfcal. Not continuing further for selfcal. !!!!&quot;</span>
                        <span class="p">)</span>
                        <span class="n">do_selfcal</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">####################################</span>
        <span class="c1"># Filtering any corrupted ms</span>
        <span class="c1">#####################################</span>
        <span class="k">if</span> <span class="n">do_selfcal</span><span class="p">:</span>
            <span class="n">selfcal_target_mslist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/selfcals_scan*.ms&quot;</span><span class="p">)</span>
            <span class="n">filtered_mslist</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Filtering in case any ms is corrupted</span>
            <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">selfcal_target_mslist</span><span class="p">:</span>
                <span class="n">checkcol</span> <span class="o">=</span> <span class="n">check_datacolumn_valid</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">checkcol</span><span class="p">:</span>
                    <span class="n">filtered_mslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Issue in : </span><span class="si">{</span><span class="n">ms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">ms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">selfcal_mslist</span> <span class="o">=</span> <span class="n">filtered_mslist</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selfcal_mslist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;No splited target scan ms are available in work directory for selfcal. Not continuing further for selfcal.&quot;</span>
                <span class="p">)</span>
                <span class="n">do_selfcal</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selfcal mslist : </span><span class="si">{</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">selfcal_mslist</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1">#########################################################</span>
        <span class="c1"># Applying solutions on target scans for self-calibration</span>
        <span class="c1">#########################################################</span>
        <span class="k">if</span> <span class="n">do_selfcal</span><span class="p">:</span>  <span class="c1"># Applying solutions for selfcal</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">run_apply_basiccal_sol</span><span class="p">(</span>
                <span class="n">selfcal_mslist</span><span class="p">,</span>
                <span class="n">workdir</span><span class="p">,</span>
                <span class="n">caldir</span><span class="p">,</span>
                <span class="n">use_only_bandpass</span><span class="o">=</span><span class="n">use_only_bandpass</span><span class="p">,</span>
                <span class="n">overwrite_datacolumn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">applymode</span><span class="o">=</span><span class="s2">&quot;calflag&quot;</span><span class="p">,</span>
                <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span>
                <span class="n">cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;!!!! WARNING: Error in applying basic calibration solutions on target scans. Not continuing further for selfcal.!!!!&quot;</span>
                <span class="p">)</span>
                <span class="n">do_selfcal</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">########################################</span>
        <span class="c1"># Performing self-calibration</span>
        <span class="c1">########################################</span>
        <span class="k">if</span> <span class="n">do_selfcal</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span>
                <span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/*selfcal &quot;</span> <span class="o">+</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/caltables/*selfcal*&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">do_sidereal_cor</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">run_solar_siderealcor_jobs</span><span class="p">(</span>
                    <span class="n">selfcal_mslist</span><span class="p">,</span>
                    <span class="n">workdir</span><span class="p">,</span>
                    <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;selfcals&quot;</span><span class="p">,</span>
                    <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span>
                    <span class="n">cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">max_cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">max_mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sidereal correction is not successful.&quot;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">run_selfcal_jobs</span><span class="p">(</span>
                <span class="n">selfcal_mslist</span><span class="p">,</span>
                <span class="n">workdir</span><span class="p">,</span>
                <span class="n">caldir</span><span class="p">,</span>
                <span class="n">solint</span><span class="o">=</span><span class="n">solint</span><span class="p">,</span>
                <span class="n">do_apcal</span><span class="o">=</span><span class="n">do_ap_selfcal</span><span class="p">,</span>
                <span class="n">solar_selfcal</span><span class="o">=</span><span class="n">solar_selfcal</span><span class="p">,</span>
                <span class="n">keep_backup</span><span class="o">=</span><span class="n">keep_backup</span><span class="p">,</span>
                <span class="n">uvrange</span><span class="o">=</span><span class="n">uvrange</span><span class="p">,</span>
                <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;briggs&quot;</span><span class="p">,</span>
                <span class="n">robust</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span>
                <span class="n">cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;!!!! WARNING: Error in self-calibration on target scans. Not applying self-calibration. !!!!&quot;</span>
                <span class="p">)</span>
                <span class="n">do_apply_selfcal</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">########################################</span>
        <span class="c1"># Checking self-cal caltables</span>
        <span class="c1">########################################</span>
        <span class="n">selfcal_tables</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">caldir</span> <span class="o">+</span> <span class="s2">&quot;/*selfcal*&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selfcal_tables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Self-calibration is not performed and no self-calibration caltable is available.&quot;</span>
            <span class="p">)</span>
            <span class="n">do_apply_selfcal</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">#############################################</span>
        <span class="c1"># Check spliting target scans finished or not</span>
        <span class="c1">#############################################</span>
        <span class="c1"># If corrected data is requested or imaging is requested</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;targets&quot;</span>
        <span class="k">if</span> <span class="n">do_target_split</span> <span class="ow">and</span> <span class="p">(</span><span class="n">do_applycal</span> <span class="ow">or</span> <span class="n">do_imaging</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">run_target_split_jobs</span><span class="p">(</span>
                <span class="n">msname</span><span class="p">,</span>
                <span class="n">workdir</span><span class="p">,</span>
                <span class="n">datacolumn</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
                <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">,</span>
                <span class="n">target_freq_chunk</span><span class="o">=</span><span class="n">target_freq_chunk</span><span class="p">,</span>
                <span class="n">freqres</span><span class="o">=</span><span class="n">freqavg</span><span class="p">,</span>
                <span class="n">timeres</span><span class="o">=</span><span class="n">timeavg</span><span class="p">,</span>
                <span class="n">n_spectral_chunk</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">target_scans</span><span class="o">=</span><span class="n">target_scans</span><span class="p">,</span>
                <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
                <span class="n">split_fullpol</span><span class="o">=</span><span class="n">do_polcal</span><span class="p">,</span>
                <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span>
                <span class="n">cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">max_cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">max_mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;!!!! WARNING: Error in running spliting target scans. !!!!&quot;</span><span class="p">)</span>
                <span class="n">exit_job</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">mspath</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remote_logger</span><span class="p">:</span>
                    <span class="n">pid</span> <span class="o">=</span> <span class="n">start_ping_logger</span><span class="p">(</span>
                        <span class="n">jobid</span><span class="p">,</span>
                        <span class="n">remote_job_id</span><span class="p">,</span>
                        <span class="n">remote_logger_waittime</span><span class="p">,</span>
                        <span class="n">remote_link</span><span class="o">=</span><span class="n">remote_link</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">meersolar_cachedir</span> <span class="o">=</span> <span class="n">get_meersolar_cachedir</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">save_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">meersolar_cachedir</span><span class="si">}</span><span class="s2">/pids/pids_</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="c1">##################################</span>
            <span class="c1"># Waiting only spliting is started</span>
            <span class="c1">##################################</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting to finish spliting of target scans...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">split_basename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;split_</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">finished_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                    <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/.Finished_&quot;</span> <span class="o">+</span> <span class="n">split_basename</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">finished_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">success_index_split_target</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">finished_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">success_index_split_target</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Spliting target scans are done successfully.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;!!!! WARNING: Error in spliting target scans. Not continuing further. !!!!&quot;</span>
                <span class="p">)</span>
                <span class="n">exit_job</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">mspath</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remote_logger</span><span class="p">:</span>
                    <span class="n">pid</span> <span class="o">=</span> <span class="n">start_ping_logger</span><span class="p">(</span>
                        <span class="n">jobid</span><span class="p">,</span>
                        <span class="n">remote_job_id</span><span class="p">,</span>
                        <span class="n">remote_logger_waittime</span><span class="p">,</span>
                        <span class="n">remote_link</span><span class="o">=</span><span class="n">remote_link</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">meersolar_cachedir</span> <span class="o">=</span> <span class="n">get_meersolar_cachedir</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">save_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">meersolar_cachedir</span><span class="si">}</span><span class="s2">/pids/pids_</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">1</span>

        <span class="n">cpu_frac</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">cpu_frac_bkp</span><span class="p">)</span>
        <span class="n">mem_frac</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">mem_frac_bkp</span><span class="p">)</span>
        <span class="n">target_mslist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/targets_scan*.ms&quot;</span><span class="p">)</span>

        <span class="c1">####################################</span>
        <span class="c1"># Filtering any corrupted ms</span>
        <span class="c1">#####################################</span>
        <span class="n">filtered_mslist</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Filtering in case any ms is corrupted</span>
        <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">target_mslist</span><span class="p">:</span>
            <span class="n">checkcol</span> <span class="o">=</span> <span class="n">check_datacolumn_valid</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">checkcol</span><span class="p">:</span>
                <span class="n">filtered_mslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Issue in : </span><span class="si">{</span><span class="n">ms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf </span><span class="si">{ms}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">target_mslist</span> <span class="o">=</span> <span class="n">filtered_mslist</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_mslist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No splited target scan ms are available in work directory.&quot;</span><span class="p">)</span>
            <span class="n">exit_job</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">mspath</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remote_logger</span><span class="p">:</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="n">start_ping_logger</span><span class="p">(</span>
                    <span class="n">jobid</span><span class="p">,</span>
                    <span class="n">remote_job_id</span><span class="p">,</span>
                    <span class="n">remote_logger_waittime</span><span class="p">,</span>
                    <span class="n">remote_link</span><span class="o">=</span><span class="n">remote_link</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">meersolar_cachedir</span> <span class="o">=</span> <span class="n">get_meersolar_cachedir</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">save_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">meersolar_cachedir</span><span class="si">}</span><span class="s2">/pids/pids_</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">do_applycal</span> <span class="ow">or</span> <span class="n">do_imaging</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Target scan mslist : </span><span class="si">{</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">target_mslist</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1">#########################################################</span>
        <span class="c1"># Applying basic solutions on target scans</span>
        <span class="c1">#########################################################</span>
        <span class="k">if</span> <span class="n">do_applycal</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_mslist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">run_apply_basiccal_sol</span><span class="p">(</span>
                    <span class="n">target_mslist</span><span class="p">,</span>
                    <span class="n">workdir</span><span class="p">,</span>
                    <span class="n">caldir</span><span class="p">,</span>
                    <span class="n">use_only_bandpass</span><span class="o">=</span><span class="n">use_only_bandpass</span><span class="p">,</span>
                    <span class="n">overwrite_datacolumn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">applymode</span><span class="o">=</span><span class="s2">&quot;calflag&quot;</span><span class="p">,</span>
                    <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span>
                    <span class="n">cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;!!!! WARNING: Error in applying basic calibration solutions on target scans. Not continuing further.!!!!&quot;</span>
                    <span class="p">)</span>
                    <span class="n">exit_job</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">mspath</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">remote_logger</span><span class="p">:</span>
                        <span class="n">pid</span> <span class="o">=</span> <span class="n">start_ping_logger</span><span class="p">(</span>
                            <span class="n">jobid</span><span class="p">,</span>
                            <span class="n">remote_job_id</span><span class="p">,</span>
                            <span class="n">remote_logger_waittime</span><span class="p">,</span>
                            <span class="n">remote_link</span><span class="o">=</span><span class="n">remote_link</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">meersolar_cachedir</span> <span class="o">=</span> <span class="n">get_meersolar_cachedir</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">save_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">meersolar_cachedir</span><span class="si">}</span><span class="s2">/pids/pids_</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;!!!! WARNING: No measurement set is present for basic calibration applying solutions. Not continuing further. !!!!&quot;</span>
                <span class="p">)</span>
                <span class="n">exit_job</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">mspath</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remote_logger</span><span class="p">:</span>
                    <span class="n">pid</span> <span class="o">=</span> <span class="n">start_ping_logger</span><span class="p">(</span>
                        <span class="n">jobid</span><span class="p">,</span>
                        <span class="n">remote_job_id</span><span class="p">,</span>
                        <span class="n">remote_logger_waittime</span><span class="p">,</span>
                        <span class="n">remote_link</span><span class="o">=</span><span class="n">remote_link</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">meersolar_cachedir</span> <span class="o">=</span> <span class="n">get_meersolar_cachedir</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">save_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">meersolar_cachedir</span><span class="si">}</span><span class="s2">/pids/pids_</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">do_sidereal_cor</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">run_solar_siderealcor_jobs</span><span class="p">(</span>
                    <span class="n">target_mslist</span><span class="p">,</span>
                    <span class="n">workdir</span><span class="p">,</span>
                    <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;targets&quot;</span><span class="p">,</span>
                    <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span>
                    <span class="n">cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">max_cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">max_mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>

        <span class="c1">########################################</span>
        <span class="c1"># Apply self-calibration</span>
        <span class="c1">########################################</span>
        <span class="k">if</span> <span class="n">do_apply_selfcal</span><span class="p">:</span>
            <span class="n">target_mslist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">target_mslist</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">run_apply_selfcal_sol</span><span class="p">(</span>
                <span class="n">target_mslist</span><span class="p">,</span>
                <span class="n">workdir</span><span class="p">,</span>
                <span class="n">caldir</span><span class="p">,</span>
                <span class="n">overwrite_datacolumn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">applymode</span><span class="o">=</span><span class="s2">&quot;calonly&quot;</span><span class="p">,</span>
                <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span>
                <span class="n">cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;!!!! WARNING: Error in applying self-calibration solutions on target scans. !!!!&quot;</span>
                <span class="p">)</span>

        <span class="c1">#####################################</span>
        <span class="c1"># Imaging</span>
        <span class="c1">######################################</span>
        <span class="k">if</span> <span class="n">do_imaging</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">do_polcal</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># Only if do_polcal is False, overwrite to make only Stokes I</span>
                <span class="n">pol</span> <span class="o">=</span> <span class="s2">&quot;I&quot;</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">get_band_name</span><span class="p">(</span><span class="n">target_mslist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">run_imaging_jobs</span><span class="p">(</span>
                <span class="n">target_mslist</span><span class="p">,</span>
                <span class="n">workdir</span><span class="p">,</span>
                <span class="n">outdir</span><span class="p">,</span>
                <span class="n">freqrange</span><span class="o">=</span><span class="n">freqrange</span><span class="p">,</span>
                <span class="n">timerange</span><span class="o">=</span><span class="n">timerange</span><span class="p">,</span>
                <span class="n">minuv</span><span class="o">=</span><span class="n">minuv</span><span class="p">,</span>
                <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span>
                <span class="n">robust</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">robust</span><span class="p">),</span>
                <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span>
                <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span>
                <span class="n">freqres</span><span class="o">=</span><span class="n">image_freqres</span><span class="p">,</span>
                <span class="n">timeres</span><span class="o">=</span><span class="n">image_timeres</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">clean_threshold</span><span class="p">),</span>
                <span class="n">use_multiscale</span><span class="o">=</span><span class="n">use_multiscale</span><span class="p">,</span>
                <span class="n">use_solar_mask</span><span class="o">=</span><span class="n">use_solar_mask</span><span class="p">,</span>
                <span class="n">cutout_rsun</span><span class="o">=</span><span class="n">cutout_rsun</span><span class="p">,</span>
                <span class="n">make_overlay</span><span class="o">=</span><span class="n">make_overlay</span><span class="p">,</span>
                <span class="n">savemodel</span><span class="o">=</span><span class="n">keep_backup</span><span class="p">,</span>
                <span class="n">saveres</span><span class="o">=</span><span class="n">keep_backup</span><span class="p">,</span>
                <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span>
                <span class="n">cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;!!!! WARNING: Final imaging on all measurement sets is not successful. Check the image directory. !!!!&quot;</span>
                <span class="p">)</span>
                <span class="n">exit_job</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">mspath</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remote_logger</span><span class="p">:</span>
                    <span class="n">pid</span> <span class="o">=</span> <span class="n">start_ping_logger</span><span class="p">(</span>
                        <span class="n">jobid</span><span class="p">,</span>
                        <span class="n">remote_job_id</span><span class="p">,</span>
                        <span class="n">remote_logger_waittime</span><span class="p">,</span>
                        <span class="n">remote_link</span><span class="o">=</span><span class="n">remote_link</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">meersolar_cachedir</span> <span class="o">=</span> <span class="n">get_meersolar_cachedir</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">save_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">meersolar_cachedir</span><span class="si">}</span><span class="s2">/pids/pids_</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">1</span>

        <span class="c1">###########################</span>
        <span class="c1"># Primary beam correction</span>
        <span class="c1">###########################</span>
        <span class="k">if</span> <span class="n">do_pbcor</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">weight</span> <span class="o">==</span> <span class="s2">&quot;briggs&quot;</span><span class="p">:</span>
                <span class="n">weight_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">weight</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">robust</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">weight_str</span> <span class="o">=</span> <span class="n">weight</span>
            <span class="k">if</span> <span class="n">image_freqres</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">image_timeres</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">imagedir</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/imagedir_f_all_t_all_w_</span><span class="si">{</span><span class="n">weight_str</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">image_freqres</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">image_timeres</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">imagedir</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">outdir</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/imagedir_f_</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">image_freqres</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">_t_all_w_</span><span class="si">{</span><span class="n">weight_str</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">image_freqres</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">image_timeres</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">imagedir</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">outdir</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/imagedir_f_all_t_</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">image_timeres</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">_w_</span><span class="si">{</span><span class="n">weight_str</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">imagedir</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">outdir</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/imagedir_f_</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">image_freqres</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">_t_</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">image_timeres</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">_w_</span><span class="si">{</span><span class="n">weight_str</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">imagedir</span> <span class="o">=</span> <span class="n">imagedir</span> <span class="o">+</span> <span class="s2">&quot;/images&quot;</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">imagedir</span> <span class="o">+</span> <span class="s2">&quot;/*.fits&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No image is present in image directory: </span><span class="si">{</span><span class="n">imagedir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">run_apply_pbcor</span><span class="p">(</span>
                    <span class="n">imagedir</span><span class="p">,</span>
                    <span class="n">workdir</span><span class="p">,</span>
                    <span class="n">apply_parang</span><span class="o">=</span><span class="n">apply_parang</span><span class="p">,</span>
                    <span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">,</span>
                    <span class="n">cpu_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">cpu_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">mem_frac</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_frac</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;!!!! WARNING: Primary beam corrections of the final images are not successful. !!!!&quot;</span>
                    <span class="p">)</span>
                    <span class="n">exit_job</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">mspath</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">remote_logger</span><span class="p">:</span>
                        <span class="n">pid</span> <span class="o">=</span> <span class="n">start_ping_logger</span><span class="p">(</span>
                            <span class="n">jobid</span><span class="p">,</span>
                            <span class="n">remote_job_id</span><span class="p">,</span>
                            <span class="n">remote_logger_waittime</span><span class="p">,</span>
                            <span class="n">remote_link</span><span class="o">=</span><span class="n">remote_link</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">meersolar_cachedir</span> <span class="o">=</span> <span class="n">get_meersolar_cachedir</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">save_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">meersolar_cachedir</span><span class="si">}</span><span class="s2">/pids/pids_</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="mi">1</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final image directory: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">imagedir</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1">###########################################</span>
        <span class="c1"># Successful exit</span>
        <span class="c1">###########################################</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Calibration and imaging pipeline is successfully run on measurement set : </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">exit_job</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">mspath</span><span class="p">,</span> <span class="n">workdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remote_logger</span><span class="p">:</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="n">start_ping_logger</span><span class="p">(</span>
                <span class="n">jobid</span><span class="p">,</span> <span class="n">remote_job_id</span><span class="p">,</span> <span class="n">remote_logger_waittime</span><span class="p">,</span> <span class="n">remote_link</span><span class="o">=</span><span class="n">remote_link</span>
            <span class="p">)</span>
            <span class="n">meersolar_cachedir</span> <span class="o">=</span> <span class="n">get_meersolar_cachedir</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">save_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">meersolar_cachedir</span><span class="si">}</span><span class="s2">/pids/pids_</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">drop_cache</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
        <span class="n">drop_cache</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
        <span class="n">drop_cache</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.master_controller.main">[docs]</a>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Run MeerSOLAR for calibration and imaging of solar observations.&quot;</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">SmartDefaultsHelpFormatter</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># === Essential parameters ===</span>
    <span class="n">essential</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="s2">&quot;###################</span><span class="se">\n</span><span class="s2">Essential parameters</span><span class="se">\n</span><span class="s2">###################&quot;</span>
    <span class="p">)</span>
    <span class="n">essential</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;msname&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Measurement set name&quot;</span><span class="p">)</span>
    <span class="n">essential</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--workdir&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;workdir&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Working directory&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">essential</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--outdir&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;outdir&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output products directory&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># === Advanced calibration parameters ===</span>
    <span class="n">advanced_cal</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="s2">&quot;###################</span><span class="se">\n</span><span class="s2">Advanced calibration parameters</span><span class="se">\n</span><span class="s2">###################&quot;</span>
    <span class="p">)</span>
    <span class="n">advanced_cal</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--solint&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;5min&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Solution interval for calibration (e.g. &#39;int&#39;, &#39;10s&#39;, &#39;5min&#39;, &#39;inf&#39;)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_cal</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--cal_uvrange&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;UV range to filter data for calibration (e.g. &#39;&gt;100klambda&#39;, &#39;100~10000lambda&#39;)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_cal</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_polcal&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;do_polcal&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable polarization calibration&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># === Advanced imaging and calibration parameters ===</span>
    <span class="n">advanced_image</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="s2">&quot;###################</span><span class="se">\n</span><span class="s2">Advanced imaging parameters</span><span class="se">\n</span><span class="s2">###################&quot;</span>
    <span class="p">)</span>
    <span class="n">advanced_image</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--target_scans&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;List of target scans to process (space-separated, e.g. 3 5 7)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_image</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--freqrange&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Frequency range in MHz to select during imaging (comma-seperate, e.g. &#39;100~110,130~140&#39;)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_image</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--timerange&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Time range to select during imaging (comma-seperated, e.g. &#39;2014/09/06/09:30:00~2014/09/06/09:45:00,2014/09/06/10:30:00~2014/09/06/10:45:00&#39;)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_image</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--image_freqres&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output image frequency resolution in MHz (-1 = full)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_image</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--image_timeres&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output image time resolution in seconds (-1 = full)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_image</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--pol&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;IQUV&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Stokes parameter(s) to image (e.g. &#39;I&#39;, &#39;XX&#39;, &#39;RR&#39;, &#39;IQUV&#39;)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_image</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--minuv&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Minimum baseline length (in wavelengths) to include in imaging&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_image</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--weight&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;briggs&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Imaging weighting scheme (e.g. &#39;briggs&#39;, &#39;natural&#39;, &#39;uniform&#39;)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_image</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--robust&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Robust parameter for Briggs weighting (-2 to +2)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_image</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_multiscale&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;use_multiscale&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable multiscale CLEAN for extended structures&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_image</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--clean_threshold&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Clean threshold in sigma for final deconvolution (Note this is not auto-mask)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_image</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--do_pbcor&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Apply primary beam correction after imaging&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_image</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_apply_parang&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;apply_parang&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable parallactic angle rotation during imaging&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_image</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--cutout_rsun&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Field of view cutout radius in solar radii&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_image</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_solar_mask&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;use_solar_mask&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable use solar disk mask during deconvolution&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_image</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_overlay&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;make_overlay&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable overlay plot on GOES SUVI after imaging&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># === Advanced options ===</span>
    <span class="n">advanced</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="s2">&quot;###################</span><span class="se">\n</span><span class="s2">Advanced pipeline parameters</span><span class="se">\n</span><span class="s2">###################&quot;</span>
    <span class="p">)</span>
    <span class="n">advanced</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--non_solar_data&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;solar_data&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable solar data mode&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--non_ds&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;make_ds&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable making solar dynamic spectra&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--do_forcereset_weightflag&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Force reset of weights and flags (disabled by default)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_noise_cal&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;do_noise_cal&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable noise calibration&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_cal_partition&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;do_cal_partition&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable calibrator MS partitioning&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_cal_flag&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;do_cal_flag&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable initial flagging of calibrators&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_import_model&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;do_import_model&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable model import&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_basic_cal&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;do_basic_cal&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable basic gain calibration&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--do_sidereal_cor&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;do_sidereal_cor&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Sidereal motion correction for Sun (disabled by default)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_selfcal_split&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;do_selfcal_split&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable split for self-calibration&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_selfcal&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;do_selfcal&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable self-calibration&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_ap_selfcal&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;do_ap_selfcal&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable amplitude-phase self-calibration&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_solar_selfcal&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;solar_selfcal&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable solar-specific self-calibration parameters&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_target_split&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;do_target_split&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable target data split&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_applycal&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;do_applycal&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable application of basic calibration solutions&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_apply_selfcal&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;do_apply_selfcal&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable application of self-calibration solutions&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_imaging&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;do_imaging&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable final imaging&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># === Advanced local system/ per node hardware resource parameters ===</span>
    <span class="n">advanced_resource</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="s2">&quot;###################</span><span class="se">\n</span><span class="s2">Advanced hardware resource parameters for local system or per node on HPC cluster</span><span class="se">\n</span><span class="s2">###################&quot;</span>
    <span class="p">)</span>
    <span class="n">advanced_resource</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--cpu_frac&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Fraction of CPU usuage per node&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_resource</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--mem_frac&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Fraction of memory usuage per node&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_resource</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--keep_backup&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Keep backup of intermediate steps&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_resource</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no_remote_logger&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;remote_logger&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable remote logger&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">advanced_resource</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--logger_alivetime&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Keep remote logger alive for this many hours (Otherwise, logger will be removed after 15 minutes of inactivity)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># === Advanced local system/ per node hardware resource parameters ===</span>
    <span class="n">advanced_hpc</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="s2">&quot;###################</span><span class="se">\n</span><span class="s2">Advanced HPC settings</span><span class="se">\n</span><span class="s2">###################&quot;</span>
    <span class="p">)</span>
    <span class="n">advanced_hpc</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--n_nodes&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of compute nodes to use (0 means local cluster)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">########################################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting MeerSOLAR Pipeline....&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#########################################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># TODO: multi specification imaging parameters as json dic </span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">master_control</span><span class="p">(</span>
            <span class="n">msname</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">msname</span><span class="p">,</span>
            <span class="n">workdir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span>
            <span class="n">outdir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
            <span class="n">solar_data</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">solar_data</span><span class="p">,</span>
            <span class="c1"># Pre-calibration</span>
            <span class="n">do_forcereset_weightflag</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">do_forcereset_weightflag</span><span class="p">,</span>
            <span class="n">do_cal_partition</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">do_cal_partition</span><span class="p">,</span>
            <span class="n">do_cal_flag</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">do_cal_flag</span><span class="p">,</span>
            <span class="n">do_import_model</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">do_import_model</span><span class="p">,</span>
            <span class="c1"># Basic calibration</span>
            <span class="n">do_basic_cal</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">do_basic_cal</span><span class="p">,</span>
            <span class="n">do_noise_cal</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">do_noise_cal</span><span class="p">,</span>
            <span class="n">do_applycal</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">do_applycal</span><span class="p">,</span>
            <span class="c1"># Target data preparation</span>
            <span class="n">do_target_split</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">do_target_split</span><span class="p">,</span>
            <span class="n">target_scans</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">target_scans</span><span class="p">,</span>
            <span class="n">freqrange</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">freqrange</span><span class="p">,</span>
            <span class="n">timerange</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">timerange</span><span class="p">,</span>
            <span class="n">uvrange</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">cal_uvrange</span><span class="p">,</span>
            <span class="c1"># Polarization calibration</span>
            <span class="n">do_polcal</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">do_polcal</span><span class="p">,</span>
            <span class="c1"># Self-calibration</span>
            <span class="n">do_selfcal</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">do_selfcal</span><span class="p">,</span>
            <span class="n">do_selfcal_split</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">do_selfcal_split</span><span class="p">,</span>
            <span class="n">do_apply_selfcal</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">do_apply_selfcal</span><span class="p">,</span>
            <span class="n">do_ap_selfcal</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">do_ap_selfcal</span><span class="p">,</span>
            <span class="n">solar_selfcal</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">solar_selfcal</span><span class="p">,</span>
            <span class="n">solint</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">solint</span><span class="p">,</span>
            <span class="c1"># Sidereal correction</span>
            <span class="n">do_sidereal_cor</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">do_sidereal_cor</span><span class="p">,</span>
            <span class="c1"># Dynamic spectra</span>
            <span class="n">make_ds</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">make_ds</span><span class="p">,</span>
            <span class="c1"># Imaging</span>
            <span class="n">do_imaging</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">do_imaging</span><span class="p">,</span>
            <span class="n">do_pbcor</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">do_pbcor</span><span class="p">,</span>
            <span class="n">weight</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
            <span class="n">robust</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">robust</span><span class="p">,</span>
            <span class="n">minuv</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">minuv</span><span class="p">,</span>
            <span class="n">image_freqres</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">image_freqres</span><span class="p">,</span>
            <span class="n">image_timeres</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">image_timeres</span><span class="p">,</span>
            <span class="n">pol</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pol</span><span class="p">,</span>
            <span class="n">apply_parang</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">apply_parang</span><span class="p">,</span>
            <span class="n">clean_threshold</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">clean_threshold</span><span class="p">,</span>
            <span class="n">use_multiscale</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">use_multiscale</span><span class="p">,</span>
            <span class="n">use_solar_mask</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">use_solar_mask</span><span class="p">,</span>
            <span class="n">cutout_rsun</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">cutout_rsun</span><span class="p">,</span>
            <span class="n">make_overlay</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">make_overlay</span><span class="p">,</span>
            <span class="c1"># Resource settings</span>
            <span class="n">cpu_frac</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">cpu_frac</span><span class="p">,</span>
            <span class="n">mem_frac</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">mem_frac</span><span class="p">,</span>
            <span class="n">n_nodes</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">n_nodes</span><span class="p">,</span>
            <span class="n">keep_backup</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">keep_backup</span><span class="p">,</span>
            <span class="c1"># Remote logging</span>
            <span class="n">remote_logger</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">remote_logger</span><span class="p">,</span>
            <span class="n">remote_logger_waittime</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">logger_alivetime</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">drop_cache</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">msname</span><span class="p">)</span>
        <span class="n">drop_cache</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="n">drop_cache</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Devojyoti Kansabanik, Deepan Patra
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=4ebf8126"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    </body>
</html>