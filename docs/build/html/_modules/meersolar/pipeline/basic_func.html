<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />

    <!-- Generated with Sphinx 7.4.7 and Furo 2024.01.29 -->
        <title>meersolar.pipeline.basic_func - MeerSOLAR</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=2b5763e6" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">MeerSOLAR</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../../_static/yourlogo-light.png" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../../../_static/yourlogo-dark.png" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">MeerSOLAR</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../install.html">Installation and Initial Setup</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Installation and Initial Setup</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../install_conda.html">Installing Conda: Anaconda or Miniconda</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../activate_conda.html">Creating and Activating Conda Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../install_meersolar.html">Install MeerSOLAR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../initial_setup.html">Initial Setup</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../tutorial.html">Tutorial</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Tutorial</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../flowchart.html">MeerSOLAR Flowchart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../runpipeline.html">Run MeerSOLAR Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../output.html">Directory Structure and Data Products</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli.html">Command line tools</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../meersolar.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../meersolar.pipeline.html">Meersolar Pipeline Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../meersolar.crystalball.html">Crystalball Module</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for meersolar.pipeline.basic_func</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">gc</span><span class="o">,</span> <span class="nn">tempfile</span><span class="o">,</span> <span class="nn">copy</span><span class="o">,</span> <span class="nn">traceback</span><span class="o">,</span> <span class="nn">resource</span><span class="o">,</span> <span class="nn">requests</span><span class="o">,</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">socket</span><span class="o">,</span> <span class="nn">argparse</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;QT_OPENGL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;software&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;QT_QPA_PLATFORM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;offscreen&quot;</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">ticker</span><span class="o">,</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span><span class="o">,</span> <span class="nn">matplotlib</span><span class="o">,</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">dask</span><span class="o">,</span> <span class="nn">psutil</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">sunpy</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span><span class="o">,</span> <span class="nn">string</span><span class="o">,</span> <span class="nn">secrets</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">EarthLocation</span><span class="p">,</span> <span class="n">SkyCoord</span>
<span class="kn">from</span> <span class="nn">sunpy.map</span> <span class="kn">import</span> <span class="n">Map</span>
<span class="kn">from</span> <span class="nn">sunpy.coordinates</span> <span class="kn">import</span> <span class="n">frames</span><span class="p">,</span> <span class="n">sun</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">dt</span><span class="p">,</span> <span class="n">timezone</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">casalog</span><span class="p">,</span>
    <span class="n">importfits</span><span class="p">,</span>
    <span class="n">listpartition</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">gaussian_filter</span>
<span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">msmetadata</span><span class="p">,</span> <span class="n">ms</span> <span class="k">as</span> <span class="n">casamstool</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">agentflagger</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">LocalCluster</span>
<span class="kn">from</span> <span class="nn">dask</span> <span class="kn">import</span> <span class="n">delayed</span><span class="p">,</span> <span class="n">compute</span><span class="p">,</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">get_sun</span><span class="p">,</span> <span class="n">SkyCoord</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>
<span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">casalog</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">ImageNormalize</span><span class="p">,</span> <span class="n">PowerStretch</span><span class="p">,</span> <span class="n">LogStretch</span>
<span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Ellipse</span><span class="p">,</span> <span class="n">Rectangle</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">ListedColormap</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">from</span> <span class="nn">sunpy</span> <span class="kn">import</span> <span class="n">timeseries</span> <span class="k">as</span> <span class="n">ts</span>
<span class="kn">from</span> <span class="nn">sunpy.net</span> <span class="kn">import</span> <span class="n">Fido</span><span class="p">,</span> <span class="n">attrs</span> <span class="k">as</span> <span class="n">a</span>
<span class="kn">from</span> <span class="nn">sunpy.coordinates</span> <span class="kn">import</span> <span class="n">SphericalScreen</span>
<span class="kn">from</span> <span class="nn">sunpy.map.maputils</span> <span class="kn">import</span> <span class="n">all_coordinates_from_map</span>
<span class="kn">from</span> <span class="nn">sunpy.time</span> <span class="kn">import</span> <span class="n">parse_time</span>
<span class="kn">from</span> <span class="nn">watchdog.observers</span> <span class="kn">import</span> <span class="n">Observer</span>
<span class="kn">from</span> <span class="nn">watchdog.events</span> <span class="kn">import</span> <span class="n">FileSystemEventHandler</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">logfile</span> <span class="o">=</span> <span class="n">casalog</span><span class="o">.</span><span class="n">logfile</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">logfile</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<div class="viewcode-block" id="get_datadir">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_datadir">[docs]</a>
<span class="k">def</span> <span class="nf">get_datadir</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get package data directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">importlib.resources</span> <span class="kn">import</span> <span class="n">files</span>

    <span class="n">datadir_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">files</span><span class="p">(</span><span class="s2">&quot;meersolar&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">datadir_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datadir_path</span><span class="si">}</span><span class="s2">/pids&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">datadir_path</span></div>



<span class="n">datadir</span> <span class="o">=</span> <span class="n">get_datadir</span><span class="p">()</span>
<span class="n">udocker_dir</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s2">&quot;/udocker&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;UDOCKER_DIR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">udocker_dir</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;UDOCKER_TARBALL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="s2">&quot;/udocker-englib-1.2.11.tar.gz&quot;</span>

<div class="viewcode-block" id="SmartDefaultsHelpFormatter">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.SmartDefaultsHelpFormatter">[docs]</a>
<span class="k">class</span> <span class="nc">SmartDefaultsHelpFormatter</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentDefaultsHelpFormatter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_get_help_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="c1"># Don&#39;t show default for boolean flags</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">argparse</span><span class="o">.</span><span class="n">_StoreTrueAction</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">argparse</span><span class="o">.</span><span class="n">_StoreFalseAction</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">action</span><span class="o">.</span><span class="n">help</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_help_string</span><span class="p">(</span><span class="n">action</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="init_udocker">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.init_udocker">[docs]</a>
<span class="k">def</span> <span class="nf">init_udocker</span><span class="p">():</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;udocker install&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="suppress_casa_output">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.suppress_casa_output">[docs]</a>
<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">suppress_casa_output</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fnull</span><span class="p">:</span>
        <span class="n">old_stdout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">old_stderr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">fnull</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">fnull</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">old_stdout</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">old_stderr</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="clean_shutdown">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.clean_shutdown">[docs]</a>
<span class="k">def</span> <span class="nf">clean_shutdown</span><span class="p">(</span><span class="n">observer</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">observer</span><span class="p">:</span>
        <span class="n">observer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">observer</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></div>



<div class="viewcode-block" id="limit_threads">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.limit_threads">[docs]</a>
<span class="k">def</span> <span class="nf">limit_threads</span><span class="p">(</span><span class="n">n_threads</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Limit number of threads usuage</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_threads : int, optional</span>
<span class="sd">        Number of threads</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n_threads</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OMP_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_threads</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OPENBLAS_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_threads</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MKL_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_threads</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;VECLIB_MAXIMUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_threads</span><span class="p">)</span></div>



<div class="viewcode-block" id="generate_password">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.generate_password">[docs]</a>
<span class="k">def</span> <span class="nf">generate_password</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate secure 6-character password with letters, digits, and symbols</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chars</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="s2">&quot;@#$&amp;*&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">secrets</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">))</span></div>



<div class="viewcode-block" id="get_remote_logger_link">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_remote_logger_link">[docs]</a>
<span class="k">def</span> <span class="nf">get_remote_logger_link</span><span class="p">():</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">get_datadir</span><span class="p">()</span>
    <span class="n">link_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;remotelink.txt&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">link_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="n">remote_link</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">remote_link</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">remote_link</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>


<div class="viewcode-block" id="get_emails">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_emails">[docs]</a>
<span class="k">def</span> <span class="nf">get_emails</span><span class="p">():</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">get_datadir</span><span class="p">()</span>
    <span class="n">email_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;emails.txt&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">email_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="RemoteLogger">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.RemoteLogger">[docs]</a>
<span class="k">class</span> <span class="nc">RemoteLogger</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remote logging handler for posting log messages to a web endpoint.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">log_id</span><span class="o">=</span><span class="s2">&quot;run_default&quot;</span><span class="p">,</span> <span class="n">remote_link</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_id</span> <span class="o">=</span> <span class="n">log_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_link</span> <span class="o">=</span> <span class="n">remote_link</span>

<div class="viewcode-block" id="RemoteLogger.emit">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.RemoteLogger.emit">[docs]</a>
    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_link</span><span class="si">}</span><span class="s2">/api/log&quot;</span><span class="p">,</span>
                <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">,</span>
                    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
                    <span class="s2">&quot;first&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># Fail silently to avoid interrupting the main app</span></div>
</div>



<div class="viewcode-block" id="LogTailHandler">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.LogTailHandler">[docs]</a>
<span class="k">class</span> <span class="nc">LogTailHandler</span><span class="p">(</span><span class="n">FileSystemEventHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Continuous logging</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span> <span class="o">=</span> <span class="n">logfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>

<div class="viewcode-block" id="LogTailHandler.on_modified">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.LogTailHandler.on_modified">[docs]</a>
    <span class="k">def</span> <span class="nf">on_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">src_path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_position</span><span class="p">)</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">line</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span> <span class="ow">and</span> <span class="n">line</span> <span class="o">!=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="ping_logger">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.ping_logger">[docs]</a>
<span class="k">def</span> <span class="nf">ping_logger</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">,</span> <span class="n">remote_link</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ping a job-specific keep-alive endpoint periodically until stop_event is set.&quot;&quot;&quot;</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PID&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">get_datadir</span><span class="p">()</span>
    <span class="n">save_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">datadir</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/pids/pids_</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># 10 min interval</span>
    <span class="k">if</span> <span class="n">remote_link</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remote_link</span><span class="si">}</span><span class="s2">/api/ping/</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">stop_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[ping_logger] Ping sent for job </span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">dt</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">stop_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_logger">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.create_logger">[docs]</a>
<span class="k">def</span> <span class="nf">create_logger</span><span class="p">(</span><span class="n">logname</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create logger.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    logname : str</span>
<span class="sd">        Name of the log</span>
<span class="sd">    workdir : str, optional</span>
<span class="sd">        Name of the working directory</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Verbose output or not</span>
<span class="sd">    logfile : str, optional</span>
<span class="sd">        Log file name</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    logger</span>
<span class="sd">        Python logging object</span>
<span class="sd">    str</span>
<span class="sd">        Log file name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">logfile</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">logfile</span><span class="p">)</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">logname</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">console</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="n">console</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>
    <span class="n">filehandle</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span>
    <span class="n">filehandle</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">filehandle</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Log file : &quot;</span> <span class="o">+</span> <span class="n">logfile</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logger</span><span class="p">,</span> <span class="n">logfile</span></div>



<div class="viewcode-block" id="get_logid">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_logid">[docs]</a>
<span class="k">def</span> <span class="nf">get_logid</span><span class="p">(</span><span class="n">logfile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get log id for remote logger from logfile name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span>
    <span class="n">logmap</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;apply_basiccal.log&quot;</span><span class="p">:</span> <span class="s2">&quot;Applying basic calibration solutions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;apply_pbcor.log&quot;</span><span class="p">:</span> <span class="s2">&quot;Applying primary beam corrections&quot;</span><span class="p">,</span>
        <span class="s2">&quot;apply_selfcal.log&quot;</span><span class="p">:</span> <span class="s2">&quot;Applying self-calibration solutions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;basic_cal.log&quot;</span><span class="p">:</span> <span class="s2">&quot;Basic calibration&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cor_sidereal_selfcals.log&quot;</span><span class="p">:</span> <span class="s2">&quot;Correction of sidereal motion before self-calibration&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cor_sidereal_targets.log&quot;</span><span class="p">:</span> <span class="s2">&quot;Correction of sidereal motion for target scans&quot;</span><span class="p">,</span>
        <span class="s2">&quot;flagging_cal_calibrator.log&quot;</span><span class="p">:</span> <span class="s2">&quot;Basic flagging&quot;</span><span class="p">,</span>
        <span class="s2">&quot;modeling_calibrator.log&quot;</span><span class="p">:</span> <span class="s2">&quot;Simulating visibilities of calibrators&quot;</span><span class="p">,</span>
        <span class="s2">&quot;split_targets.log&quot;</span><span class="p">:</span> <span class="s2">&quot;Spliting target scans&quot;</span><span class="p">,</span>
        <span class="s2">&quot;split_selfcals.log&quot;</span><span class="p">:</span> <span class="s2">&quot;Spliting for self-calibration&quot;</span><span class="p">,</span>
        <span class="s2">&quot;selfcal_targets.mainlog&quot;</span><span class="p">:</span> <span class="s2">&quot;All self-calibrations main log&quot;</span><span class="p">,</span>
        <span class="s2">&quot;imaging_targets.mainlog&quot;</span><span class="p">:</span> <span class="s2">&quot;All imaging main log&quot;</span><span class="p">,</span>
        <span class="s2">&quot;selfcal_targets.log&quot;</span><span class="p">:</span> <span class="s2">&quot;All self-calibrations&quot;</span><span class="p">,</span>
        <span class="s2">&quot;imaging_targets.log&quot;</span><span class="p">:</span> <span class="s2">&quot;All imaging&quot;</span><span class="p">,</span>
        <span class="s2">&quot;noise_cal.log&quot;</span><span class="p">:</span> <span class="s2">&quot;Flux calibration using noise-diode&quot;</span><span class="p">,</span>
        <span class="s2">&quot;partition_cal.log&quot;</span><span class="p">:</span> <span class="s2">&quot;Partioning for basic calibration&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">logmap</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">logmap</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s2">&quot;selfcals_scan_&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;_selfcal.log&quot;</span><span class="p">)</span>
        <span class="n">scan</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;scan_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_spw&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spw</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;spw_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_selfcal&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Self-calibration for: Scan : </span><span class="si">{</span><span class="n">scan</span><span class="si">}</span><span class="s2">, Spectral window: </span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;imaging_targets_scan_&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;.log&quot;</span><span class="p">)</span>
        <span class="n">scan</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;scan_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_spw&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spw</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;spw_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_selfcal&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Imaging for: Scan : </span><span class="si">{</span><span class="n">scan</span><span class="si">}</span><span class="s2">, Spectral window: </span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">name</span></div>



<div class="viewcode-block" id="init_logger">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.init_logger">[docs]</a>
<span class="k">def</span> <span class="nf">init_logger</span><span class="p">(</span><span class="n">logname</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">jobname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize a local + optional remote logger with watchdog-based tailing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    logname : str</span>
<span class="sd">        Logger name.</span>
<span class="sd">    logfile : str</span>
<span class="sd">        Path to the local logfile to also monitor.</span>
<span class="sd">    jobname : str, optional</span>
<span class="sd">        Remote logger job ID.</span>
<span class="sd">    password : str</span>
<span class="sd">        Password used for remote authentication.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    logger : logging.Logger</span>
<span class="sd">        Configured logger instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">waited</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">waited</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">waited</span> <span class="o">&gt;=</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">logname</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">hasHandlers</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(levelname)s</span><span class="s2">-</span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S&quot;</span>
    <span class="p">)</span>
    <span class="n">remote_link</span> <span class="o">=</span> <span class="n">get_remote_logger_link</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">remote_link</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">jobname</span><span class="p">:</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="n">jobname</span>
            <span class="n">log_id</span> <span class="o">=</span> <span class="n">get_logid</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span>
            <span class="n">remote_handler</span> <span class="o">=</span> <span class="n">RemoteLogger</span><span class="p">(</span>
                <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span> <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span> <span class="n">remote_link</span><span class="o">=</span><span class="n">remote_link</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span>
            <span class="p">)</span>
            <span class="n">remote_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">remote_handler</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remote_link</span><span class="si">}</span><span class="s2">/api/log&quot;</span><span class="p">,</span>
                    <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span>
                        <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Job starting...&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
                        <span class="s2">&quot;first&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">logfile</span><span class="p">):</span>
            <span class="n">event_handler</span> <span class="o">=</span> <span class="n">LogTailHandler</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
            <span class="n">observer</span> <span class="o">=</span> <span class="n">Observer</span><span class="p">()</span>
            <span class="n">observer</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span>
                <span class="n">event_handler</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">logfile</span><span class="p">),</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">observer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">observer</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span></div>



<div class="viewcode-block" id="flag_outside_uvrange">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.flag_outside_uvrange">[docs]</a>
<span class="k">def</span> <span class="nf">flag_outside_uvrange</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">uvrange</span><span class="p">,</span> <span class="n">n_threads</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">flagbackup</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flag outside the given uv range</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vis : str</span>
<span class="sd">        Measurement set name</span>
<span class="sd">    uvrange : str</span>
<span class="sd">        UV-range</span>
<span class="sd">    n_threads : int, optional</span>
<span class="sd">        Number of OpenMP threads to use</span>
<span class="sd">    flagbackup : bool, optional</span>
<span class="sd">        Flag backup</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">limit_threads</span><span class="p">(</span><span class="n">n_threads</span><span class="o">=</span><span class="n">n_threads</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">flagdata</span>

    <span class="k">if</span> <span class="s2">&quot;lambda&quot;</span> <span class="ow">in</span> <span class="n">uvrange</span><span class="p">:</span>
        <span class="n">islambda</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">uvrange</span> <span class="o">=</span> <span class="n">uvrange</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;lambda&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">islambda</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s2">&quot;~&quot;</span> <span class="ow">in</span> <span class="n">uvrange</span><span class="p">:</span>
        <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">uvrange</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">islambda</span><span class="p">:</span>
            <span class="n">low</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s2">lambda&quot;</span>
            <span class="n">high</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s2">lambda&quot;</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;manual&quot;</span><span class="p">,</span> <span class="s2">&quot;uvrange&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;flagbackup&quot;</span><span class="p">:</span> <span class="n">flagbackup</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;manual&quot;</span><span class="p">,</span> <span class="s2">&quot;uvrange&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&gt;</span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;flagbackup&quot;</span><span class="p">:</span> <span class="n">flagbackup</span><span class="p">},</span>
        <span class="p">]</span>
    <span class="k">elif</span> <span class="s2">&quot;&gt;&quot;</span> <span class="ow">in</span> <span class="n">uvrange</span><span class="p">:</span>
        <span class="n">low</span> <span class="o">=</span> <span class="n">uvrange</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">islambda</span><span class="p">:</span>
            <span class="n">low</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s2">lambda&quot;</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;manual&quot;</span><span class="p">,</span> <span class="s2">&quot;uvrange&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;flagbackup&quot;</span><span class="p">:</span> <span class="n">flagbackup</span><span class="p">},</span>
        <span class="p">]</span>
    <span class="k">elif</span> <span class="s2">&quot;&lt;&quot;</span> <span class="ow">in</span> <span class="n">uvrange</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">islambda</span><span class="p">:</span>
            <span class="n">high</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s2">lambda&quot;</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;manual&quot;</span><span class="p">,</span> <span class="s2">&quot;uvrange&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&gt;</span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;flagbackup&quot;</span><span class="p">:</span> <span class="n">flagbackup</span><span class="p">},</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flagging command: </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">flagdata</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="o">**</span><span class="n">cmd</span><span class="p">)</span>
    <span class="k">return</span></div>



<div class="viewcode-block" id="make_ds_plot">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.make_ds_plot">[docs]</a>
<span class="k">def</span> <span class="nf">make_ds_plot</span><span class="p">(</span><span class="n">dsfiles</span><span class="p">,</span> <span class="n">plot_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">showgui</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make dynamic spectrum plot</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dsfile : list</span>
<span class="sd">        DS files list</span>
<span class="sd">    plot_file : str, optional</span>
<span class="sd">        Plot file name to save the plot</span>
<span class="sd">    showgui : bool, optional</span>
<span class="sd">        Show GUI</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Plot name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">showgui</span><span class="p">:</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;Agg&quot;</span><span class="p">)</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">})</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dsfile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dsfiles</span><span class="p">):</span>
        <span class="n">freqs_i</span><span class="p">,</span> <span class="n">times_i</span><span class="p">,</span> <span class="n">timestamps_i</span><span class="p">,</span> <span class="n">data_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dsfile</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">freqs</span> <span class="o">=</span> <span class="n">freqs_i</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">times_i</span>
            <span class="n">timestamps</span> <span class="o">=</span> <span class="n">timestamps_i</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data_i</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gapsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">times_i</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">times</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">gapsize</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">last_time_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">new_time_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">data_i</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">data_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_i</span> <span class="o">/</span> <span class="n">new_time_median</span><span class="p">)</span> <span class="o">*</span> <span class="n">last_time_median</span>
            <span class="c1"># Insert vertical NaN gap (1 column wide)</span>
            <span class="n">gap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gapsize</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">gap</span><span class="p">,</span> <span class="n">data_i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Insert dummy time and timestamp</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">timestamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="s2">&quot;GAP&quot;</span><span class="p">)</span>
            <span class="c1"># Append new values</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">times_i</span><span class="p">)</span>
            <span class="n">timestamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">timestamps_i</span><span class="p">)</span>
            <span class="c1"># (Optional) Check or merge freqs if needed — assuming same across files</span>
    <span class="c1"># Normalize by median bandshape</span>
    <span class="n">median_bandshape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">median_bandshape</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">/=</span> <span class="n">median_bandshape</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="p">:]</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">pos</span><span class="p">)]</span>
    <span class="n">temp_times</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
    <span class="n">maxtimepos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">temp_times</span><span class="p">)</span>
    <span class="n">mintimepos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">temp_times</span><span class="p">)</span>
    <span class="n">datestamp</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamps</span><span class="p">[</span><span class="n">mintimepos</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">tstart</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamps</span><span class="p">[</span><span class="n">mintimepos</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="n">mintimepos</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">tend</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamps</span><span class="p">[</span><span class="n">maxtimepos</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timestamps</span><span class="p">[</span><span class="n">maxtimepos</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time range : </span><span class="si">{</span><span class="n">tstart</span><span class="si">}</span><span class="s2">~</span><span class="si">{</span><span class="n">tend</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">Fido</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
        <span class="n">a</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tend</span><span class="p">),</span> <span class="n">a</span><span class="o">.</span><span class="n">Instrument</span><span class="p">(</span><span class="s2">&quot;XRS&quot;</span><span class="p">),</span> <span class="n">a</span><span class="o">.</span><span class="n">Resolution</span><span class="p">(</span><span class="s2">&quot;avg1m&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">Fido</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dsfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">goes_tseries</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">TimeSeries</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">concatenate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">goes_tseries</span> <span class="o">=</span> <span class="n">goes_tseries</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tend</span><span class="p">)</span>
    <span class="n">timeseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Normalization</span>
    <span class="n">data_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">data_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">stretch</span><span class="o">=</span><span class="n">LogStretch</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">vmin</span><span class="o">=</span><span class="mf">0.99</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
        <span class="n">vmax</span><span class="o">=</span><span class="mf">0.99</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># Create figure and GridSpec layout</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">],</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="c1"># Axes</span>
    <span class="n">ax_spec</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ax_ts</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ax_goes</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>  <span class="c1"># colorbar spans both rows</span>
    <span class="c1"># Plot dynamic spectrum</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax_spec</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;magma&quot;</span><span class="p">)</span>
    <span class="n">ax_spec</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency (MHz)&quot;</span><span class="p">)</span>
    <span class="n">ax_spec</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>  <span class="c1"># Remove x-axis labels from top plot</span>
    <span class="c1"># Y-ticks</span>
    <span class="n">yticks</span> <span class="o">=</span> <span class="n">ax_spec</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()</span>
    <span class="n">yticks</span> <span class="o">=</span> <span class="n">yticks</span><span class="p">[(</span><span class="n">yticks</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">yticks</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">))]</span>
    <span class="n">ax_spec</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
    <span class="n">ax_spec</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">freqs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">yticks</span><span class="p">])</span>
    <span class="c1"># Plot time series</span>
    <span class="n">ax_ts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
    <span class="n">ax_ts</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax_ts</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Mean </span><span class="se">\n</span><span class="s2"> flux density&quot;</span><span class="p">)</span>
    <span class="n">goes_tseries</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">ax_goes</span><span class="p">)</span>
    <span class="n">goes_times</span> <span class="o">=</span> <span class="n">goes_tseries</span><span class="o">.</span><span class="n">time</span>
    <span class="n">times_dt</span> <span class="o">=</span> <span class="n">goes_times</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">()</span>
    <span class="n">ax_goes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">times_dt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">times_dt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax_goes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Flux ($\frac</span><span class="si">{W}</span><span class="s2">{m^2}$)&quot;</span><span class="p">)</span>
    <span class="n">ax_goes</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
    <span class="n">ax_goes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;GOES light curve&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax_ts</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;MeerKAT light curve&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax_spec</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;MeerKAT dynamic spectrum&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax_goes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (UTC)&quot;</span><span class="p">)</span>
    <span class="c1"># Format x-ticks</span>
    <span class="n">ax_ts</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax_ts</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="c1"># Colorbar</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Flux density (arb. unit)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="c1"># Save or show</span>
    <span class="k">if</span> <span class="n">plot_file</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_file</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plot saved: </span><span class="si">{</span><span class="n">plot_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">showgui</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plot_file</span></div>



<div class="viewcode-block" id="make_solar_DS">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.make_solar_DS">[docs]</a>
<span class="k">def</span> <span class="nf">make_solar_DS</span><span class="p">(</span>
    <span class="n">msname</span><span class="p">,</span>
    <span class="n">workdir</span><span class="p">,</span>
    <span class="n">ds_file_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span>
    <span class="n">scans</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">merge_scan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">showgui</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">cpu_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">mem_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make solar dynamic spectrum and plots</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Measurement set name&#39;</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Work directory</span>
<span class="sd">    ds_file_name : str, optional</span>
<span class="sd">        DS file name prefix</span>
<span class="sd">    extension : str, optional</span>
<span class="sd">        Image file extension</span>
<span class="sd">    scans : list, optional</span>
<span class="sd">        Scan list</span>
<span class="sd">    merge_scan : bool, optional</span>
<span class="sd">        Merge scans in one plot or not</span>
<span class="sd">    showgui : bool, optional</span>
<span class="sd">        Show GUI</span>
<span class="sd">    cpu_frac : float, optional</span>
<span class="sd">        CPU fraction to use</span>
<span class="sd">    mem_frac : float, optional</span>
<span class="sd">        Memory fraction to use</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">warnings</span>

    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">##############################</span>
    <span class="c1"># Extract dynamic spectrum</span>
    <span class="c1">##############################</span>
    <span class="k">def</span> <span class="nf">make_ds_file_per_scan</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">save_file</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="n">datacolumn</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_file</span><span class="si">}</span><span class="s2">.npy&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">mstool</span> <span class="o">=</span> <span class="n">casamstool</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">all_data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ant</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting data for antenna :</span><span class="si">{</span><span class="n">ant</span><span class="si">}</span><span class="s2">, scan: </span><span class="si">{</span><span class="n">scan</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">mstool</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
                    <span class="n">mstool</span><span class="o">.</span><span class="n">selectpolarization</span><span class="p">([</span><span class="s2">&quot;I&quot;</span><span class="p">])</span>
                    <span class="n">mstool</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;antenna1&quot;</span><span class="p">:</span> <span class="n">ant</span><span class="p">,</span> <span class="s2">&quot;antenna2&quot;</span><span class="p">:</span> <span class="n">ant</span><span class="p">,</span> <span class="s2">&quot;scan_number&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">scan</span><span class="p">)}</span>
                    <span class="p">)</span>
                    <span class="n">data_dic</span> <span class="o">=</span> <span class="n">mstool</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">datacolumn</span><span class="p">)</span>
                    <span class="n">mstool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">datacolumn</span> <span class="o">==</span> <span class="s2">&quot;CORRECTED_DATA&quot;</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_dic</span><span class="p">[</span><span class="s2">&quot;corrected_data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_dic</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
                    <span class="k">del</span> <span class="n">data_dic</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="n">m</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
                    <span class="n">all_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">data</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Auto-corrrelations are not present. Using short baselines.&quot;</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">all_data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">while</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Extracting data for antennas :</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">, scan: </span><span class="si">{</span><span class="n">scan</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                                <span class="n">mstool</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
                                <span class="n">mstool</span><span class="o">.</span><span class="n">selectpolarization</span><span class="p">([</span><span class="s2">&quot;I&quot;</span><span class="p">])</span>
                                <span class="n">mstool</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                                    <span class="p">{</span>
                                        <span class="s2">&quot;antenna1&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                                        <span class="s2">&quot;antenna2&quot;</span><span class="p">:</span> <span class="n">j</span><span class="p">,</span>
                                        <span class="s2">&quot;scan_number&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">scan</span><span class="p">),</span>
                                    <span class="p">}</span>
                                <span class="p">)</span>
                                <span class="n">data_dic</span> <span class="o">=</span> <span class="n">mstool</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">datacolumn</span><span class="p">)</span>
                                <span class="n">mstool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">datacolumn</span> <span class="o">==</span> <span class="s2">&quot;CORRECTED_DATA&quot;</span><span class="p">:</span>
                                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_dic</span><span class="p">[</span><span class="s2">&quot;corrected_data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_dic</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
                                <span class="k">del</span> <span class="n">data_dic</span>
                                <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="n">m</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
                                <span class="n">all_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                                <span class="k">del</span> <span class="n">data</span>
                                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">all_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_data</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">all_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">bad_chans</span> <span class="o">=</span> <span class="n">get_bad_chans</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
            <span class="n">bad_chans</span> <span class="o">=</span> <span class="n">bad_chans</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;0:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">bad_chan</span> <span class="ow">in</span> <span class="n">bad_chans</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bad_chan</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">e</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bad_chan</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
            <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
            <span class="n">freqs</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanfreqs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;MHz&quot;</span><span class="p">)</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">timesforscans</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">scan</span><span class="p">))</span>
            <span class="n">timestamps</span> <span class="o">=</span> <span class="p">[</span><span class="n">mjdsec_to_timestamp</span><span class="p">(</span><span class="n">mjdsec</span><span class="p">,</span> <span class="n">str_format</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">mjdsec</span> <span class="ow">in</span> <span class="n">times</span><span class="p">]</span>
            <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_file</span><span class="si">}</span><span class="s2">.npy&quot;</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">freqs</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">,</span> <span class="n">data</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">del</span> <span class="n">msmd</span><span class="p">,</span> <span class="n">mstool</span><span class="p">,</span> <span class="n">data</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_file</span><span class="si">}</span><span class="s2">.npy&quot;</span>

    <span class="c1">##################################</span>
    <span class="c1"># Making and ploting</span>
    <span class="c1">##################################</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scans</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">scans</span><span class="p">,</span> <span class="n">cal_scans</span><span class="p">,</span> <span class="n">f_scans</span><span class="p">,</span> <span class="n">g_scans</span><span class="p">,</span> <span class="n">p_scans</span> <span class="o">=</span> <span class="n">get_cal_target_scans</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">valid_scans</span> <span class="o">=</span> <span class="n">get_valid_scans</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">final_scans</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scan_size_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">mstool</span> <span class="o">=</span> <span class="n">casamstool</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">valid_scans</span><span class="p">:</span>
            <span class="n">final_scans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">scan</span><span class="p">))</span>
            <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
            <span class="n">nchan</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">nchan</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">nant</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">nantennas</span><span class="p">()</span>
            <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">mstool</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
            <span class="n">mstool</span><span class="o">.</span><span class="n">select</span><span class="p">({</span><span class="s2">&quot;scan_number&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">scan</span><span class="p">)})</span>
            <span class="n">nrow</span> <span class="o">=</span> <span class="n">mstool</span><span class="o">.</span><span class="n">nrow</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">mstool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">nbaselines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nant</span> <span class="o">+</span> <span class="p">(</span><span class="n">nant</span> <span class="o">*</span> <span class="p">(</span><span class="n">nant</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">scan_size_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">nrow</span> <span class="o">/</span> <span class="n">nbaselines</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">scans</span>
    <span class="n">scans</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">final_scans</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scans: </span><span class="si">{</span><span class="n">scans</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ds_file_name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">ds_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.ms&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_DS&quot;</span>
    <span class="n">hascor</span> <span class="o">=</span> <span class="n">check_datacolumn_valid</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">datacolumn</span><span class="o">=</span><span class="s2">&quot;CORRECTED_DATA&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hascor</span><span class="p">:</span>
        <span class="n">datacolumn</span> <span class="o">=</span> <span class="s2">&quot;CORRECTED_DATA&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">datacolumn</span> <span class="o">=</span> <span class="s2">&quot;DATA&quot;</span>
    <span class="n">mspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">mem_limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">scan_size_list</span><span class="p">)</span>
    <span class="n">dask_client</span><span class="p">,</span> <span class="n">dask_cluster</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">,</span> <span class="n">n_threads</span><span class="p">,</span> <span class="n">mem_limit</span> <span class="o">=</span> <span class="n">get_dask_client</span><span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">scans</span><span class="p">),</span>
        <span class="n">dask_dir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span>
        <span class="n">cpu_frac</span><span class="o">=</span><span class="n">cpu_frac</span><span class="p">,</span>
        <span class="n">mem_frac</span><span class="o">=</span><span class="n">mem_frac</span><span class="p">,</span>
        <span class="n">min_mem_per_job</span><span class="o">=</span><span class="n">mem_limit</span> <span class="o">/</span> <span class="mf">0.6</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">delayed</span><span class="p">(</span><span class="n">make_ds_file_per_scan</span><span class="p">)(</span>
                <span class="n">msname</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workdir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">ds_file_name</span><span class="si">}</span><span class="s2">_scan_</span><span class="si">{</span><span class="n">scan</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="n">datacolumn</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
    <span class="n">dask_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">dask_cluster</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">ds_files</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workdir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">ds_file_name</span><span class="si">}</span><span class="s2">_scan_</span><span class="si">{</span><span class="n">scan</span><span class="si">}</span><span class="s2">.npy&quot;</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DS files: </span><span class="si">{</span><span class="n">ds_files</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">merge_scan</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">plots</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dsfile</span> <span class="ow">in</span> <span class="n">ds_files</span><span class="p">:</span>
            <span class="n">plot_file</span> <span class="o">=</span> <span class="n">make_ds_plot</span><span class="p">(</span>
                <span class="p">[</span><span class="n">dsfile</span><span class="p">],</span>
                <span class="n">plot_file</span><span class="o">=</span><span class="n">dsfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.npy&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">showgui</span><span class="o">=</span><span class="n">showgui</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plot_file</span> <span class="o">=</span> <span class="n">make_ds_plot</span><span class="p">(</span>
            <span class="n">ds_files</span><span class="p">,</span> <span class="n">plot_file</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workdir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">ds_file_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">showgui</span><span class="o">=</span><span class="n">showgui</span>
        <span class="p">)</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="n">goes_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workdir</span><span class="si">}</span><span class="s2">/sci*.nc&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">goes_files</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">workdir</span><span class="si">}</span><span class="s2">/dask-scratch-space </span><span class="si">{</span><span class="n">workdir</span><span class="si">}</span><span class="s2">/tmp&quot;</span><span class="p">)</span>
    <span class="k">return</span></div>



<div class="viewcode-block" id="plot_goes_full_timeseries">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.plot_goes_full_timeseries">[docs]</a>
<span class="k">def</span> <span class="nf">plot_goes_full_timeseries</span><span class="p">(</span>
    <span class="n">msname</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">plot_file_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="n">showgui</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot GOES full time series on the day of observation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Measurement set</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Work directory</span>
<span class="sd">    plot_file_prefix : str, optional</span>
<span class="sd">        Plot file name prefix</span>
<span class="sd">    extension : str, optional</span>
<span class="sd">        Save file extension</span>
<span class="sd">    showgui : bool, optional</span>
<span class="sd">        Show GUI</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Plot file name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">showgui</span><span class="p">:</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;Agg&quot;</span><span class="p">)</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
    <span class="n">scans</span><span class="p">,</span> <span class="n">cal_scans</span><span class="p">,</span> <span class="n">f_scans</span><span class="p">,</span> <span class="n">g_scans</span><span class="p">,</span> <span class="n">p_scans</span> <span class="o">=</span> <span class="n">get_cal_target_scans</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">valid_scans</span> <span class="o">=</span> <span class="n">get_valid_scans</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">filtered_scans</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">valid_scans</span><span class="p">:</span>
            <span class="n">filtered_scans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">tstart_mjd</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">timesforscan</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">filtered_scans</span><span class="p">))))</span>
    <span class="n">tend_mjd</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">timesforscan</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">filtered_scans</span><span class="p">))))</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">tstart</span> <span class="o">=</span> <span class="n">mjdsec_to_timestamp</span><span class="p">(</span><span class="n">tstart_mjd</span><span class="p">,</span> <span class="n">str_format</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">tend</span> <span class="o">=</span> <span class="n">mjdsec_to_timestamp</span><span class="p">(</span><span class="n">tend_mjd</span><span class="p">,</span> <span class="n">str_format</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time range: </span><span class="si">{</span><span class="n">tstart</span><span class="si">}</span><span class="s2">~</span><span class="si">{</span><span class="n">tend</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">Fido</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
        <span class="n">a</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tend</span><span class="p">),</span> <span class="n">a</span><span class="o">.</span><span class="n">Instrument</span><span class="p">(</span><span class="s2">&quot;XRS&quot;</span><span class="p">),</span> <span class="n">a</span><span class="o">.</span><span class="n">Resolution</span><span class="p">(</span><span class="s2">&quot;avg1m&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">Fido</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">goes_tseries</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">TimeSeries</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">concatenate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">goes_tseries</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">goes_tseries</span><span class="o">.</span><span class="n">time</span>
    <span class="n">times_dt</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tend</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">times_dt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">times_dt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="c1"># Save or show</span>
    <span class="k">if</span> <span class="n">plot_file_prefix</span><span class="p">:</span>
        <span class="n">plot_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workdir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">plot_file_prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_file</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plot saved: </span><span class="si">{</span><span class="n">plot_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plot_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">showgui</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plot_file</span></div>



<div class="viewcode-block" id="get_suvi_map">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_suvi_map">[docs]</a>
<span class="k">def</span> <span class="nf">get_suvi_map</span><span class="p">(</span><span class="n">obs_date</span><span class="p">,</span> <span class="n">obs_time</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">wavelength</span><span class="o">=</span><span class="mi">195</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get GOES SUVI map</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obs_date : str</span>
<span class="sd">        Observation date in yyyy-mm-dd format</span>
<span class="sd">    obs_time : str</span>
<span class="sd">        Observation time in hh:mm format</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Work directory</span>
<span class="sd">    wavelength : float, optional</span>
<span class="sd">        Wavelength, options: 94, 131, 171, 195, 284, 304 Å</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sunpy.map</span>
<span class="sd">        Sunpy SUVIMap</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obs_date</span><span class="si">}</span><span class="s2">T</span><span class="si">{</span><span class="n">obs_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">t_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M&quot;</span><span class="p">)</span>
    <span class="n">t_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M&quot;</span><span class="p">)</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span><span class="p">)</span>
    <span class="n">instrument</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Instrument</span><span class="p">(</span><span class="s2">&quot;suvi&quot;</span><span class="p">)</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Wavelength</span><span class="p">(</span><span class="n">wavelength</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">Fido</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">Level</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">downloaded_files</span> <span class="o">=</span> <span class="n">Fido</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">workdir</span><span class="p">)</span>
    <span class="n">obs_times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">downloaded_files</span><span class="p">:</span>
        <span class="n">suvimap</span> <span class="o">=</span> <span class="n">Map</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">dateobs</span> <span class="o">=</span> <span class="n">suvimap</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;date-obs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">obs_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dateobs</span><span class="p">)</span>
    <span class="n">times_dt</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">obs_times</span><span class="p">]</span>
    <span class="n">closest_time</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">times_dt</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">times_dt</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">closest_time</span><span class="p">)</span>
    <span class="n">closest_time_str</span> <span class="o">=</span> <span class="n">closest_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M&quot;</span><span class="p">)</span>
    <span class="n">final_image</span> <span class="o">=</span> <span class="n">downloaded_files</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
    <span class="n">suvi_map</span> <span class="o">=</span> <span class="n">Map</span><span class="p">(</span><span class="n">final_image</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">downloaded_files</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">suvi_map</span></div>



<div class="viewcode-block" id="enhance_offlimb">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.enhance_offlimb">[docs]</a>
<span class="k">def</span> <span class="nf">enhance_offlimb</span><span class="p">(</span><span class="n">sunpy_map</span><span class="p">,</span> <span class="n">do_sharpen</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enhance off-disk emission</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sunpy_map : sunpy.map</span>
<span class="sd">        Sunpy map</span>
<span class="sd">    do_sharpen : bool, optional</span>
<span class="sd">        Sharpen images</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sunpy.map</span>
<span class="sd">        Off-disk enhanced emission</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hpc_coords</span> <span class="o">=</span> <span class="n">all_coordinates_from_map</span><span class="p">(</span><span class="n">sunpy_map</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">hpc_coords</span><span class="o">.</span><span class="n">Tx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">hpc_coords</span><span class="o">.</span><span class="n">Ty</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sunpy_map</span><span class="o">.</span><span class="n">rsun_obs</span>
    <span class="n">rsun_step_size</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">rsun_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">rsun_step_size</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">sunpy_map</span><span class="o">.</span><span class="n">data</span><span class="p">[(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="n">this_r</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">this_r</span> <span class="o">+</span> <span class="n">rsun_step_size</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">this_r</span> <span class="ow">in</span> <span class="n">rsun_array</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mf">10e-3</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">r_lim</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">rsun_array</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span>
        <span class="n">rsun_array</span><span class="p">[</span><span class="n">rsun_array</span> <span class="o">&lt;</span> <span class="n">r_lim</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">rsun_array</span> <span class="o">&lt;</span> <span class="n">r_lim</span><span class="p">]),</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">r</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">scale_factor</span><span class="p">[</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">do_sharpen</span><span class="p">:</span>
        <span class="n">blurred</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">sunpy_map</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sunpy_map</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span> <span class="p">(</span><span class="n">sunpy_map</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">blurred</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sunpy_map</span><span class="o">.</span><span class="n">data</span>
    <span class="n">scaled_map</span> <span class="o">=</span> <span class="n">sunpy</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">data</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="n">sunpy_map</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>
    <span class="n">scaled_map</span><span class="o">.</span><span class="n">plot_settings</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">LogStretch</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">scaled_map</span></div>



<div class="viewcode-block" id="make_meer_overlay">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.make_meer_overlay">[docs]</a>
<span class="k">def</span> <span class="nf">make_meer_overlay</span><span class="p">(</span>
    <span class="n">meerkat_image</span><span class="p">,</span>
    <span class="n">workdir</span><span class="p">,</span>
    <span class="n">suvi_wavelength</span><span class="o">=</span><span class="mi">195</span><span class="p">,</span>
    <span class="n">plot_file_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_meer_colormap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">enhance_offdisk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">contour_levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span>
    <span class="n">do_sharpen_suvi</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1600</span><span class="p">,</span> <span class="mi">1600</span><span class="p">],</span>
    <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1600</span><span class="p">,</span> <span class="mi">1600</span><span class="p">],</span>
    <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span>
    <span class="n">showgui</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make overlay of MeerKAT image on GOES SUVI image</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    meerkat_image : str</span>
<span class="sd">        MeerKAT image</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Work directory</span>
<span class="sd">    suvi_wavelength : float, optional</span>
<span class="sd">        GOES SUVI wavelength, options: 94, 131, 171, 195, 284, 304 Å</span>
<span class="sd">    plot_file_prefix : str, optional</span>
<span class="sd">        Plot file prefix name</span>
<span class="sd">    plot_meer_colormap : bool, optional</span>
<span class="sd">        Plot MeerKAT map colormap</span>
<span class="sd">    enhance_offdisk : bool, optional</span>
<span class="sd">        Enhance off-disk emission</span>
<span class="sd">    contour_levels : list, optional</span>
<span class="sd">        Contour levels in fraction of peak</span>
<span class="sd">    do_sharpen_suvi : bool, optional</span>
<span class="sd">        Do sharpen SUVI images</span>
<span class="sd">    xlim : list, optional</span>
<span class="sd">        X-axis limit in arcsec</span>
<span class="sd">    tlim : list, optional</span>
<span class="sd">        Y-axis limit in arcsec</span>
<span class="sd">    extension : str, optional</span>
<span class="sd">        Image file extension</span>
<span class="sd">    showgui : bool, optional</span>
<span class="sd">        Show GUI</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Plot file name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">showgui</span><span class="p">:</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;Agg&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">meermap</span> <span class="o">=</span> <span class="n">get_meermap</span><span class="p">(</span><span class="n">meerkat_image</span><span class="p">)</span>
    <span class="n">obs_datetime</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">meerkat_image</span><span class="p">)[</span><span class="s2">&quot;DATE-OBS&quot;</span><span class="p">]</span>
    <span class="n">obs_date</span> <span class="o">=</span> <span class="n">obs_datetime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">obs_time</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">obs_datetime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">suvi_map</span> <span class="o">=</span> <span class="n">get_suvi_map</span><span class="p">(</span><span class="n">obs_date</span><span class="p">,</span> <span class="n">obs_time</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">wavelength</span><span class="o">=</span><span class="n">suvi_wavelength</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">enhance_offdisk</span><span class="p">:</span>
        <span class="n">suvi_map</span> <span class="o">=</span> <span class="n">enhance_offlimb</span><span class="p">(</span><span class="n">suvi_map</span><span class="p">,</span> <span class="n">do_sharpen</span><span class="o">=</span><span class="n">do_sharpen_suvi</span><span class="p">)</span>
    <span class="n">projected_coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
        <span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span>
        <span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span>
        <span class="n">obstime</span><span class="o">=</span><span class="n">suvi_map</span><span class="o">.</span><span class="n">observer_coordinate</span><span class="o">.</span><span class="n">obstime</span><span class="p">,</span>
        <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;helioprojective&quot;</span><span class="p">,</span>
        <span class="n">observer</span><span class="o">=</span><span class="n">suvi_map</span><span class="o">.</span><span class="n">observer_coordinate</span><span class="p">,</span>
        <span class="n">rsun</span><span class="o">=</span><span class="n">suvi_map</span><span class="o">.</span><span class="n">coordinate_frame</span><span class="o">.</span><span class="n">rsun</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">projected_header</span> <span class="o">=</span> <span class="n">sunpy</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">make_fitswcs_header</span><span class="p">(</span>
        <span class="n">suvi_map</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
        <span class="n">projected_coord</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">suvi_map</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span>
        <span class="n">instrument</span><span class="o">=</span><span class="n">suvi_map</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span>
        <span class="n">wavelength</span><span class="o">=</span><span class="n">suvi_map</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="n">SphericalScreen</span><span class="p">(</span><span class="n">meermap</span><span class="o">.</span><span class="n">observer_coordinate</span><span class="p">):</span>
        <span class="n">meer_reprojected</span> <span class="o">=</span> <span class="n">meermap</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="n">projected_header</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">SphericalScreen</span><span class="p">(</span><span class="n">suvi_map</span><span class="o">.</span><span class="n">observer_coordinate</span><span class="p">):</span>
        <span class="n">suvi_reprojected</span> <span class="o">=</span> <span class="n">suvi_map</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="n">projected_header</span><span class="p">)</span>
    <span class="n">meertime</span> <span class="o">=</span> <span class="n">meermap</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;date-obs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">suvitime</span> <span class="o">=</span> <span class="n">suvi_map</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;date-obs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">plot_meer_colormap</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">contour_levels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">})</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">ax_colormap</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">suvi_reprojected</span><span class="p">)</span>
        <span class="n">ax_contour</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">suvi_reprojected</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plot_meer_colormap</span><span class="p">:</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">ax_colormap</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">suvi_reprojected</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">contour_levels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">ax_contour</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">suvi_reprojected</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No overlay is plotting.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SUVI time: </span><span class="si">{</span><span class="n">suvitime</span><span class="si">}</span><span class="se">\n</span><span class="s2"> MeerKAT time: </span><span class="si">{</span><span class="n">meertime</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;transparent_inferno&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plt</span><span class="o">.</span><span class="n">colormaps</span><span class="p">():</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;inferno&quot;</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">x</span><span class="p">))</span>
        <span class="n">colors</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span>  <span class="c1"># Update the alpha channel</span>
        <span class="n">transparent_inferno</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colormaps</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;transparent_inferno&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">transparent_inferno</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_meer_colormap</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">contour_levels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">suptitle</span> <span class="o">=</span> <span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">suptitle</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_meer_colormap</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">suvi_reprojected</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">axes</span><span class="o">=</span><span class="n">ax_colormap</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">autoalign</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">clip_interval</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">percent</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="n">z</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">z</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">meer_reprojected</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">axes</span><span class="o">=</span><span class="n">ax_colormap</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">clip_interval</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">percent</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;transparent_inferno&quot;</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="n">z</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contour_levels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">suvi_reprojected</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">axes</span><span class="o">=</span><span class="n">ax_contour</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="n">autoalign</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">clip_interval</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">percent</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="n">z</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">z</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">contour_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">contour_levels</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">meer_reprojected</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">meer_reprojected</span><span class="o">.</span><span class="n">draw_contours</span><span class="p">(</span>
            <span class="n">contour_levels</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax_contour</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;YlGnBu&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="n">z</span>
        <span class="p">)</span>
        <span class="n">ax_contour</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">x_pix_limits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xlim</span><span class="p">:</span>
            <span class="n">sky</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                <span class="n">x</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">suvi_reprojected</span><span class="o">.</span><span class="n">coordinate_frame</span>
            <span class="p">)</span>
            <span class="n">x_pix</span> <span class="o">=</span> <span class="n">suvi_reprojected</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">sky</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">x_pix_limits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_pix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_meer_colormap</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">contour_levels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax_colormap</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x_pix_limits</span><span class="p">)</span>
            <span class="n">ax_contour</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x_pix_limits</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plot_meer_colormap</span><span class="p">:</span>
            <span class="n">ax_colormap</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x_pix_limits</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">contour_levels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax_contour</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x_pix_limits</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">y_pix_limits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ylim</span><span class="p">:</span>
            <span class="n">sky</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                <span class="mi">0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">suvi_reprojected</span><span class="o">.</span><span class="n">coordinate_frame</span>
            <span class="p">)</span>
            <span class="n">y_pix</span> <span class="o">=</span> <span class="n">suvi_reprojected</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">sky</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">y_pix_limits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_pix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_meer_colormap</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">contour_levels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax_colormap</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_pix_limits</span><span class="p">)</span>
            <span class="n">ax_contour</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_pix_limits</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plot_meer_colormap</span><span class="p">:</span>
            <span class="n">ax_colormap</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_pix_limits</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">contour_levels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax_contour</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_pix_limits</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_meer_colormap</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">contour_levels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax_colormap</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_contour</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plot_meer_colormap</span><span class="p">:</span>
        <span class="n">ax_colormap</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">contour_levels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax_contour</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">plot_file_prefix</span><span class="p">:</span>
        <span class="n">plot_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workdir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">plot_file_prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_file</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#######################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plot saved: </span><span class="si">{</span><span class="n">plot_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#######################</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plot_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">showgui</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plot_file</span></div>



<div class="viewcode-block" id="split_noise_diode_scans">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.split_noise_diode_scans">[docs]</a>
<span class="k">def</span> <span class="nf">split_noise_diode_scans</span><span class="p">(</span>
    <span class="n">msname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">noise_on_ms</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">noise_off_ms</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">field</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">scan</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">datacolumn</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
    <span class="n">n_threads</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split noise diode on and off timestamps into two seperate measurement sets</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Measurement set</span>
<span class="sd">    noise_on_ms : str, optional</span>
<span class="sd">        Noise diode on ms</span>
<span class="sd">    noise_off_ms : str, optional</span>
<span class="sd">        Noise diode off ms</span>
<span class="sd">    field : str, optional</span>
<span class="sd">        Field name or id</span>
<span class="sd">    scan : str, optional</span>
<span class="sd">        Scan number</span>
<span class="sd">    datacolumn : str, optional</span>
<span class="sd">        Data column to split</span>
<span class="sd">    n_threads : int, optional</span>
<span class="sd">        Number of OpenMP threads</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        splited ms names</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">limit_threads</span><span class="p">(</span><span class="n">n_threads</span><span class="o">=</span><span class="n">n_threads</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">split</span>

    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># in GB</span>
        <span class="k">return</span> <span class="n">mem</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">mspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">mspath</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spliting ms: </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="s2"> into noise diode on and off measurement sets.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">noise_on_ms</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">noise_on_ms</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.ms&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_noise_on.ms&quot;</span>
    <span class="k">if</span> <span class="n">noise_off_ms</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">noise_off_ms</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.ms&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_noise_off.ms&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">noise_on_ms</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">noise_on_ms</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">noise_on_ms</span> <span class="o">+</span> <span class="s2">&quot;.flagversions&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">noise_on_ms</span> <span class="o">+</span> <span class="s2">&quot;.flagversions&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">noise_off_ms</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">noise_off_ms</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">noise_off_ms</span> <span class="o">+</span> <span class="s2">&quot;.flagversions&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">noise_off_ms</span> <span class="o">+</span> <span class="s2">&quot;.flagversions&quot;</span><span class="p">)</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">table</span><span class="p">()</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;TIME&quot;</span><span class="p">)</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">unique_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="n">even_times</span> <span class="o">=</span> <span class="n">unique_times</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Even-indexed timestamps</span>
    <span class="n">odd_times</span> <span class="o">=</span> <span class="n">unique_times</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Odd-indexed timestamps</span>
    <span class="n">even_timerange</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span><span class="n">mjdsec_to_timestamp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">str_format</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">even_times</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">odd_timerange</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">mjdsec_to_timestamp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">str_format</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">odd_times</span><span class="p">])</span>
    <span class="n">even_ms</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.ms&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_even.ms&quot;</span>
    <span class="n">odd_ms</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.ms&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_odd.ms&quot;</span>
    <span class="n">split</span><span class="p">(</span>
        <span class="n">vis</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span>
        <span class="n">outputvis</span><span class="o">=</span><span class="n">even_ms</span><span class="p">,</span>
        <span class="n">timerange</span><span class="o">=</span><span class="n">even_timerange</span><span class="p">,</span>
        <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
        <span class="n">scan</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span>
        <span class="n">datacolumn</span><span class="o">=</span><span class="n">datacolumn</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">split</span><span class="p">(</span>
        <span class="n">vis</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span>
        <span class="n">outputvis</span><span class="o">=</span><span class="n">odd_ms</span><span class="p">,</span>
        <span class="n">timerange</span><span class="o">=</span><span class="n">odd_timerange</span><span class="p">,</span>
        <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
        <span class="n">scan</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span>
        <span class="n">datacolumn</span><span class="o">=</span><span class="n">datacolumn</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">mstool</span> <span class="o">=</span> <span class="n">casamstool</span><span class="p">()</span>
    <span class="n">mstool</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">even_ms</span><span class="p">)</span>
    <span class="n">mstool</span><span class="o">.</span><span class="n">select</span><span class="p">({</span><span class="s2">&quot;antenna1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;antenna2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
    <span class="n">even_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mstool</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="s2">&quot;DATA&quot;</span><span class="p">)[</span><span class="s2">&quot;data&quot;</span><span class="p">]))</span>
    <span class="n">mstool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">mstool</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">odd_ms</span><span class="p">)</span>
    <span class="n">mstool</span><span class="o">.</span><span class="n">select</span><span class="p">({</span><span class="s2">&quot;antenna1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;antenna2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
    <span class="n">odd_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mstool</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="s2">&quot;DATA&quot;</span><span class="p">)[</span><span class="s2">&quot;data&quot;</span><span class="p">]))</span>
    <span class="n">mstool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">even_data</span> <span class="o">&gt;</span> <span class="n">odd_data</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mv &quot;</span> <span class="o">+</span> <span class="n">even_ms</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">noise_on_ms</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mv &quot;</span> <span class="o">+</span> <span class="n">odd_ms</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">noise_off_ms</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mv &quot;</span> <span class="o">+</span> <span class="n">odd_ms</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">noise_on_ms</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mv &quot;</span> <span class="o">+</span> <span class="n">even_ms</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">noise_off_ms</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">noise_on_ms</span><span class="p">,</span> <span class="n">noise_off_ms</span></div>



<div class="viewcode-block" id="get_band_name">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_band_name">[docs]</a>
<span class="k">def</span> <span class="nf">get_band_name</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get band name</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the ms</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Band name (&#39;U&#39;,&#39;L&#39;,&#39;S&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">meanfreq</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">meanfreq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mi">544</span> <span class="ow">and</span> <span class="n">meanfreq</span> <span class="o">&lt;=</span> <span class="mi">1088</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;U&quot;</span>
    <span class="k">elif</span> <span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mi">856</span> <span class="ow">and</span> <span class="n">meanfreq</span> <span class="o">&lt;=</span> <span class="mi">1712</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;L&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;S&quot;</span></div>



<div class="viewcode-block" id="get_bad_chans">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_bad_chans">[docs]</a>
<span class="k">def</span> <span class="nf">get_bad_chans</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get bad channels to flag</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the ms</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        SPW string of bad channels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">chanfreqs</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanfreqs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">bandname</span> <span class="o">=</span> <span class="n">get_band_name</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bandname</span> <span class="o">==</span> <span class="s2">&quot;U&quot;</span><span class="p">:</span>
        <span class="n">bad_freqs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">580</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">925</span><span class="p">,</span> <span class="mi">960</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">1010</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="k">elif</span> <span class="n">bandname</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span>
        <span class="n">bad_freqs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">879</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">925</span><span class="p">,</span> <span class="mi">960</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">1166</span><span class="p">,</span> <span class="mi">1186</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">1217</span><span class="p">,</span> <span class="mi">1237</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">1242</span><span class="p">,</span> <span class="mi">1249</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">1375</span><span class="p">,</span> <span class="mi">1387</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">1526</span><span class="p">,</span> <span class="mi">1626</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">1681</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data is not in UHF or L-band.&quot;</span><span class="p">)</span>
        <span class="n">bad_freqs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spw</span> <span class="o">=</span> <span class="s2">&quot;0:&quot;</span>
    <span class="k">for</span> <span class="n">freq_range</span> <span class="ow">in</span> <span class="n">bad_freqs</span><span class="p">:</span>
        <span class="n">start_freq</span> <span class="o">=</span> <span class="n">freq_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">end_freq</span> <span class="o">=</span> <span class="n">freq_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">start_freq</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">start_chan</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_chan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">start_freq</span> <span class="o">-</span> <span class="n">chanfreqs</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">end_freq</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">end_chan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chanfreqs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end_chan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">end_freq</span> <span class="o">-</span> <span class="n">chanfreqs</span><span class="p">))</span>
        <span class="n">spw</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_chan</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;~&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_chan</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span>
    <span class="n">spw</span> <span class="o">=</span> <span class="n">spw</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">spw</span></div>



<div class="viewcode-block" id="get_good_chans">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_good_chans">[docs]</a>
<span class="k">def</span> <span class="nf">get_good_chans</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get good channel range to perform gaincal</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the ms</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        SPW string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">chanfreqs</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanfreqs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
    <span class="n">meanfreq</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">meanfreq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">bandname</span> <span class="o">=</span> <span class="n">get_band_name</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bandname</span> <span class="o">==</span> <span class="s2">&quot;U&quot;</span><span class="p">:</span>
        <span class="n">good_freqs</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">580</span><span class="p">,</span> <span class="mi">620</span><span class="p">)]</span>  <span class="c1"># For UHF band</span>
    <span class="k">elif</span> <span class="n">bandname</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span>
        <span class="n">good_freqs</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">890</span><span class="p">,</span> <span class="mi">920</span><span class="p">)]</span>  <span class="c1"># For L band</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">good_freqs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># For S band #TODO: fill it</span>
    <span class="n">spw</span> <span class="o">=</span> <span class="s2">&quot;0:&quot;</span>
    <span class="k">for</span> <span class="n">freq_range</span> <span class="ow">in</span> <span class="n">good_freqs</span><span class="p">:</span>
        <span class="n">start_freq</span> <span class="o">=</span> <span class="n">freq_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">end_freq</span> <span class="o">=</span> <span class="n">freq_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">start_chan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">start_freq</span> <span class="o">-</span> <span class="n">chanfreqs</span><span class="p">))</span>
        <span class="n">end_chan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">end_freq</span> <span class="o">-</span> <span class="n">chanfreqs</span><span class="p">))</span>
        <span class="n">spw</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_chan</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;~&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_chan</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span>
    <span class="n">spw</span> <span class="o">=</span> <span class="n">spw</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">spw</span></div>



<div class="viewcode-block" id="get_bad_ants">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_bad_ants">[docs]</a>
<span class="k">def</span> <span class="nf">get_bad_ants</span><span class="p">(</span><span class="n">msname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="p">[],</span> <span class="n">n_threads</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get bad antennas</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the ms</span>
<span class="sd">    fieldnames : list, optional</span>
<span class="sd">        Fluxcal field names</span>
<span class="sd">    n_threads : int, optional</span>
<span class="sd">        Number of OpenMP threads</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Bad antenna list</span>
<span class="sd">    str</span>
<span class="sd">        Bad antenna string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">limit_threads</span><span class="p">(</span><span class="n">n_threads</span><span class="o">=</span><span class="n">n_threads</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">visstat</span>

    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># in GB</span>
        <span class="k">return</span> <span class="n">mem</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">mspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">mspath</span><span class="p">)</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">good_chan</span> <span class="o">=</span> <span class="n">get_good_chans</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">all_field_bad_ants</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">nant</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">nantennas</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fieldnames</span><span class="p">:</span>
        <span class="n">ant_means</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bad_ants</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ant</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nant</span><span class="p">):</span>
            <span class="n">stat_mean</span> <span class="o">=</span> <span class="n">visstat</span><span class="p">(</span>
                <span class="n">vis</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span>
                <span class="n">field</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">),</span>
                <span class="n">uvrange</span><span class="o">=</span><span class="s2">&quot;0lambda&quot;</span><span class="p">,</span>
                <span class="n">spw</span><span class="o">=</span><span class="n">good_chan</span><span class="p">,</span>
                <span class="n">antenna</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ant</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&amp;&amp;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ant</span><span class="p">),</span>
                <span class="n">useflags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)[</span><span class="s2">&quot;DATA_DESC_ID=0&quot;</span><span class="p">][</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span>
            <span class="n">ant_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stat_mean</span><span class="p">)</span>
        <span class="n">ant_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ant_means</span><span class="p">)</span>
        <span class="n">all_ant_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">ant_means</span><span class="p">)</span>
        <span class="n">all_ant_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">ant_means</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ant_means</span> <span class="o">&lt;</span> <span class="n">all_ant_mean</span> <span class="o">-</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">all_ant_std</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">b_ant</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
                <span class="n">bad_ants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b_ant</span><span class="p">)</span>
        <span class="n">all_field_bad_ants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bad_ants</span><span class="p">)</span>
    <span class="n">bad_ants</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">all_field_bad_ants</span><span class="p">]</span>
    <span class="n">common_elements</span> <span class="o">=</span> <span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="n">bad_ants</span><span class="p">)</span>
    <span class="n">bad_ants</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">common_elements</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_ants</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">bad_ants_str</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bad_ants</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bad_ants_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">return</span> <span class="n">bad_ants</span><span class="p">,</span> <span class="n">bad_ants_str</span></div>



<div class="viewcode-block" id="get_common_spw">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_common_spw">[docs]</a>
<span class="k">def</span> <span class="nf">get_common_spw</span><span class="p">(</span><span class="n">spw1</span><span class="p">,</span> <span class="n">spw2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return common spectral windows in merged CASA string format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spw1 : str</span>
<span class="sd">        First spectral window</span>
<span class="sd">    spw2 : str</span>
<span class="sd">        Second spectral window</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Merged spectral window</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">groupby</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

    <span class="k">def</span> <span class="nf">to_set</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">cur</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
                <span class="n">cur</span><span class="p">,</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rng</span> <span class="o">=</span> <span class="n">part</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
            <span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">rng</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">))</span>
            <span class="n">out</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">cur</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">b</span> <span class="k">else</span> <span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">to_str</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
        <span class="n">spw_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">spw</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
            <span class="n">spw_dict</span><span class="p">[</span><span class="n">spw</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">spw</span><span class="p">,</span> <span class="n">chans</span> <span class="ow">in</span> <span class="n">spw_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">chans</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">chans</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">grp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">grp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">grp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">~</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;0:&quot;</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">to_str</span><span class="p">(</span><span class="n">to_set</span><span class="p">(</span><span class="n">spw1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">to_set</span><span class="p">(</span><span class="n">spw2</span><span class="p">))</span></div>



<div class="viewcode-block" id="scans_in_timerange">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.scans_in_timerange">[docs]</a>
<span class="k">def</span> <span class="nf">scans_in_timerange</span><span class="p">(</span><span class="n">msname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">timerange</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get scans in the given timerange</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Measurement set</span>
<span class="sd">    timerange : str</span>
<span class="sd">        Time range with date and time</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Scan dict for timerange</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">ms</span><span class="p">,</span> <span class="n">quanta</span>

    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># in GB</span>
        <span class="k">return</span> <span class="n">mem</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">mspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">mspath</span><span class="p">)</span>
    <span class="n">qa</span> <span class="o">=</span> <span class="n">quanta</span><span class="p">()</span>
    <span class="n">ms_tool</span> <span class="o">=</span> <span class="n">ms</span><span class="p">()</span>
    <span class="n">ms_tool</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="c1"># Get scan summary</span>
    <span class="n">scan_summary</span> <span class="o">=</span> <span class="n">ms_tool</span><span class="o">.</span><span class="n">getscansummary</span><span class="p">()</span>
    <span class="c1"># Convert input timerange to MJD seconds</span>
    <span class="n">timerange_list</span> <span class="o">=</span> <span class="n">timerange</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="n">valid_scans</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">timerange</span> <span class="ow">in</span> <span class="n">timerange_list</span><span class="p">:</span>
        <span class="n">tr_start_str</span><span class="p">,</span> <span class="n">tr_end_str</span> <span class="o">=</span> <span class="n">timerange</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span>
        <span class="n">tr_start</span> <span class="o">=</span> <span class="n">timestamp_to_mjdsec</span><span class="p">(</span><span class="n">tr_start_str</span><span class="p">)</span>  <span class="c1"># Try parsing as date string</span>
        <span class="n">tr_end</span> <span class="o">=</span> <span class="n">timestamp_to_mjdsec</span><span class="p">(</span><span class="n">tr_end_str</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">scan_id</span><span class="p">,</span> <span class="n">scan_info</span> <span class="ow">in</span> <span class="n">scan_summary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">t0_str</span> <span class="o">=</span> <span class="n">scan_info</span><span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">][</span><span class="s2">&quot;BeginTime&quot;</span><span class="p">]</span>
            <span class="n">t1_str</span> <span class="o">=</span> <span class="n">scan_info</span><span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">][</span><span class="s2">&quot;EndTime&quot;</span><span class="p">]</span>
            <span class="n">scan_start</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">t0_str</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">),</span> <span class="s2">&quot;s&quot;</span><span class="p">)[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
            <span class="n">scan_end</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">t1_str</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">),</span> <span class="s2">&quot;s&quot;</span><span class="p">)[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
            <span class="c1"># Check overlap</span>
            <span class="k">if</span> <span class="n">scan_end</span> <span class="o">&gt;=</span> <span class="n">tr_start</span> <span class="ow">and</span> <span class="n">scan_start</span> <span class="o">&lt;=</span> <span class="n">tr_end</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tr_end</span> <span class="o">&gt;=</span> <span class="n">scan_end</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">scan_end</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">tr_end</span>
                <span class="k">if</span> <span class="n">tr_start</span> <span class="o">&lt;=</span> <span class="n">scan_start</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">scan_start</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">tr_start</span>
                <span class="k">if</span> <span class="n">scan_id</span> <span class="ow">in</span> <span class="n">valid_scans</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">old_t</span> <span class="o">=</span> <span class="n">valid_scans</span><span class="p">[</span><span class="n">scan_id</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span>
                    <span class="n">old_s</span> <span class="o">=</span> <span class="n">timestamp_to_mjdsec</span><span class="p">(</span><span class="n">old_t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">old_e</span> <span class="o">=</span> <span class="n">timestamp_to_mjdsec</span><span class="p">(</span><span class="n">old_t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="n">old_s</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">old_s</span>
                    <span class="k">if</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="n">old_e</span><span class="p">:</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="n">old_e</span>
                <span class="n">valid_scans</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">scan_id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">mjdsec_to_timestamp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">str_format</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;~&quot;</span>
                    <span class="o">+</span> <span class="n">mjdsec_to_timestamp</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">str_format</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
    <span class="n">ms_tool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">valid_scans</span></div>



<div class="viewcode-block" id="get_refant">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_refant">[docs]</a>
<span class="k">def</span> <span class="nf">get_refant</span><span class="p">(</span><span class="n">msname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">n_threads</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get reference antenna</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    n_threads : int, optional</span>
<span class="sd">        Number of OpenMP threads</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Reference antenna</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">limit_threads</span><span class="p">(</span><span class="n">n_threads</span><span class="o">=</span><span class="n">n_threads</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">visstat</span>

    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># in GB</span>
        <span class="k">return</span> <span class="n">mem</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">mspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">mspath</span><span class="p">)</span>
    <span class="n">casalog</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s2">&quot;SEVERE&quot;</span><span class="p">)</span>
    <span class="n">fluxcal_fields</span><span class="p">,</span> <span class="n">fluxcal_scans</span> <span class="o">=</span> <span class="n">get_fluxcals</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">nant</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">nantennas</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">antamp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">antrms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ant</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nant</span><span class="p">):</span>
        <span class="n">ant</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ant</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">visstat</span><span class="p">(</span>
            <span class="n">vis</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span>
            <span class="n">field</span><span class="o">=</span><span class="n">fluxcal_fields</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">antenna</span><span class="o">=</span><span class="n">ant</span><span class="p">,</span>
            <span class="n">timeaverage</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">timebin</span><span class="o">=</span><span class="s2">&quot;500min&quot;</span><span class="p">,</span>
            <span class="n">timespan</span><span class="o">=</span><span class="s2">&quot;state,scan&quot;</span><span class="p">,</span>
            <span class="n">reportingaxes</span><span class="o">=</span><span class="s2">&quot;field&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">amp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">])</span>
        <span class="n">rms</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="s2">&quot;rms&quot;</span><span class="p">])</span>
        <span class="n">antamp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span>
        <span class="n">antrms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rms</span><span class="p">)</span>
    <span class="n">antamp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">antamp</span><span class="p">)</span>
    <span class="n">antrms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">antrms</span><span class="p">)</span>
    <span class="n">medamp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">antamp</span><span class="p">)</span>
    <span class="n">medrms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">antrms</span><span class="p">)</span>
    <span class="n">goodrms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">goodamp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">goodant</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">antamp</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">antamp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">medamp</span><span class="p">:</span>
            <span class="n">goodant</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">goodamp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">antamp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">goodrms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">antrms</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">goodrms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">goodrms</span><span class="p">)</span>
    <span class="n">referenceant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">goodrms</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">referenceant</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_submsname_scans">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_submsname_scans">[docs]</a>
<span class="k">def</span> <span class="nf">get_submsname_scans</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get sub-MS names for each scans of an multi-MS</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        msname list</span>
<span class="sd">    list</span>
<span class="sd">        scan list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">msname</span> <span class="o">+</span> <span class="s2">&quot;/SUBMSS&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Input measurement set is not a multi-MS&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">partitionlist</span> <span class="o">=</span> <span class="n">listpartition</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span> <span class="n">createdict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">scans</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mslist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">partitionlist</span><span class="p">)):</span>
        <span class="n">subms</span> <span class="o">=</span> <span class="n">partitionlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">subms_name</span> <span class="o">=</span> <span class="n">msname</span> <span class="o">+</span> <span class="s2">&quot;/SUBMSS/&quot;</span> <span class="o">+</span> <span class="n">subms</span><span class="p">[</span><span class="s2">&quot;MS&quot;</span><span class="p">]</span>
        <span class="n">mslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subms_name</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">subms_name</span><span class="si">}</span><span class="s2">/.flagversions&quot;</span><span class="p">)</span>
        <span class="n">scan_number</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">subms</span><span class="p">[</span><span class="s2">&quot;scanId&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">scans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan_number</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mslist</span><span class="p">,</span> <span class="n">scans</span></div>



<div class="viewcode-block" id="get_chans_flag">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_chans_flag">[docs]</a>
<span class="k">def</span> <span class="nf">get_chans_flag</span><span class="p">(</span><span class="n">msname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">n_threads</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get flag/unflag channel list</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Measurement set name</span>
<span class="sd">    field : str, optional</span>
<span class="sd">        Field name or ID</span>
<span class="sd">    n_threads : int, optional</span>
<span class="sd">        Number of OpenMP threads</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Unflag channel list</span>
<span class="sd">    list</span>
<span class="sd">        Flag channel list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">limit_threads</span><span class="p">(</span><span class="n">n_threads</span><span class="o">=</span><span class="n">n_threads</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">flagdata</span>

    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># in GB</span>
        <span class="k">return</span> <span class="n">mem</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">mspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">mspath</span><span class="p">)</span>
    <span class="n">casalog</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s2">&quot;SEVERE&quot;</span><span class="p">)</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">flagdata</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="n">spwchan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">unflag_chans</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">flag_chans</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;spw:channel&quot;</span><span class="p">]:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;spw:channel&quot;</span><span class="p">][</span><span class="n">chan</span><span class="p">]</span>
        <span class="n">chan_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chan</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;0:&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">flag_frac</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;flagged&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">flag_frac</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">flag_chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chan_number</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unflag_chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chan_number</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unflag_chans</span><span class="p">,</span> <span class="n">flag_chans</span></div>



<div class="viewcode-block" id="get_optimal_image_interval">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_optimal_image_interval">[docs]</a>
<span class="k">def</span> <span class="nf">get_optimal_image_interval</span><span class="p">(</span>
    <span class="n">msname</span><span class="p">,</span>
    <span class="n">temporal_tol_factor</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">spectral_tol_factor</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">chan_range</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">timestamp_range</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">max_nchan</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">max_ntime</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get optimal image spectral temporal interval such that total flux max-median in each chunk is within tolerance limit</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    temporal_tol_factor : float, optional</span>
<span class="sd">        Tolerance factor for temporal variation (default : 0.1, 10%)</span>
<span class="sd">    spectral_tol_factor : float, optional</span>
<span class="sd">        Tolerance factor for spectral variation (default : 0.1, 10%)</span>
<span class="sd">    chan_range : str, optional</span>
<span class="sd">        Channel range</span>
<span class="sd">    timestamp_range : str, optional</span>
<span class="sd">        Timestamp range</span>
<span class="sd">    max_nchan : int, optional</span>
<span class="sd">        Maxmium number of spectral chunk</span>
<span class="sd">    max_ntime : int, optional</span>
<span class="sd">        Maximum number of temporal chunk</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Number of time intervals to average</span>
<span class="sd">    int</span>
<span class="sd">        Number of channels to averages</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">is_valid_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">):</span>
        <span class="n">mean_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mean_flux</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span> <span class="o">/</span> <span class="n">mean_flux</span> <span class="o">&lt;=</span> <span class="n">tolerance</span>

    <span class="k">def</span> <span class="nf">find_max_valid_chunk_length</span><span class="p">(</span><span class="n">fluxes</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fluxes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># Try from largest to smallest</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
                <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">window</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">fluxes</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">window</span><span class="p">:</span>  <span class="c1"># Optionally require full window</span>
                    <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">):</span>
                    <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">window</span>  <span class="c1"># Return the largest valid window</span>
        <span class="k">return</span> <span class="mi">1</span>  <span class="c1"># Minimum chunk size is 1 if nothing else is valid</span>

    <span class="n">tb</span> <span class="o">=</span> <span class="n">table</span><span class="p">()</span>
    <span class="n">mstool</span> <span class="o">=</span> <span class="n">casamstool</span><span class="p">()</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">nchan</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">nchan</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">timesforspws</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ntime</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">times</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;UVW&quot;</span><span class="p">)</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">uvdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">mstool</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">uvdist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">mstool</span><span class="o">.</span><span class="n">select</span><span class="p">({</span><span class="s2">&quot;uvdist&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mstool</span><span class="o">.</span><span class="n">select</span><span class="p">({</span><span class="s2">&quot;antenna1&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;antenna2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
    <span class="n">data_and_flag</span> <span class="o">=</span> <span class="n">mstool</span><span class="o">.</span><span class="n">getdata</span><span class="p">([</span><span class="s2">&quot;DATA&quot;</span><span class="p">,</span> <span class="s2">&quot;FLAG&quot;</span><span class="p">],</span> <span class="n">ifraxis</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data_and_flag</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="n">data_and_flag</span><span class="p">[</span><span class="s2">&quot;flag&quot;</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">mstool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">chan_range</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">start_chan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chan_range</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">end_chan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chan_range</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">spectra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="n">start_chan</span><span class="p">:</span><span class="n">end_chan</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spectra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">timestamp_range</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">t_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp_range</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">t_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp_range</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">t_series</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">t_start</span><span class="p">:</span><span class="n">t_end</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t_series</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">t_series</span> <span class="o">=</span> <span class="n">t_series</span><span class="p">[</span><span class="n">t_series</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">spectra</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[</span><span class="n">spectra</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">t_chunksize</span> <span class="o">=</span> <span class="n">find_max_valid_chunk_length</span><span class="p">(</span><span class="n">t_series</span><span class="p">,</span> <span class="n">temporal_tol_factor</span><span class="p">)</span>
    <span class="n">f_chunksize</span> <span class="o">=</span> <span class="n">find_max_valid_chunk_length</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">spectral_tol_factor</span><span class="p">)</span>
    <span class="n">n_time_interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_series</span><span class="p">)</span> <span class="o">/</span> <span class="n">t_chunksize</span><span class="p">)</span>
    <span class="n">n_spectral_interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">)</span> <span class="o">/</span> <span class="n">f_chunksize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_nchan</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_spectral_interval</span> <span class="o">&gt;</span> <span class="n">max_nchan</span><span class="p">:</span>
        <span class="n">n_spectral_interval</span> <span class="o">=</span> <span class="n">max_nchan</span>
    <span class="k">if</span> <span class="n">max_ntime</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_time_interval</span> <span class="o">&gt;</span> <span class="n">max_ntime</span><span class="p">:</span>
        <span class="n">n_time_interval</span> <span class="o">=</span> <span class="n">max_ntime</span>
    <span class="k">return</span> <span class="n">n_time_interval</span><span class="p">,</span> <span class="n">n_spectral_interval</span></div>



<div class="viewcode-block" id="reset_weights_and_flags">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.reset_weights_and_flags">[docs]</a>
<span class="k">def</span> <span class="nf">reset_weights_and_flags</span><span class="p">(</span>
    <span class="n">msname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">restore_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_threads</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">force_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reset weights and flags for the ms</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Measurement set</span>
<span class="sd">    restore_flag : bool, optional</span>
<span class="sd">        Restore flags or not</span>
<span class="sd">    n_threads : int, optional</span>
<span class="sd">        Number of OpenMP threads</span>
<span class="sd">    force_reset : bool, optional</span>
<span class="sd">        Force reset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">limit_threads</span><span class="p">(</span><span class="n">n_threads</span><span class="o">=</span><span class="n">n_threads</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">flagdata</span>

    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># in GB</span>
        <span class="k">return</span> <span class="n">mem</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="s2">/.reset&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">force_reset</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">mspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">mspath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">restore_flag</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restoring flags of measurement set : </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">msname</span> <span class="o">+</span> <span class="s2">&quot;.flagversions&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">msname</span> <span class="o">+</span> <span class="s2">&quot;.flagversions&quot;</span><span class="p">)</span>
            <span class="n">flagdata</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;unflag&quot;</span><span class="p">,</span> <span class="n">flagbackup</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resetting previous weights of the measurement set: </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
        <span class="n">npol</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">ncorrforpol</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">table</span><span class="p">()</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">nomodify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">colnames</span><span class="p">()</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">nrows</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;WEIGHT&quot;</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resetting weight column to ones of measurement set : </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">npol</span><span class="p">,</span> <span class="n">nrows</span><span class="p">))</span>
            <span class="n">tb</span><span class="o">.</span><span class="n">putcol</span><span class="p">(</span><span class="s2">&quot;WEIGHT&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;SIGMA&quot;</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resetting sigma column to ones of measurement set: </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">npol</span><span class="p">,</span> <span class="n">nrows</span><span class="p">))</span>
            <span class="n">tb</span><span class="o">.</span><span class="n">putcol</span><span class="p">(</span><span class="s2">&quot;SIGMA&quot;</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;WEIGHT_SPECTRUM&quot;</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing weight spectrum of measurement set: </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">tb</span><span class="o">.</span><span class="n">removecols</span><span class="p">(</span><span class="s2">&quot;WEIGHT_SPECTRUM&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;SIGMA_SPECTRUM&quot;</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing sigma spectrum of measurement set: </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">tb</span><span class="o">.</span><span class="n">removecols</span><span class="p">(</span><span class="s2">&quot;SIGMA_SPECTRUM&quot;</span><span class="p">)</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;touch </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="s2">/.reset&quot;</span><span class="p">)</span>
    <span class="k">return</span></div>



<div class="viewcode-block" id="correct_missing_col_subms">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.correct_missing_col_subms">[docs]</a>
<span class="k">def</span> <span class="nf">correct_missing_col_subms</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Correct for missing colurmns in sub-MSs</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">table</span><span class="p">()</span>
    <span class="n">colname_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sub_mslist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">msname</span> <span class="o">+</span> <span class="s2">&quot;/SUBMSS/*.ms&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">sub_mslist</span><span class="p">:</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
        <span class="n">colname_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">colnames</span><span class="p">())</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">sets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">colname_list</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">common_elements</span> <span class="o">=</span> <span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="n">sets</span><span class="p">)</span>
        <span class="n">unique_elements</span> <span class="o">=</span> <span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">sets</span><span class="p">)</span> <span class="o">-</span> <span class="n">common_elements</span>
        <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">sub_mslist</span><span class="p">:</span>
            <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">nomodify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">colnames</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">colnames</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">unique_elements</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing column: </span><span class="si">{</span><span class="n">colname</span><span class="si">}</span><span class="s2"> from sub-MS: </span><span class="si">{</span><span class="n">ms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">tb</span><span class="o">.</span><span class="n">removecols</span><span class="p">(</span><span class="n">colname</span><span class="p">)</span>
            <span class="n">tb</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span></div>



<div class="viewcode-block" id="get_unflagged_antennas">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_unflagged_antennas">[docs]</a>
<span class="k">def</span> <span class="nf">get_unflagged_antennas</span><span class="p">(</span><span class="n">msname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">n_threads</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get unflagged antennas of a scan</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    scan : str</span>
<span class="sd">        Scans</span>
<span class="sd">    n_threads : int, optional</span>
<span class="sd">        Number of OpenMP threads</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.array</span>
<span class="sd">        Unflagged antenna names</span>
<span class="sd">    numpy.array</span>
<span class="sd">        Flag fraction list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">limit_threads</span><span class="p">(</span><span class="n">n_threads</span><span class="o">=</span><span class="n">n_threads</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">flagdata</span>

    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># in GB</span>
        <span class="k">return</span> <span class="n">mem</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">mspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">mspath</span><span class="p">)</span>
    <span class="n">flag_summary</span> <span class="o">=</span> <span class="n">flagdata</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">scan</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;summary&quot;</span><span class="p">)</span>
    <span class="n">antenna_flags</span> <span class="o">=</span> <span class="n">flag_summary</span><span class="p">[</span><span class="s2">&quot;antenna&quot;</span><span class="p">]</span>
    <span class="n">unflagged_antenna_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">flag_frac_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ant</span> <span class="ow">in</span> <span class="n">antenna_flags</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">flag_frac</span> <span class="o">=</span> <span class="n">antenna_flags</span><span class="p">[</span><span class="n">ant</span><span class="p">][</span><span class="s2">&quot;flagged&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">antenna_flags</span><span class="p">[</span><span class="n">ant</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">flag_frac</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">unflagged_antenna_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ant</span><span class="p">)</span>
            <span class="n">flag_frac_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag_frac</span><span class="p">)</span>
    <span class="n">unflagged_antenna_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">unflagged_antenna_names</span><span class="p">)</span>
    <span class="n">flag_frac_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flag_frac_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unflagged_antenna_names</span><span class="p">,</span> <span class="n">flag_frac_list</span></div>



<div class="viewcode-block" id="calc_flag_fraction">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.calc_flag_fraction">[docs]</a>
<span class="k">def</span> <span class="nf">calc_flag_fraction</span><span class="p">(</span><span class="n">msname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">n_threads</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate the fraction of total data flagged.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    field : str, optional</span>
<span class="sd">        Field names</span>
<span class="sd">    scan : str, optional</span>
<span class="sd">        Scan names</span>
<span class="sd">    n_threads : int, optional</span>
<span class="sd">        Number of OpenMP threads</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Fraction of the total data flagged</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">limit_threads</span><span class="p">(</span><span class="n">n_threads</span><span class="o">=</span><span class="n">n_threads</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">flagdata</span>

    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># in GB</span>
        <span class="k">return</span> <span class="n">mem</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">mspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">mspath</span><span class="p">)</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">flagdata</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;summary&quot;</span><span class="p">)</span>
    <span class="n">flagged_fraction</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;flagged&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">flagged_fraction</span></div>



<div class="viewcode-block" id="get_fluxcals">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_fluxcals">[docs]</a>
<span class="k">def</span> <span class="nf">get_fluxcals</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get fluxcal field names and scans</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the ms</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Fluxcal field names</span>
<span class="sd">    dict</span>
<span class="sd">        Fluxcal scans</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">msname</span> <span class="o">+</span> <span class="s2">&quot;/SUBMSS&quot;</span><span class="p">):</span>
        <span class="n">mslist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">msname</span> <span class="o">+</span> <span class="s2">&quot;/SUBMSS/*.ms&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">msname</span><span class="p">]</span>
    <span class="n">fluxcal_fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fluxcal_scans</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">msname</span> <span class="ow">in</span> <span class="n">mslist</span><span class="p">:</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;J1939-6342&quot;</span> <span class="ow">or</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;J0408-6545&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fluxcal_fields</span><span class="p">:</span>
                    <span class="n">fluxcal_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="n">scans</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">scansforfield</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fluxcal_scans</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
                        <span class="n">fluxcal_scans</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fluxcal_scans</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">scans</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fluxcal_fields</span><span class="p">,</span> <span class="n">fluxcal_scans</span></div>



<div class="viewcode-block" id="get_polcals">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_polcals">[docs]</a>
<span class="k">def</span> <span class="nf">get_polcals</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get polarization calibrator field names and scans</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the ms</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Polcal field names</span>
<span class="sd">    dict</span>
<span class="sd">        Polcal scans</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">msname</span> <span class="o">+</span> <span class="s2">&quot;/SUBMSS&quot;</span><span class="p">):</span>
        <span class="n">mslist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">msname</span> <span class="o">+</span> <span class="s2">&quot;/SUBMSS/*.ms&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">msname</span><span class="p">]</span>
    <span class="n">polcal_fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">polcal_scans</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">msname</span> <span class="ow">in</span> <span class="n">mslist</span><span class="p">:</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;3C286&quot;</span><span class="p">,</span> <span class="s2">&quot;1328+307&quot;</span><span class="p">,</span> <span class="s2">&quot;1331+305&quot;</span><span class="p">,</span> <span class="s2">&quot;J1331+3030&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;3C138&quot;</span><span class="p">,</span>
                <span class="s2">&quot;0518+165&quot;</span><span class="p">,</span>
                <span class="s2">&quot;0521+166&quot;</span><span class="p">,</span>
                <span class="s2">&quot;J0521+1638&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">polcal_fields</span><span class="p">:</span>
                    <span class="n">polcal_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="n">scans</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">scansforfield</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">polcal_scans</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
                        <span class="n">polcal_scans</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">polcal_scans</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">scans</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">msmd</span>
    <span class="k">return</span> <span class="n">polcal_fields</span><span class="p">,</span> <span class="n">polcal_scans</span></div>



<div class="viewcode-block" id="get_phasecals">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_phasecals">[docs]</a>
<span class="k">def</span> <span class="nf">get_phasecals</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get phasecal field names and scans</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the ms</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Phasecal field names</span>
<span class="sd">    dict</span>
<span class="sd">        Phasecal scans</span>
<span class="sd">    dict</span>
<span class="sd">        Phasecal flux</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">msname</span> <span class="o">+</span> <span class="s2">&quot;/SUBMSS&quot;</span><span class="p">):</span>
        <span class="n">mslist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">msname</span> <span class="o">+</span> <span class="s2">&quot;/SUBMSS/*.ms&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">msname</span><span class="p">]</span>
    <span class="n">phasecal_fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">phasecal_scans</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">phasecal_flux_list</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">get_datadir</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">msname</span> <span class="ow">in</span> <span class="n">mslist</span><span class="p">:</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">()</span>
        <span class="n">bandname</span> <span class="o">=</span> <span class="n">get_band_name</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bandname</span> <span class="o">==</span> <span class="s2">&quot;U&quot;</span><span class="p">:</span>
            <span class="n">phasecals</span><span class="p">,</span> <span class="n">phasecal_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                <span class="n">datadir</span> <span class="o">+</span> <span class="s2">&quot;/UHF_band_cal.npy&quot;</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">bandname</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span>
            <span class="n">phasecals</span><span class="p">,</span> <span class="n">phasecal_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                <span class="n">datadir</span> <span class="o">+</span> <span class="s2">&quot;/L_band_cal.npy&quot;</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">phasecals</span> <span class="ow">and</span> <span class="p">(</span><span class="n">field</span> <span class="o">!=</span> <span class="s2">&quot;J1939-6342&quot;</span> <span class="ow">and</span> <span class="n">field</span> <span class="o">!=</span> <span class="s2">&quot;J0408-6545&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">phasecal_fields</span><span class="p">:</span>
                    <span class="n">phasecal_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="n">scans</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">scansforfield</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">phasecal_scans</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
                        <span class="n">phasecal_scans</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">phasecal_scans</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">scans</span>
                <span class="n">flux</span> <span class="o">=</span> <span class="n">phasecal_flux</span><span class="p">[</span><span class="n">phasecals</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">field</span><span class="p">)]</span>
                <span class="n">phasecal_flux_list</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">msmd</span>
    <span class="k">return</span> <span class="n">phasecal_fields</span><span class="p">,</span> <span class="n">phasecal_scans</span><span class="p">,</span> <span class="n">phasecal_flux_list</span></div>



<div class="viewcode-block" id="get_target_fields">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_target_fields">[docs]</a>
<span class="k">def</span> <span class="nf">get_target_fields</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get target fields</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Target field names</span>
<span class="sd">    dict</span>
<span class="sd">        Target field scans</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fluxcal_field</span><span class="p">,</span> <span class="n">fluxcal_scans</span> <span class="o">=</span> <span class="n">get_fluxcals</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">phasecal_field</span><span class="p">,</span> <span class="n">phasecal_scans</span><span class="p">,</span> <span class="n">phasecal_fluxs</span> <span class="o">=</span> <span class="n">get_phasecals</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">calibrator_field</span> <span class="o">=</span> <span class="n">fluxcal_field</span> <span class="o">+</span> <span class="n">phasecal_field</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">field_names</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">()</span>
    <span class="n">field_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">field_names</span><span class="p">)</span>
    <span class="n">target_fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">target_scans</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calibrator_field</span><span class="p">:</span>
            <span class="n">target_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">target_fields</span><span class="p">:</span>
        <span class="n">scans</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">scansforfield</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">target_scans</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">scans</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">msmd</span>
    <span class="k">return</span> <span class="n">target_fields</span><span class="p">,</span> <span class="n">target_scans</span></div>



<div class="viewcode-block" id="get_caltable_fields">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_caltable_fields">[docs]</a>
<span class="k">def</span> <span class="nf">get_caltable_fields</span><span class="p">(</span><span class="n">caltable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get caltable field names</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    caltable : str</span>
<span class="sd">        Caltable name</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Field names</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">table</span><span class="p">()</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">caltable</span> <span class="o">+</span> <span class="s2">&quot;/FIELD&quot;</span><span class="p">)</span>
    <span class="n">field_names</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">)</span>
    <span class="n">field_ids</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;SOURCE_ID&quot;</span><span class="p">)</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">caltable</span><span class="p">)</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;FIELD_ID&quot;</span><span class="p">))</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">field_name_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">field_ids</span> <span class="o">==</span> <span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">field_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">field_names</span><span class="p">[</span><span class="n">pos</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">field_name_list</span></div>



<div class="viewcode-block" id="get_cal_target_scans">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_cal_target_scans">[docs]</a>
<span class="k">def</span> <span class="nf">get_cal_target_scans</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get calibrator and target scans</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Target scan numbers</span>
<span class="sd">    list</span>
<span class="sd">        Calibrator scan numbers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f_scans</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">p_scans</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">g_scans</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fluxcal_fields</span><span class="p">,</span> <span class="n">fluxcal_scans</span> <span class="o">=</span> <span class="n">get_fluxcals</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">phasecal_fields</span><span class="p">,</span> <span class="n">phasecal_scans</span><span class="p">,</span> <span class="n">phasecal_flux_list</span> <span class="o">=</span> <span class="n">get_phasecals</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">polcal_fields</span><span class="p">,</span> <span class="n">polcal_scans</span> <span class="o">=</span> <span class="n">get_polcals</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fluxcal_scan</span> <span class="ow">in</span> <span class="n">fluxcal_scans</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">fluxcal_scan</span><span class="p">:</span>
            <span class="n">f_scans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">polcal_scan</span> <span class="ow">in</span> <span class="n">polcal_scans</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">polcal_scan</span><span class="p">:</span>
            <span class="n">p_scans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">phasecal_scan</span> <span class="ow">in</span> <span class="n">phasecal_scans</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">phasecal_scan</span><span class="p">:</span>
            <span class="n">g_scans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">cal_scans</span> <span class="o">=</span> <span class="n">f_scans</span> <span class="o">+</span> <span class="n">p_scans</span> <span class="o">+</span> <span class="n">g_scans</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">all_scans</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">scannumbers</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">target_scans</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">all_scans</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scan</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cal_scans</span><span class="p">:</span>
            <span class="n">target_scans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">target_scans</span><span class="p">,</span> <span class="n">cal_scans</span><span class="p">,</span> <span class="n">f_scans</span><span class="p">,</span> <span class="n">g_scans</span><span class="p">,</span> <span class="n">p_scans</span></div>



<div class="viewcode-block" id="get_solar_elevation_MeerKAT">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_solar_elevation_MeerKAT">[docs]</a>
<span class="k">def</span> <span class="nf">get_solar_elevation_MeerKAT</span><span class="p">(</span><span class="n">date_time</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get solar elevation at MeerKAT at a time</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    date_time : str</span>
<span class="sd">        Date and time in &#39;yyyy-mm-ddTHH:MM:SS&#39; format (default: current time)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Solar elevation in degree</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
    <span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">AltAz</span><span class="p">,</span> <span class="n">EarthLocation</span><span class="p">,</span> <span class="n">get_sun</span><span class="p">,</span> <span class="n">SkyCoord</span>
    <span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>

    <span class="n">lat</span> <span class="o">=</span> <span class="o">-</span><span class="mf">30.7130</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="mf">21.4430</span>
    <span class="n">elev</span> <span class="o">=</span> <span class="mi">1038</span>
    <span class="n">latitude</span> <span class="o">=</span> <span class="n">lat</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>  <span class="c1"># In degree</span>
    <span class="n">longitude</span> <span class="o">=</span> <span class="n">lon</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>  <span class="c1"># In degree</span>
    <span class="n">elevation</span> <span class="o">=</span> <span class="n">elev</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span>  <span class="c1"># In meter</span>
    <span class="k">if</span> <span class="n">date_time</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">Time</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">date_time</span><span class="p">)</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">latitude</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">longitude</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">elevation</span><span class="p">)</span>
    <span class="n">sun_coords</span> <span class="o">=</span> <span class="n">get_sun</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="n">altaz_frame</span> <span class="o">=</span> <span class="n">AltAz</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span>
    <span class="n">sun_altaz</span> <span class="o">=</span> <span class="n">sun_coords</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">altaz_frame</span><span class="p">)</span>
    <span class="n">solar_elevation</span> <span class="o">=</span> <span class="n">sun_altaz</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">deg</span>
    <span class="k">return</span> <span class="n">solar_elevation</span></div>



<div class="viewcode-block" id="timestamp_to_mjdsec">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.timestamp_to_mjdsec">[docs]</a>
<span class="k">def</span> <span class="nf">timestamp_to_mjdsec</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert timestamp to mjd second.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    timestamp : str</span>
<span class="sd">        Time stamp to convert</span>
<span class="sd">    date_format : int, optional</span>
<span class="sd">        Datetime string format</span>
<span class="sd">            0: &#39;YYYY/MM/DD/hh:mm:ss&#39;</span>

<span class="sd">            1: &#39;YYYY-MM-DDThh:mm:ss&#39;</span>

<span class="sd">            2: &#39;YYYY-MM-DD hh:mm:ss&#39;</span>

<span class="sd">            3: &#39;YYYY_MM_DD_hh_mm_ss&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Return correspondong MJD second of the day</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">julian</span>

    <span class="k">if</span> <span class="n">date_format</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timestamp_datetime</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;%Y/%m/</span><span class="si">%d</span><span class="s2">/%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">timestamp_datetime</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;%Y/%m/</span><span class="si">%d</span><span class="s2">/%H:%M:%S&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">date_format</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timestamp_datetime</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">timestamp_datetime</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">date_format</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timestamp_datetime</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">timestamp_datetime</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">%H:%M:%S&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">date_format</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timestamp_datetime</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;%Y_%m_</span><span class="si">%d</span><span class="s2">_%H_%M_%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">timestamp_datetime</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s2">&quot;%Y_%m_</span><span class="si">%d</span><span class="s2">_%H_%M_%S&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No proper format of timestamp.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">mjd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">{: .2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="p">(</span><span class="n">julian</span><span class="o">.</span><span class="n">to_jd</span><span class="p">(</span><span class="n">timestamp_datetime</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2400000.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">24.0</span> <span class="o">*</span> <span class="mf">3600.0</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">mjd</span></div>



<div class="viewcode-block" id="mjdsec_to_timestamp">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.mjdsec_to_timestamp">[docs]</a>
<span class="k">def</span> <span class="nf">mjdsec_to_timestamp</span><span class="p">(</span><span class="n">mjdsec</span><span class="p">,</span> <span class="n">str_format</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert CASA MJD seceonds to CASA timestamp</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mjdsec : float</span>
<span class="sd">            CASA MJD seconds</span>
<span class="sd">    str_format : int</span>
<span class="sd">        Time stamp format (0: yyyy-mm-ddTHH:MM:SS.ff, 1: yyyy/mm/dd/HH:MM:SS.ff, 2: yyyy-mm-dd HH:MM:SS)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">            CASA time stamp in UTC at ISOT format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">measures</span><span class="p">,</span> <span class="n">quanta</span>

    <span class="n">me</span> <span class="o">=</span> <span class="n">measures</span><span class="p">()</span>
    <span class="n">qa</span> <span class="o">=</span> <span class="n">quanta</span><span class="p">()</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">epoch</span><span class="p">(</span><span class="s2">&quot;utc&quot;</span><span class="p">,</span> <span class="s2">&quot;today&quot;</span><span class="p">)</span>
    <span class="n">mjd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mjdsec</span><span class="p">)</span> <span class="o">/</span> <span class="mf">86400.0</span>
    <span class="n">today</span><span class="p">[</span><span class="s2">&quot;m0&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mjd</span>
    <span class="n">hhmmss</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">today</span><span class="p">[</span><span class="s2">&quot;m0&quot;</span><span class="p">],</span> <span class="n">prec</span><span class="o">=</span><span class="mi">8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">splitdate</span><span class="p">(</span><span class="n">today</span><span class="p">[</span><span class="s2">&quot;m0&quot;</span><span class="p">])</span>
    <span class="n">qa</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">str_format</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">utcstring</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">T</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">date</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
            <span class="n">date</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">],</span>
            <span class="n">date</span><span class="p">[</span><span class="s2">&quot;monthday&quot;</span><span class="p">],</span>
            <span class="n">hhmmss</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">str_format</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">utcstring</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%02d</span><span class="s2">/</span><span class="si">%02d</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">date</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
            <span class="n">date</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">],</span>
            <span class="n">date</span><span class="p">[</span><span class="s2">&quot;monthday&quot;</span><span class="p">],</span>
            <span class="n">hhmmss</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">utcstring</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">date</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
            <span class="n">date</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">],</span>
            <span class="n">date</span><span class="p">[</span><span class="s2">&quot;monthday&quot;</span><span class="p">],</span>
            <span class="n">hhmmss</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">utcstring</span></div>



<div class="viewcode-block" id="get_timeranges_for_scan">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_timeranges_for_scan">[docs]</a>
<span class="k">def</span> <span class="nf">get_timeranges_for_scan</span><span class="p">(</span>
    <span class="n">msname</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="n">time_interval</span><span class="p">,</span> <span class="n">time_window</span><span class="p">,</span> <span class="n">quack_timestamps</span><span class="o">=-</span><span class="mi">1</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get time ranges for a scan with certain time intervals</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    scan : int</span>
<span class="sd">        Scan number</span>
<span class="sd">    time_interval : float</span>
<span class="sd">        Time interval in seconds</span>
<span class="sd">    time_window : float</span>
<span class="sd">        Time window in seconds</span>
<span class="sd">    quack_timestamps : int, optional</span>
<span class="sd">        Number of timestamps ignored at the start and end of each scan</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        List of time ranges</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">timesforscan</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">scan</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">timesforspws</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">time_ranges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">quack_timestamps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">quack_timestamps</span><span class="p">:</span><span class="o">-</span><span class="n">quack_timestamps</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">time_interval</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">time_window</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mjdsec_to_timestamp</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">str_format</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;~&quot;</span>
            <span class="o">+</span> <span class="n">mjdsec_to_timestamp</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">str_format</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">time_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">time_ranges</span>
    <span class="n">total_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="n">timeres</span> <span class="o">=</span> <span class="n">total_time</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="n">ntime_chunk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_time</span> <span class="o">/</span> <span class="n">time_interval</span><span class="p">)</span>
    <span class="n">ntime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_window</span> <span class="o">/</span> <span class="n">timeres</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">times</span><span class="p">[:</span><span class="o">-</span><span class="n">ntime</span><span class="p">]</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">ntime_chunk</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">timelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">timelist</span><span class="p">:</span>
        <span class="n">time_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mjdsec_to_timestamp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">str_format</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">~</span><span class="si">{</span><span class="n">mjdsec_to_timestamp</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="n">time_window</span><span class="p">,</span><span class="w"> </span><span class="n">str_format</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">time_ranges</span></div>



<div class="viewcode-block" id="radec_sun">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.radec_sun">[docs]</a>
<span class="k">def</span> <span class="nf">radec_sun</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    RA DEC of the Sun at the start of the scan</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        RA DEC of the Sun in J2000</span>
<span class="sd">    str</span>
<span class="sd">        RA string</span>
<span class="sd">    str</span>
<span class="sd">        DEC string</span>
<span class="sd">    float</span>
<span class="sd">        RA in degree</span>
<span class="sd">    float</span>
<span class="sd">        DEC in degree</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">timesforspws</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">mid_time</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)]</span>
    <span class="n">mid_timestamp</span> <span class="o">=</span> <span class="n">mjdsec_to_timestamp</span><span class="p">(</span><span class="n">mid_time</span><span class="p">)</span>
    <span class="n">mid_time_mjd</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">mid_timestamp</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;isot&quot;</span><span class="p">)</span>
    <span class="n">sun_coord</span> <span class="o">=</span> <span class="n">get_sun</span><span class="p">(</span><span class="n">mid_time_mjd</span><span class="p">)</span>
    <span class="n">sun_ra</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sun_coord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">hms</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
        <span class="o">+</span> <span class="s2">&quot;h&quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sun_coord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">hms</span><span class="o">.</span><span class="n">m</span><span class="p">))</span>
        <span class="o">+</span> <span class="s2">&quot;m&quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sun_coord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">hms</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="o">+</span> <span class="s2">&quot;s&quot;</span>
    <span class="p">)</span>
    <span class="n">sun_dec</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sun_coord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">dms</span><span class="o">.</span><span class="n">d</span><span class="p">))</span>
        <span class="o">+</span> <span class="s2">&quot;d&quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sun_coord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">dms</span><span class="o">.</span><span class="n">m</span><span class="p">))</span>
        <span class="o">+</span> <span class="s2">&quot;m&quot;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sun_coord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">dms</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="o">+</span> <span class="s2">&quot;s&quot;</span>
    <span class="p">)</span>
    <span class="n">sun_radec_string</span> <span class="o">=</span> <span class="s2">&quot;J2000 &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sun_ra</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sun_dec</span><span class="p">)</span>
    <span class="n">radeg</span> <span class="o">=</span> <span class="n">sun_coord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">deg</span>
    <span class="n">radeg</span> <span class="o">=</span> <span class="n">radeg</span> <span class="o">%</span> <span class="mi">360</span>
    <span class="n">decdeg</span> <span class="o">=</span> <span class="n">sun_coord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">deg</span>
    <span class="n">decdeg</span> <span class="o">=</span> <span class="n">decdeg</span> <span class="o">%</span> <span class="mi">360</span>
    <span class="k">return</span> <span class="n">sun_radec_string</span><span class="p">,</span> <span class="n">sun_ra</span><span class="p">,</span> <span class="n">sun_dec</span><span class="p">,</span> <span class="n">radeg</span><span class="p">,</span> <span class="n">decdeg</span></div>



<div class="viewcode-block" id="get_phasecenter">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_phasecenter">[docs]</a>
<span class="k">def</span> <span class="nf">get_phasecenter</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get phasecenter of the measurement set</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">            RA in degree</span>
<span class="sd">    float</span>
<span class="sd">            DEC in degree</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">phasecenter</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">phasecenter</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">radeg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">phasecenter</span><span class="p">[</span><span class="s2">&quot;m0&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
    <span class="n">radeg</span> <span class="o">=</span> <span class="n">radeg</span> <span class="o">%</span> <span class="mi">360</span>
    <span class="n">decdeg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">phasecenter</span><span class="p">[</span><span class="s2">&quot;m1&quot;</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
    <span class="n">decdeg</span> <span class="o">=</span> <span class="n">decdeg</span> <span class="o">%</span> <span class="mi">360</span>
    <span class="k">return</span> <span class="n">radeg</span><span class="p">,</span> <span class="n">decdeg</span></div>



<div class="viewcode-block" id="angular_separation_equatorial">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.angular_separation_equatorial">[docs]</a>
<span class="k">def</span> <span class="nf">angular_separation_equatorial</span><span class="p">(</span><span class="n">ra1</span><span class="p">,</span> <span class="n">dec1</span><span class="p">,</span> <span class="n">ra2</span><span class="p">,</span> <span class="n">dec2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate angular seperation between two equatorial coordinates</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ra1 : float</span>
<span class="sd">        RA of the first coordinate in degree</span>
<span class="sd">    dec1 : float</span>
<span class="sd">        DEC of the first coordinate in degree</span>
<span class="sd">    ra2 : float</span>
<span class="sd">        RA of the second coordinate in degree</span>
<span class="sd">    dec2 : float</span>
<span class="sd">        DEC of the second coordinate in degree</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Angular distance in degree</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert RA and Dec from degrees to radians</span>
    <span class="n">ra1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">ra1</span><span class="p">)</span>
    <span class="n">ra2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">ra2</span><span class="p">)</span>
    <span class="n">dec1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dec1</span><span class="p">)</span>
    <span class="n">dec2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dec2</span><span class="p">)</span>
    <span class="c1"># Apply the spherical distance formula using NumPy functions</span>
    <span class="n">cos_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dec2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span>
        <span class="n">ra1</span> <span class="o">-</span> <span class="n">ra2</span>
    <span class="p">)</span>
    <span class="c1"># Calculate the angular separation in radians</span>
    <span class="n">theta_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cos_theta</span><span class="p">)</span>
    <span class="c1"># Convert the angular separation from radians to degrees</span>
    <span class="n">theta_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">theta_rad</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">theta_deg</span></div>



<div class="viewcode-block" id="move_to_sun">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.move_to_sun">[docs]</a>
<span class="k">def</span> <span class="nf">move_to_sun</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">only_uvw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Move the phasecenter of the measurement set at the center of the Sun (Assuming ms has one scan)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    only_uvw : bool, optional</span>
<span class="sd">        Note: This is required when visibilities are properly phase rotated in correlator to track the Sun,</span>
<span class="sd">        but while creating the MS, UVW values are estimated using a wrong phase center at the start of solar center at the start.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sun_radec_string</span><span class="p">,</span> <span class="n">sunra</span><span class="p">,</span> <span class="n">sundec</span><span class="p">,</span> <span class="n">sunra_deg</span><span class="p">,</span> <span class="n">sundec_deg</span> <span class="o">=</span> <span class="n">radec_sun</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">run_chgcenter</span><span class="p">(</span>
        <span class="n">msname</span><span class="p">,</span> <span class="n">sunra</span><span class="p">,</span> <span class="n">sundec</span><span class="p">,</span> <span class="n">only_uvw</span><span class="o">=</span><span class="n">only_uvw</span><span class="p">,</span> <span class="n">container_name</span><span class="o">=</span><span class="s2">&quot;meerwsclean&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Phasecenter could not be shifted.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">msg</span></div>



<div class="viewcode-block" id="correct_solar_sidereal_motion">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.correct_solar_sidereal_motion">[docs]</a>
<span class="k">def</span> <span class="nf">correct_solar_sidereal_motion</span><span class="p">(</span><span class="n">msname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Correct sodereal motion of the Sun</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="n">run_solar_sidereal_cor</span><span class="p">(</span><span class="n">dry_run</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mem</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correcting sidereal motion for ms: </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">msname</span> <span class="o">+</span> <span class="s2">&quot;/.sidereal_cor&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">run_solar_sidereal_cor</span><span class="p">(</span>
            <span class="n">msname</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span> <span class="n">container_name</span><span class="o">=</span><span class="s2">&quot;meerwsclean&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sidereal motion correction is not successful.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;touch &quot;</span> <span class="o">+</span> <span class="n">msname</span> <span class="o">+</span> <span class="s2">&quot;/.sidereal_cor&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msg</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sidereal motion correction is already done for ms: </span><span class="si">{</span><span class="n">msname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span></div>



<div class="viewcode-block" id="check_scan_in_caltable">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.check_scan_in_caltable">[docs]</a>
<span class="k">def</span> <span class="nf">check_scan_in_caltable</span><span class="p">(</span><span class="n">caltable</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check scan number available in caltable or not</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    caltable : str</span>
<span class="sd">        Name of the caltable</span>
<span class="sd">    scan : int</span>
<span class="sd">        Scan number</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        Whether scan is present in the caltable or not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">table</span><span class="p">()</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">caltable</span><span class="p">)</span>
    <span class="n">scans</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;SCAN_NUMBER&quot;</span><span class="p">)</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="determine_noise_diode_cal_scan">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.determine_noise_diode_cal_scan">[docs]</a>
<span class="k">def</span> <span class="nf">determine_noise_diode_cal_scan</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine whether a calibrator scan is a noise-diode cal scan or not</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    scan : int</span>
<span class="sd">        Scan number</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        Whether it is noise-diode cal scan or not</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">is_noisescan</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="n">mstool</span> <span class="o">=</span> <span class="n">casamstool</span><span class="p">()</span>
        <span class="n">mstool</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
        <span class="n">mstool</span><span class="o">.</span><span class="n">select</span><span class="p">({</span><span class="s2">&quot;antenna1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;antenna2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;scan_number&quot;</span><span class="p">:</span> <span class="n">scan</span><span class="p">})</span>
        <span class="n">mstool</span><span class="o">.</span><span class="n">selectchannel</span><span class="p">(</span><span class="n">nchan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">chan</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">mstool</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="s2">&quot;DATA&quot;</span><span class="p">,</span> <span class="n">ifraxis</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s2">&quot;data&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">mstool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>
        <span class="n">even_xx</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">odd_xx</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">minlen</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">even_xx</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">odd_xx</span><span class="p">))</span>
        <span class="n">d_xx</span> <span class="o">=</span> <span class="n">even_xx</span><span class="p">[:</span><span class="n">minlen</span><span class="p">]</span> <span class="o">-</span> <span class="n">odd_xx</span><span class="p">[:</span><span class="n">minlen</span><span class="p">]</span>
        <span class="n">even_yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">odd_yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">d_yy</span> <span class="o">=</span> <span class="n">even_yy</span><span class="p">[:</span><span class="n">minlen</span><span class="p">]</span> <span class="o">-</span> <span class="n">odd_yy</span><span class="p">[:</span><span class="n">minlen</span><span class="p">]</span>
        <span class="n">mean_d_xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">d_xx</span><span class="p">))</span>
        <span class="n">mean_d_yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">d_yy</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">mean_d_xx</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">mean_d_yy</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Check noise-diode cal for scan : </span><span class="si">{</span><span class="n">scan</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">good_spw</span> <span class="o">=</span> <span class="n">get_good_chans</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">chan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">good_spw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">is_noisescan</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">scan</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_valid_scans">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_valid_scans">[docs]</a>
<span class="k">def</span> <span class="nf">get_valid_scans</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">min_scan_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_threads</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get valid list of scans</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Measurement set name</span>
<span class="sd">    min_scan_time : float</span>
<span class="sd">        Minimum valid scan time in minute</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Valid scan list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">limit_threads</span><span class="p">(</span><span class="n">n_threads</span><span class="o">=</span><span class="n">n_threads</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">ms</span> <span class="k">as</span> <span class="n">casamstool</span>

    <span class="n">mstool</span> <span class="o">=</span> <span class="n">casamstool</span><span class="p">()</span>
    <span class="n">mstool</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">scan_summary</span> <span class="o">=</span> <span class="n">mstool</span><span class="o">.</span><span class="n">getscansummary</span><span class="p">()</span>
    <span class="n">mstool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">scans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">scan_summary</span><span class="o">.</span><span class="n">keys</span><span class="p">()]))</span>
    <span class="n">target_scans</span><span class="p">,</span> <span class="n">cal_scans</span><span class="p">,</span> <span class="n">f_scans</span><span class="p">,</span> <span class="n">g_scans</span><span class="p">,</span> <span class="n">p_scans</span> <span class="o">=</span> <span class="n">get_cal_target_scans</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">selected_field</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">valid_scans</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">field</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">field_id</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">fieldsforname</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">field_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">selected_field</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_id</span><span class="p">)</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">msmd</span>
    <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
        <span class="n">scan_field</span> <span class="o">=</span> <span class="n">scan_summary</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">scan</span><span class="p">)][</span><span class="s2">&quot;0&quot;</span><span class="p">][</span><span class="s2">&quot;FieldId&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_field</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">scan_field</span> <span class="ow">in</span> <span class="n">selected_field</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">scan_summary</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">scan</span><span class="p">)][</span><span class="s2">&quot;0&quot;</span><span class="p">][</span><span class="s2">&quot;EndTime&quot;</span><span class="p">]</span>
                <span class="o">-</span> <span class="n">scan_summary</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">scan</span><span class="p">)][</span><span class="s2">&quot;0&quot;</span><span class="p">][</span><span class="s2">&quot;BeginTime&quot;</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">*</span> <span class="mf">86400.0</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">duration</span> <span class="o">/</span> <span class="mf">60.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">duration</span> <span class="o">&gt;=</span> <span class="n">min_scan_time</span><span class="p">:</span>
                <span class="n">valid_scans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">valid_scans</span></div>



<div class="viewcode-block" id="split_into_chunks">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.split_into_chunks">[docs]</a>
<span class="k">def</span> <span class="nf">split_into_chunks</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">target_chunk_size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split a list into equal number of elements</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lst : list</span>
<span class="sd">        List of numbers</span>
<span class="sd">    target_chunk_size: int</span>
<span class="sd">        Number of elements per chunk</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Chunked list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
    <span class="n">num_chunks</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="n">target_chunk_size</span><span class="p">))</span>
    <span class="n">avg_chunk_size</span> <span class="o">=</span> <span class="n">n</span> <span class="o">//</span> <span class="n">num_chunks</span>
    <span class="n">remainder</span> <span class="o">=</span> <span class="n">n</span> <span class="o">%</span> <span class="n">num_chunks</span>

    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_chunks</span><span class="p">):</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">remainder</span> <span class="k">else</span> <span class="mi">0</span>  <span class="c1"># Distribute remainder</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">avg_chunk_size</span> <span class="o">+</span> <span class="n">extra</span>
        <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>
    <span class="k">return</span> <span class="n">chunks</span></div>



<div class="viewcode-block" id="calc_maxuv">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.calc_maxuv">[docs]</a>
<span class="k">def</span> <span class="nf">calc_maxuv</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">chan_number</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate maximum UV</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    chan_number : int, optional</span>
<span class="sd">        Channel number</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Maximum UV in meter</span>
<span class="sd">    float</span>
<span class="sd">        Maximum UV in wavelength</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanfreqs</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="n">chan_number</span><span class="p">]</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="mf">299792458.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">freq</span><span class="p">)</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">table</span><span class="p">()</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">uvw</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;UVW&quot;</span><span class="p">)</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="p">[</span><span class="n">uvw</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="n">uv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">uv</span><span class="p">[</span><span class="n">uv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">maxuv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">uv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">maxuv</span><span class="p">,</span> <span class="n">maxuv</span> <span class="o">/</span> <span class="n">wavelength</span></div>



<div class="viewcode-block" id="calc_minuv">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.calc_minuv">[docs]</a>
<span class="k">def</span> <span class="nf">calc_minuv</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">chan_number</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate minimum UV</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    chan_number : int, optional</span>
<span class="sd">        Channel number</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Minimum UV in meter</span>
<span class="sd">    float</span>
<span class="sd">        Minimum UV in wavelength</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanfreqs</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="n">chan_number</span><span class="p">]</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="mf">299792458.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">freq</span><span class="p">)</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">table</span><span class="p">()</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">uvw</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;UVW&quot;</span><span class="p">)</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="p">[</span><span class="n">uvw</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="n">uv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">uv</span><span class="p">[</span><span class="n">uv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">minuv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">uv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">minuv</span><span class="p">,</span> <span class="n">minuv</span> <span class="o">/</span> <span class="n">wavelength</span></div>



<div class="viewcode-block" id="calc_field_of_view">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.calc_field_of_view">[docs]</a>
<span class="k">def</span> <span class="nf">calc_field_of_view</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">FWHM</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate optimum field of view in arcsec.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Measurement set name</span>
<span class="sd">    FWHM : bool, optional</span>
<span class="sd">        Upto FWHM, otherwise upto first null</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Field of view in arcsec</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanfreqs</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">table</span><span class="p">()</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span> <span class="o">+</span> <span class="s2">&quot;/ANTENNA&quot;</span><span class="p">)</span>
    <span class="n">dish_dia</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;DISH_DIAMETER&quot;</span><span class="p">))</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="mf">299792458.0</span> <span class="o">/</span> <span class="n">freq</span>
    <span class="k">if</span> <span class="n">FWHM</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">FOV</span> <span class="o">=</span> <span class="mf">1.22</span> <span class="o">*</span> <span class="n">wavelength</span> <span class="o">/</span> <span class="n">dish_dia</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">FOV</span> <span class="o">=</span> <span class="mf">2.04</span> <span class="o">*</span> <span class="n">wavelength</span> <span class="o">/</span> <span class="n">dish_dia</span>
    <span class="n">fov_arcsec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">FOV</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span>  <span class="c1">### In arcsecs</span>
    <span class="k">return</span> <span class="n">fov_arcsec</span></div>



<div class="viewcode-block" id="ceil_to_multiple">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.ceil_to_multiple">[docs]</a>
<span class="k">def</span> <span class="nf">ceil_to_multiple</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Round up to the next multiple</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : float</span>
<span class="sd">        The number</span>
<span class="sd">    base : float</span>
<span class="sd">        Whose multiple will be</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The modified number</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">n</span> <span class="o">//</span> <span class="n">base</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">base</span></div>



<div class="viewcode-block" id="calc_bw_smearing_freqwidth">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.calc_bw_smearing_freqwidth">[docs]</a>
<span class="k">def</span> <span class="nf">calc_bw_smearing_freqwidth</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate spectral width to procude bandwidth smearing</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Spectral width in MHz</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">R</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">fov</span> <span class="o">=</span> <span class="mi">3600</span>  <span class="c1"># 2 times size of the Sun</span>
    <span class="n">psf</span> <span class="o">=</span> <span class="n">calc_psf</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">meanfreq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">freqres</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanres</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">delta_nu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="n">R</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">psf</span> <span class="o">/</span> <span class="n">fov</span><span class="p">)</span> <span class="o">*</span> <span class="n">freq</span>
    <span class="n">delta_nu</span> <span class="o">/=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
    <span class="n">delta_nu</span> <span class="o">=</span> <span class="n">ceil_to_multiple</span><span class="p">(</span><span class="n">delta_nu</span><span class="p">,</span> <span class="n">freqres</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">delta_nu</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>



<div class="viewcode-block" id="calc_time_smearing_timewidth">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.calc_time_smearing_timewidth">[docs]</a>
<span class="k">def</span> <span class="nf">calc_time_smearing_timewidth</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate maximum time averaging to avoid time smearing over full FoV.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Measurement set name</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    delta_t_max : float</span>
<span class="sd">        Maximum allowable time averaging in seconds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">freq_Hz</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanfreqs</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">timesforspws</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">timeres</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">299792458.0</span>  <span class="c1"># speed of light in m/s</span>
    <span class="n">omega_E</span> <span class="o">=</span> <span class="mf">7.2921159e-5</span>  <span class="c1"># Earth rotation rate in rad/s</span>
    <span class="n">lam</span> <span class="o">=</span> <span class="n">c</span> <span class="o">/</span> <span class="n">freq_Hz</span>  <span class="c1"># wavelength in meters</span>
    <span class="n">fov_deg</span> <span class="o">=</span> <span class="n">calc_field_of_view</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3600.0</span>
    <span class="n">fov_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">fov_deg</span><span class="p">)</span>
    <span class="n">uv</span><span class="p">,</span> <span class="n">uvlambda</span> <span class="o">=</span> <span class="n">calc_maxuv</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="c1"># Approximate maximum allowable time to avoid &gt;10% amplitude loss</span>
    <span class="n">delta_t_max</span> <span class="o">=</span> <span class="n">lam</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">uv</span> <span class="o">*</span> <span class="n">omega_E</span> <span class="o">*</span> <span class="n">fov_rad</span><span class="p">)</span>
    <span class="n">delta_t_max</span> <span class="o">=</span> <span class="n">ceil_to_multiple</span><span class="p">(</span><span class="n">delta_t_max</span><span class="p">,</span> <span class="n">timeres</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">delta_t_max</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>



<div class="viewcode-block" id="max_time_solar_smearing">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.max_time_solar_smearing">[docs]</a>
<span class="k">def</span> <span class="nf">max_time_solar_smearing</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Max allowable time averaging to avoid solar motion smearing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Measurement set name</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    t_max : float</span>
<span class="sd">        Maximum time averaging in seconds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">omega_sun</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="o">/</span> <span class="p">(</span><span class="mf">60.0</span><span class="p">)</span>  <span class="c1"># solar apparent motion (2.5 arcsec/min to arcsec/sec)</span>
    <span class="n">psf</span> <span class="o">=</span> <span class="n">calc_psf</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">t_max</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">psf</span> <span class="o">/</span> <span class="n">omega_sun</span><span class="p">)</span>  <span class="c1"># seconds</span>
    <span class="k">return</span> <span class="n">t_max</span></div>



<div class="viewcode-block" id="calc_psf">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.calc_psf">[docs]</a>
<span class="k">def</span> <span class="nf">calc_psf</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">chan_number</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to calculate PSF size in arcsec</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    chan_number : int, optional</span>
<span class="sd">        Channel number</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">            PSF size in arcsec</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">maxuv_m</span><span class="p">,</span> <span class="n">maxuv_l</span> <span class="o">=</span> <span class="n">calc_maxuv</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">chan_number</span><span class="o">=</span><span class="n">chan_number</span><span class="p">)</span>
    <span class="n">psf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="mf">1.2</span> <span class="o">/</span> <span class="n">maxuv_l</span><span class="p">)</span> <span class="o">*</span> <span class="mf">3600.0</span>  <span class="c1"># In arcsec</span>
    <span class="k">return</span> <span class="n">psf</span></div>



<div class="viewcode-block" id="calc_npix_in_psf">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.calc_npix_in_psf">[docs]</a>
<span class="k">def</span> <span class="nf">calc_npix_in_psf</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate number of pixels in a PSF (could be in fraction)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weight : str</span>
<span class="sd">        Image weighting scheme</span>
<span class="sd">    robust : float, optional</span>
<span class="sd">        Briggs weighting robust parameter (-1,1)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Number of pixels in a PSF</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">weight</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;NATURAL&quot;</span><span class="p">:</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="n">weight</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;UNIFORM&quot;</span><span class="p">:</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># -1 to +1, uniform to natural</span>
        <span class="n">robust</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">robust</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="o">-</span> <span class="p">((</span><span class="n">robust</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">5.0</span> <span class="o">-</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>



<div class="viewcode-block" id="calc_cellsize">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.calc_cellsize">[docs]</a>
<span class="k">def</span> <span class="nf">calc_cellsize</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">num_pixel_in_psf</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate pixel size in arcsec</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    num_pixel_in_psf : float</span>
<span class="sd">            Number of pixels in one PSF</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">            Pixel size in arcsec</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">psf</span> <span class="o">=</span> <span class="n">calc_psf</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">pixel</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">psf</span> <span class="o">/</span> <span class="n">num_pixel_in_psf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pixel</span></div>



<div class="viewcode-block" id="calc_multiscale_scales">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.calc_multiscale_scales">[docs]</a>
<span class="k">def</span> <span class="nf">calc_multiscale_scales</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">num_pixel_in_psf</span><span class="p">,</span> <span class="n">chan_number</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_scale</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate multiscale scales</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    num_pixel_in_psf : float</span>
<span class="sd">            Number of pixels in one PSF</span>
<span class="sd">    max_scale : float, optional</span>
<span class="sd">        Maximum scale in arcmin</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">            Multiscale scales in pixel units</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">psf</span> <span class="o">=</span> <span class="n">calc_psf</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">chan_number</span><span class="o">=</span><span class="n">chan_number</span><span class="p">)</span>
    <span class="n">minuv</span><span class="p">,</span> <span class="n">minuv_l</span> <span class="o">=</span> <span class="n">calc_minuv</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">chan_number</span><span class="o">=</span><span class="n">chan_number</span><span class="p">)</span>
    <span class="n">max_interferometric_scale</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">minuv_l</span><span class="p">)</span> <span class="o">*</span> <span class="mf">60.0</span>
    <span class="p">)</span>  <span class="c1"># In arcmin, half of maximum scale</span>
    <span class="n">max_interferometric_scale</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_scale</span><span class="p">,</span> <span class="n">max_interferometric_scale</span><span class="p">)</span>
    <span class="n">max_scale_pixel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_interferometric_scale</span> <span class="o">*</span> <span class="mf">60.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">psf</span> <span class="o">/</span> <span class="n">num_pixel_in_psf</span><span class="p">))</span>
    <span class="n">multiscale_scales</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">current_scale</span> <span class="o">=</span> <span class="n">num_pixel_in_psf</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">current_scale</span> <span class="o">=</span> <span class="n">current_scale</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">current_scale</span> <span class="o">&gt;=</span> <span class="n">max_scale_pixel</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">multiscale_scales</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_scale</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">multiscale_scales</span></div>



<div class="viewcode-block" id="get_multiscale_bias">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_multiscale_bias">[docs]</a>
<span class="k">def</span> <span class="nf">get_multiscale_bias</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">bias_min</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">bias_max</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get frequency dependent multiscale bias</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    freq : float</span>
<span class="sd">        Frequency in MHz</span>
<span class="sd">    bias_min : float, optional</span>
<span class="sd">        Minimum bias at minimum L-band frequency</span>
<span class="sd">    bias_max : float, optional</span>
<span class="sd">        Maximum bias at maximum L-band frequency</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Multiscale bias patrameter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;=</span> <span class="mi">1015</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">bias_min</span>
    <span class="k">elif</span> <span class="n">freq</span> <span class="o">&gt;=</span> <span class="mi">1670</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">bias_max</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">freq_min</span> <span class="o">=</span> <span class="mi">1015</span>
        <span class="n">freq_max</span> <span class="o">=</span> <span class="mi">1670</span>
        <span class="n">logf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="n">logf_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">freq_min</span><span class="p">)</span>
        <span class="n">logf_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">freq_max</span><span class="p">)</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">logf</span> <span class="o">-</span> <span class="n">logf_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">logf_max</span> <span class="o">-</span> <span class="n">logf_min</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">bias_min</span> <span class="o">+</span> <span class="n">frac</span> <span class="o">*</span> <span class="p">(</span><span class="n">bias_max</span> <span class="o">-</span> <span class="n">bias_min</span><span class="p">),</span> <span class="n">bias_min</span><span class="p">,</span> <span class="n">bias_max</span><span class="p">),</span> <span class="mi">3</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="cutout_image">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.cutout_image">[docs]</a>
<span class="k">def</span> <span class="nf">cutout_image</span><span class="p">(</span><span class="n">fits_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">x_deg</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cutout central part of the image</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fits_file : str</span>
<span class="sd">        Input fits file</span>
<span class="sd">    output_file : str</span>
<span class="sd">        Output fits file name (If same as input, input image will be overwritten)</span>
<span class="sd">    x_deg : float, optional</span>
<span class="sd">        Size of the output image in degree</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Output image name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fits_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># shape: (nfreq, nstokes, ny, nx)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span>
    <span class="n">wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ny</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="c1"># Get pixel scale (deg/pixel)</span>
    <span class="n">pix_scale_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">])</span>
    <span class="n">x_pix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x_deg</span> <span class="o">/</span> <span class="n">pix_scale_deg</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Adjust if cutout size exceeds image size</span>
    <span class="n">max_half_x</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">max_half_y</span> <span class="o">=</span> <span class="n">ny</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">x_pix</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_pix</span><span class="p">,</span> <span class="n">max_half_x</span><span class="p">)</span>
    <span class="n">y_pix</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_pix</span><span class="p">,</span> <span class="n">max_half_y</span><span class="p">)</span>  <span class="c1"># Assume square pixels</span>
    <span class="c1"># Define slice indices</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">center_x</span> <span class="o">-</span> <span class="n">x_pix</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">center_x</span> <span class="o">+</span> <span class="n">x_pix</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">center_y</span> <span class="o">-</span> <span class="n">y_pix</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">center_y</span> <span class="o">+</span> <span class="n">y_pix</span>
    <span class="c1"># Slice data</span>
    <span class="n">cutout_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">]</span>
    <span class="c1"># Update header</span>
    <span class="n">new_header</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">new_header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span>
    <span class="n">new_header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span>
    <span class="n">new_header</span><span class="p">[</span><span class="s2">&quot;CRPIX1&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">x0</span>
    <span class="n">new_header</span><span class="p">[</span><span class="s2">&quot;CRPIX2&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">y0</span>
    <span class="c1"># Save</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">cutout_data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">new_header</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_file</span></div>



<div class="viewcode-block" id="delaycal">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.delaycal">[docs]</a>
<span class="k">def</span> <span class="nf">delaycal</span><span class="p">(</span><span class="n">msname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">caltable</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">refant</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">solint</span><span class="o">=</span><span class="s2">&quot;inf&quot;</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    General delay calibration using CASA, not assuming any point source</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str, optional</span>
<span class="sd">        Measurement set</span>
<span class="sd">    caltable : str, optional</span>
<span class="sd">        Caltable name</span>
<span class="sd">    refant : str, optional</span>
<span class="sd">        Reference antenna</span>
<span class="sd">    solint : str, optional</span>
<span class="sd">        Solution interval</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Caltable name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">bandpass</span><span class="p">,</span> <span class="n">gaincal</span>

    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># in GB</span>
        <span class="k">return</span> <span class="n">mem</span>
    <span class="kn">import</span> <span class="nn">warnings</span>

    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">mspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">mspath</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">caltable</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
    <span class="n">gaincal</span><span class="p">(</span>
        <span class="n">vis</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span>
        <span class="n">caltable</span><span class="o">=</span><span class="n">caltable</span><span class="p">,</span>
        <span class="n">refant</span><span class="o">=</span><span class="n">refant</span><span class="p">,</span>
        <span class="n">gaintype</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">,</span>
        <span class="n">solint</span><span class="o">=</span><span class="n">solint</span><span class="p">,</span>
        <span class="n">minsnr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">bandpass</span><span class="p">(</span>
        <span class="n">vis</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span>
        <span class="n">caltable</span><span class="o">=</span><span class="n">caltable</span> <span class="o">+</span> <span class="s2">&quot;.tempbcal&quot;</span><span class="p">,</span>
        <span class="n">refant</span><span class="o">=</span><span class="n">refant</span><span class="p">,</span>
        <span class="n">solint</span><span class="o">=</span><span class="n">solint</span><span class="p">,</span>
        <span class="n">minsnr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">table</span><span class="p">()</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">caltable</span> <span class="o">+</span> <span class="s2">&quot;.tempbcal/SPECTRAL_WINDOW&quot;</span><span class="p">)</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;CHAN_FREQ&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">caltable</span> <span class="o">+</span> <span class="s2">&quot;.tempbcal&quot;</span><span class="p">)</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;CPARAM&quot;</span><span class="p">)</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;FLAG&quot;</span><span class="p">)</span>
    <span class="n">gain</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">caltable</span><span class="p">,</span> <span class="n">nomodify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">delay_gain</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;FPARAM&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0</span>
    <span class="n">delay_flag</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;FLAG&quot;</span><span class="p">)</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">gain</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">delay_gain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">delay_gain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">freq</span><span class="p">,</span> <span class="n">phase</span><span class="p">[:,</span> <span class="n">j</span><span class="p">],</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="mi">10</span><span class="o">**-</span><span class="mi">9</span>
                <span class="p">)</span>  <span class="c1"># Delay in nanosecond</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">delay</span><span class="p">):</span>
                    <span class="n">delay</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">delay_gain</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">delay</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">delay_gain</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">putcol</span><span class="p">(</span><span class="s2">&quot;FPARAM&quot;</span><span class="p">,</span> <span class="n">delay_gain</span><span class="p">)</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">putcol</span><span class="p">(</span><span class="s2">&quot;FLAG&quot;</span><span class="p">,</span> <span class="n">delay_flag</span><span class="p">)</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">caltable</span> <span class="o">+</span> <span class="s2">&quot;.tempbcal&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">caltable</span></div>



<div class="viewcode-block" id="average_timestamp">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.average_timestamp">[docs]</a>
<span class="k">def</span> <span class="nf">average_timestamp</span><span class="p">(</span><span class="n">timestamps</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the average timestamp using astropy from a list of ISO 8601 strings.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    timestamps : list</span>
<span class="sd">        timestamps (list of str): List of timestamp strings in &#39;YYYY-MM-DDTHH:MM:SS&#39; format.</span>

<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    str</span>
<span class="sd">        Average timestamp in &#39;YYYY-MM-DDTHH:MM:SS&#39; format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;isot&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;utc&quot;</span><span class="p">)</span>
    <span class="n">avg_time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">times</span><span class="o">.</span><span class="n">jd</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;jd&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;utc&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">avg_time</span><span class="o">.</span><span class="n">isot</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Strip milliseconds for clean output</span></div>



<div class="viewcode-block" id="make_timeavg_image">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.make_timeavg_image">[docs]</a>
<span class="k">def</span> <span class="nf">make_timeavg_image</span><span class="p">(</span><span class="n">wsclean_images</span><span class="p">,</span> <span class="n">outfile_name</span><span class="p">,</span> <span class="n">keep_wsclean_images</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert WSClean images into a time averaged image</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wsclean_images : list</span>
<span class="sd">        List of WSClean images.</span>
<span class="sd">    outfile_name : str</span>
<span class="sd">        Name of the output file.</span>
<span class="sd">    keep_wsclean_images : bool, optional</span>
<span class="sd">        Whether to retain the original WSClean images (default: True).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Output image name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wsclean_images</span><span class="p">)):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">wsclean_images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">image</span><span class="p">)[</span><span class="s2">&quot;DATE-OBS&quot;</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wsclean_images</span><span class="p">)</span>
    <span class="n">avg_timestamp</span> <span class="o">=</span> <span class="n">average_timestamp</span><span class="p">(</span><span class="n">timestamps</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">wsclean_images</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATE-OBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg_timestamp</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outfile_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_wsclean_images</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">wsclean_images</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">img</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outfile_name</span></div>



<div class="viewcode-block" id="make_freqavg_image">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.make_freqavg_image">[docs]</a>
<span class="k">def</span> <span class="nf">make_freqavg_image</span><span class="p">(</span><span class="n">wsclean_images</span><span class="p">,</span> <span class="n">outfile_name</span><span class="p">,</span> <span class="n">keep_wsclean_images</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert WSClean images into a frequency averaged image</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wsclean_images : list</span>
<span class="sd">        List of WSClean images.</span>
<span class="sd">    outfile_name : str</span>
<span class="sd">        Name of the output file.</span>
<span class="sd">    keep_wsclean_images : bool, optional</span>
<span class="sd">        Whether to retain the original WSClean images (default: True).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Output image name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wsclean_images</span><span class="p">)):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">wsclean_images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CTYPE3&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FREQ&quot;</span><span class="p">:</span>
            <span class="n">freqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRVAL3&quot;</span><span class="p">]))</span>
            <span class="n">freqaxis</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CTYPE4&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FREQ&quot;</span><span class="p">:</span>
            <span class="n">freqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRVAL4&quot;</span><span class="p">]))</span>
            <span class="n">freqaxis</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">data</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wsclean_images</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">mean_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">wsclean_images</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">freqaxis</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRAVL3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_freq</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">width</span>
        <span class="k">elif</span> <span class="n">freqaxis</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRAVL4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_freq</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CDELT4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">width</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outfile_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_wsclean_images</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">wsclean_images</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">img</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outfile_name</span></div>



<div class="viewcode-block" id="get_meermap">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_meermap">[docs]</a>
<span class="k">def</span> <span class="nf">get_meermap</span><span class="p">(</span><span class="n">fits_image</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">do_sharpen</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make MeerKAT sunpy map</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fits_image : str</span>
<span class="sd">        MeerKAT fits image</span>
<span class="sd">    band : str, optional</span>
<span class="sd">        Band name</span>
<span class="sd">    do_sharpen : bool, optional</span>
<span class="sd">        Sharpen the image</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sunpy.map</span>
<span class="sd">        Sunpy map</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">MEERLAT</span> <span class="o">=</span> <span class="o">-</span><span class="mf">30.7133</span>
    <span class="n">MEERLON</span> <span class="o">=</span> <span class="mf">21.4429</span>
    <span class="n">MEERALT</span> <span class="o">=</span> <span class="mf">1086.6</span>
    <span class="n">meer_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fits_image</span><span class="p">)</span>  <span class="c1"># Opening MeerKAT fits file</span>
    <span class="n">meer_header</span> <span class="o">=</span> <span class="n">meer_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>  <span class="c1"># meer header</span>
    <span class="n">meer_data</span> <span class="o">=</span> <span class="n">meer_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meer_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">meer_data</span> <span class="o">=</span> <span class="n">meer_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># meer data</span>
    <span class="k">if</span> <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;CTYPE3&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FREQ&quot;</span><span class="p">:</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;CRVAL3&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span>
    <span class="k">elif</span> <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;CTYPE4&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FREQ&quot;</span><span class="p">:</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;CRVAL4&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">band</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;BAND&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">band</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pixel_unit</span> <span class="o">=</span> <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;BUNIT&quot;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">pixel_nuit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">obstime</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;date-obs&quot;</span><span class="p">])</span>
    <span class="n">meerpos</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="p">(</span>
        <span class="n">lat</span><span class="o">=</span><span class="n">MEERLAT</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">MEERLON</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">MEERALT</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span>
    <span class="p">)</span>
    <span class="n">meer_gcrs</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">meerpos</span><span class="o">.</span><span class="n">get_gcrs</span><span class="p">(</span><span class="n">obstime</span><span class="p">))</span>  <span class="c1"># Converting into GCRS coordinate</span>
    <span class="n">reference_coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
        <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;crval1&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;cunit1&quot;</span><span class="p">]),</span>
        <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;crval2&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;cunit2&quot;</span><span class="p">]),</span>
        <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;gcrs&quot;</span><span class="p">,</span>
        <span class="n">obstime</span><span class="o">=</span><span class="n">obstime</span><span class="p">,</span>
        <span class="n">obsgeoloc</span><span class="o">=</span><span class="n">meer_gcrs</span><span class="o">.</span><span class="n">cartesian</span><span class="p">,</span>
        <span class="n">obsgeovel</span><span class="o">=</span><span class="n">meer_gcrs</span><span class="o">.</span><span class="n">velocity</span><span class="o">.</span><span class="n">to_cartesian</span><span class="p">(),</span>
        <span class="n">distance</span><span class="o">=</span><span class="n">meer_gcrs</span><span class="o">.</span><span class="n">hcrs</span><span class="o">.</span><span class="n">distance</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">reference_coord_arcsec</span> <span class="o">=</span> <span class="n">reference_coord</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span>
        <span class="n">frames</span><span class="o">.</span><span class="n">Helioprojective</span><span class="p">(</span><span class="n">observer</span><span class="o">=</span><span class="n">meer_gcrs</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">cdelt1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;cdelt1&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>
    <span class="n">cdelt2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;cdelt2&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">sun</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="n">obstime</span><span class="p">)</span>  <span class="c1"># Relative rotation angle</span>
    <span class="n">new_meer_header</span> <span class="o">=</span> <span class="n">sunpy</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">make_fitswcs_header</span><span class="p">(</span>
        <span class="n">meer_data</span><span class="p">,</span>
        <span class="n">reference_coord_arcsec</span><span class="p">,</span>
        <span class="n">reference_pixel</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
            <span class="p">[</span><span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;crpix1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;crpix2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pixel</span>
        <span class="p">),</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">([</span><span class="n">cdelt1</span><span class="p">,</span> <span class="n">cdelt2</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span><span class="p">),</span>
        <span class="n">rotation_angle</span><span class="o">=-</span><span class="n">P1</span><span class="p">,</span>
        <span class="n">wavelength</span><span class="o">=</span><span class="n">frequency</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">MHz</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">observatory</span><span class="o">=</span><span class="s2">&quot;MeerKAT&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">do_sharpen</span><span class="p">:</span>
        <span class="n">blurred</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">meer_data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">meer_data</span> <span class="o">=</span> <span class="n">meer_data</span> <span class="o">+</span> <span class="p">(</span><span class="n">meer_data</span> <span class="o">-</span> <span class="n">blurred</span><span class="p">)</span>
    <span class="n">meer_map</span> <span class="o">=</span> <span class="n">Map</span><span class="p">(</span><span class="n">meer_data</span><span class="p">,</span> <span class="n">new_meer_header</span><span class="p">)</span>
    <span class="n">meer_map_rotate</span> <span class="o">=</span> <span class="n">meer_map</span><span class="o">.</span><span class="n">rotate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">meer_map_rotate</span></div>



<div class="viewcode-block" id="plot_in_hpc">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.plot_in_hpc">[docs]</a>
<span class="k">def</span> <span class="nf">plot_in_hpc</span><span class="p">(</span>
    <span class="n">fits_image</span><span class="p">,</span>
    <span class="n">draw_limb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span>
    <span class="n">outdir</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">plot_range</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">power</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1600</span><span class="p">,</span> <span class="mi">1600</span><span class="p">],</span>
    <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1600</span><span class="p">,</span> <span class="mi">1600</span><span class="p">],</span>
    <span class="n">contour_levels</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">band</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">showgui</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to convert MeerKAT image into Helioprojective co-ordinate</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fits_image : str</span>
<span class="sd">        Name of the fits image</span>
<span class="sd">    draw_limb : bool, optional</span>
<span class="sd">        Draw solar limb or not</span>
<span class="sd">    extension : str, optional</span>
<span class="sd">        Output file extension</span>
<span class="sd">    outdir : str, optional</span>
<span class="sd">        Output directory</span>
<span class="sd">    plot_range : list, optional</span>
<span class="sd">        Plot range</span>
<span class="sd">    power : float, optional</span>
<span class="sd">        Power stretch</span>
<span class="sd">    xlim : list</span>
<span class="sd">        X axis limit in arcsecond</span>
<span class="sd">    ylim : list</span>
<span class="sd">        Y axis limit in arcsecond</span>
<span class="sd">    contour_levels : list, optional</span>
<span class="sd">        Contour levels in fraction of peak, both positive and negative values allowed</span>
<span class="sd">    band : str, optional</span>
<span class="sd">        Band name</span>
<span class="sd">    showgui : bool, optional</span>
<span class="sd">        Show GUI</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outfile</span>
<span class="sd">        Saved plot name</span>
<span class="sd">    sunpy.Map</span>
<span class="sd">        MeerKAT image in helioprojective co-ordinate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">MEERLAT</span> <span class="o">=</span> <span class="o">-</span><span class="mf">30.7133</span>
    <span class="n">MEERLON</span> <span class="o">=</span> <span class="mf">21.4429</span>
    <span class="n">MEERALT</span> <span class="o">=</span> <span class="mf">1086.6</span>
    <span class="n">meer_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fits_image</span><span class="p">)</span>  <span class="c1"># Opening MeerKAT fits file</span>
    <span class="n">meer_header</span> <span class="o">=</span> <span class="n">meer_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>  <span class="c1"># meer header</span>
    <span class="n">meer_data</span> <span class="o">=</span> <span class="n">meer_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meer_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">meer_data</span> <span class="o">=</span> <span class="n">meer_data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># meer data</span>
    <span class="k">if</span> <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;CTYPE3&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FREQ&quot;</span><span class="p">:</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;CRVAL3&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span>
    <span class="k">elif</span> <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;CTYPE4&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FREQ&quot;</span><span class="p">:</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;CRVAL4&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Hz</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">band</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;BAND&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">band</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pixel_unit</span> <span class="o">=</span> <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;BUNIT&quot;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">pixel_nuit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">obstime</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;date-obs&quot;</span><span class="p">])</span>
    <span class="n">meerpos</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="p">(</span>
        <span class="n">lat</span><span class="o">=</span><span class="n">MEERLAT</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">MEERLON</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">MEERALT</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span>
    <span class="p">)</span>
    <span class="n">meer_gcrs</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">meerpos</span><span class="o">.</span><span class="n">get_gcrs</span><span class="p">(</span><span class="n">obstime</span><span class="p">))</span>  <span class="c1"># Converting into GCRS coordinate</span>
    <span class="n">reference_coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
        <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;crval1&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;cunit1&quot;</span><span class="p">]),</span>
        <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;crval2&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;cunit2&quot;</span><span class="p">]),</span>
        <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;gcrs&quot;</span><span class="p">,</span>
        <span class="n">obstime</span><span class="o">=</span><span class="n">obstime</span><span class="p">,</span>
        <span class="n">obsgeoloc</span><span class="o">=</span><span class="n">meer_gcrs</span><span class="o">.</span><span class="n">cartesian</span><span class="p">,</span>
        <span class="n">obsgeovel</span><span class="o">=</span><span class="n">meer_gcrs</span><span class="o">.</span><span class="n">velocity</span><span class="o">.</span><span class="n">to_cartesian</span><span class="p">(),</span>
        <span class="n">distance</span><span class="o">=</span><span class="n">meer_gcrs</span><span class="o">.</span><span class="n">hcrs</span><span class="o">.</span><span class="n">distance</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">reference_coord_arcsec</span> <span class="o">=</span> <span class="n">reference_coord</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span>
        <span class="n">frames</span><span class="o">.</span><span class="n">Helioprojective</span><span class="p">(</span><span class="n">observer</span><span class="o">=</span><span class="n">meer_gcrs</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">cdelt1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;cdelt1&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>
    <span class="n">cdelt2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;cdelt2&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">sun</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="n">obstime</span><span class="p">)</span>  <span class="c1"># Relative rotation angle</span>
    <span class="n">new_meer_header</span> <span class="o">=</span> <span class="n">sunpy</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">make_fitswcs_header</span><span class="p">(</span>
        <span class="n">meer_data</span><span class="p">,</span>
        <span class="n">reference_coord_arcsec</span><span class="p">,</span>
        <span class="n">reference_pixel</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
            <span class="p">[</span><span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;crpix1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;crpix2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pixel</span>
        <span class="p">),</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">([</span><span class="n">cdelt1</span><span class="p">,</span> <span class="n">cdelt2</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span><span class="p">),</span>
        <span class="n">rotation_angle</span><span class="o">=-</span><span class="n">P1</span><span class="p">,</span>
        <span class="n">wavelength</span><span class="o">=</span><span class="n">frequency</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">MHz</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">observatory</span><span class="o">=</span><span class="s2">&quot;MeerKAT&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">meer_map</span> <span class="o">=</span> <span class="n">Map</span><span class="p">(</span><span class="n">meer_data</span><span class="p">,</span> <span class="n">new_meer_header</span><span class="p">)</span>
    <span class="n">meer_map_rotate</span> <span class="o">=</span> <span class="n">meer_map</span><span class="o">.</span><span class="n">rotate</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">showgui</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;Agg&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;TkAgg&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outdir</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
    <span class="n">fits_image</span> <span class="o">=</span> <span class="n">fits_image</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contour_levels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">output_image</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">outdir</span>
            <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
            <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fits_image</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.fits&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_contour.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_image</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">outdir</span>
            <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
            <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fits_image</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.fits&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="n">meer_map_rotate</span> <span class="o">=</span> <span class="n">get_meermap</span><span class="p">(</span><span class="n">fits_image</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">)</span>
    <span class="n">top_right</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
        <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">meer_map_rotate</span><span class="o">.</span><span class="n">coordinate_frame</span>
    <span class="p">)</span>
    <span class="n">bottom_left</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
        <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">meer_map_rotate</span><span class="o">.</span><span class="n">coordinate_frame</span>
    <span class="p">)</span>
    <span class="n">cropped_map</span> <span class="o">=</span> <span class="n">meer_map_rotate</span><span class="o">.</span><span class="n">submap</span><span class="p">(</span><span class="n">bottom_left</span><span class="p">,</span> <span class="n">top_right</span><span class="o">=</span><span class="n">top_right</span><span class="p">)</span>
    <span class="n">meer_data</span> <span class="o">=</span> <span class="n">cropped_map</span><span class="o">.</span><span class="n">data</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_range</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span>
            <span class="n">meer_data</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="mf">0.03</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">meer_data</span><span class="p">),</span>
            <span class="n">vmax</span><span class="o">=</span><span class="mf">0.99</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">meer_data</span><span class="p">),</span>
            <span class="n">stretch</span><span class="o">=</span><span class="n">PowerStretch</span><span class="p">(</span><span class="n">power</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span>
            <span class="n">meer_data</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">plot_range</span><span class="p">),</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">plot_range</span><span class="p">),</span>
            <span class="n">stretch</span><span class="o">=</span><span class="n">PowerStretch</span><span class="p">(</span><span class="n">power</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">band</span> <span class="o">==</span> <span class="s2">&quot;U&quot;</span><span class="p">:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;inferno&quot;</span>
        <span class="n">pos_color</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>
        <span class="n">neg_color</span> <span class="o">=</span> <span class="s2">&quot;cyan&quot;</span>
    <span class="k">elif</span> <span class="n">band</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span>
        <span class="n">pos_color</span> <span class="o">=</span> <span class="s2">&quot;hotpink&quot;</span>
        <span class="n">neg_color</span> <span class="o">=</span> <span class="s2">&quot;yellow&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;YlGnBu_inferno&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plt</span><span class="o">.</span><span class="n">colormaps</span><span class="p">():</span>
            <span class="c1"># Sample YlGnBu_r colormap with 256 colors</span>
            <span class="n">cmap_ylgnbu</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;YlGnBu_r&quot;</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">cmap_ylgnbu</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
            <span class="c1"># Create perceptually linear spacing using inferno luminance</span>
            <span class="n">cmap_inferno</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;inferno&quot;</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
            <span class="c1"># Sort YlGnBu colors by the inferred brightness from inferno</span>
            <span class="n">luminance_ranks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cmap_inferno</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">))[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">colors_uniform</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">luminance_ranks</span><span class="p">]</span>
            <span class="c1"># New perceptual-YlGnBu-inspired colormap</span>
            <span class="n">YlGnBu_inferno</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">colors_uniform</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;YlGnBu_inferno&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colormaps</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;YlGnBu_inferno&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">YlGnBu_inferno</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;YlGnBu_inferno&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;cubehelix&quot;</span>
        <span class="n">pos_color</span> <span class="o">=</span> <span class="s2">&quot;cyan&quot;</span>
        <span class="n">neg_color</span> <span class="o">=</span> <span class="s2">&quot;gold&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">cropped_map</span><span class="p">)</span>
    <span class="n">cropped_map</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contour_levels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">contour_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">contour_levels</span><span class="p">)</span>
        <span class="n">pos_cont</span> <span class="o">=</span> <span class="n">contour_levels</span><span class="p">[</span><span class="n">contour_levels</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">neg_cont</span> <span class="o">=</span> <span class="n">contour_levels</span><span class="p">[</span><span class="n">contour_levels</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_cont</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cropped_map</span><span class="o">.</span><span class="n">draw_contours</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">pos_cont</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">meer_data</span><span class="p">),</span> <span class="n">colors</span><span class="o">=</span><span class="n">pos_color</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_cont</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cropped_map</span><span class="o">.</span><span class="n">draw_contours</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">neg_cont</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">meer_data</span><span class="p">),</span> <span class="n">colors</span><span class="o">=</span><span class="n">neg_color</span>
            <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">rgba_vmin</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)(</span><span class="n">norm</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">vmin</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">rgba_vmin</span><span class="p">)</span>
    <span class="c1"># Read synthesized beam from header</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">bmaj</span> <span class="o">=</span> <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>  <span class="c1"># in arcsec</span>
        <span class="n">bmin</span> <span class="o">=</span> <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;BMIN&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>
        <span class="n">bpa</span> <span class="o">=</span> <span class="n">meer_header</span><span class="p">[</span><span class="s2">&quot;BPA&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">sun</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="n">obstime</span><span class="p">)</span><span class="o">.</span><span class="n">deg</span>  <span class="c1"># in degrees</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">bmaj</span> <span class="o">=</span> <span class="n">bmin</span> <span class="o">=</span> <span class="n">bpa</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Plot PSF ellipse in bottom-left if all values are present</span>
    <span class="k">if</span> <span class="n">bmaj</span> <span class="ow">and</span> <span class="n">bmin</span> <span class="ow">and</span> <span class="n">bpa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Coordinates where to place the beam (e.g., 5% above bottom-left corner)</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
        <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

        <span class="n">beam_center</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
            <span class="n">x0</span> <span class="o">+</span> <span class="mf">0.08</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">),</span>
            <span class="n">y0</span> <span class="o">+</span> <span class="mf">0.08</span> <span class="o">*</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">),</span>
            <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span>
            <span class="n">frame</span><span class="o">=</span><span class="n">cropped_map</span><span class="o">.</span><span class="n">coordinate_frame</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Add ellipse patch</span>
        <span class="n">beam_ellipse</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="p">(</span>
            <span class="p">(</span><span class="n">beam_center</span><span class="o">.</span><span class="n">Tx</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">beam_center</span><span class="o">.</span><span class="n">Ty</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>  <span class="c1"># center in arcsec</span>
            <span class="n">width</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">bmaj</span><span class="p">,</span>
            <span class="n">angle</span><span class="o">=</span><span class="n">bpa</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
            <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">beam_ellipse</span><span class="p">)</span>
        <span class="c1"># Draw square box around the ellipse</span>
        <span class="n">box_size</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># slightly bigger than beam</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">(</span>
            <span class="p">(</span><span class="n">beam_center</span><span class="o">.</span><span class="n">Tx</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">box_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">beam_center</span><span class="o">.</span><span class="n">Ty</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">box_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">width</span><span class="o">=</span><span class="n">box_size</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">box_size</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">draw_limb</span><span class="p">:</span>
        <span class="n">cropped_map</span><span class="o">.</span><span class="n">draw_limb</span><span class="p">()</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">:</span><span class="s2">.0e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="n">formatter</span><span class="p">)</span>
    <span class="c1"># Optional: set max 5 ticks to prevent clutter</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">pixel_unit</span> <span class="o">==</span> <span class="s2">&quot;K&quot;</span><span class="p">:</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Brightness temperature (K)&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pixel_unit</span> <span class="o">==</span> <span class="s2">&quot;JY/BEAM&quot;</span><span class="p">:</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Flux density (Jy/beam)&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_image</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">showgui</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_image</span><span class="p">,</span> <span class="n">cropped_map</span></div>



<div class="viewcode-block" id="make_stokes_wsclean_imagecube">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.make_stokes_wsclean_imagecube">[docs]</a>
<span class="k">def</span> <span class="nf">make_stokes_wsclean_imagecube</span><span class="p">(</span>
    <span class="n">wsclean_images</span><span class="p">,</span> <span class="n">outfile_name</span><span class="p">,</span> <span class="n">keep_wsclean_images</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert WSClean images into a Stokes cube image.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wsclean_images : list</span>
<span class="sd">        List of WSClean images.</span>
<span class="sd">    outfile_name : str</span>
<span class="sd">        Name of the output file.</span>
<span class="sd">    keep_wsclean_images : bool, optional</span>
<span class="sd">        Whether to retain the original WSClean images (default: True).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Output image name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stokes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="nb">set</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.fits&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; - &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot; - &quot;</span> <span class="ow">in</span> <span class="n">i</span>
                <span class="k">else</span> <span class="s2">&quot;I&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wsclean_images</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">valid_stokes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;I&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;XX&quot;</span><span class="p">,</span> <span class="s2">&quot;YY&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;LL&quot;</span><span class="p">,</span> <span class="s2">&quot;RR&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;Q&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">stokes</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_stokes</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid Stokes combination.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">imagename_prefix</span> <span class="o">=</span> <span class="s2">&quot;temp_&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">wsclean_images</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; - I&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">imagename</span> <span class="o">=</span> <span class="n">imagename_prefix</span> <span class="o">+</span> <span class="s2">&quot;.image&quot;</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">wsclean_images</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">wsclean_images</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">wsclean_images</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;NAXIS4&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">stokes</span><span class="p">),</span> <span class="s2">&quot;CRVAL4&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="s2">&quot;I&quot;</span> <span class="ow">in</span> <span class="n">stokes</span> <span class="k">else</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;CDELT4&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">temp_fits</span> <span class="o">=</span> <span class="n">imagename_prefix</span> <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outfile_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_wsclean_images</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">wsclean_images</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">img</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outfile_name</span></div>



<div class="viewcode-block" id="do_flag_backup">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.do_flag_backup">[docs]</a>
<span class="k">def</span> <span class="nf">do_flag_backup</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">flagtype</span><span class="o">=</span><span class="s2">&quot;flagdata&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take a flag backup</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Measurement set name</span>
<span class="sd">    flagtype : str, optional</span>
<span class="sd">        Flag type</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">af</span> <span class="o">=</span> <span class="n">agentflagger</span><span class="p">()</span>
    <span class="n">af</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">versionlist</span> <span class="o">=</span> <span class="n">af</span><span class="o">.</span><span class="n">getflagversionlist</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">versionlist</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">version_name</span> <span class="ow">in</span> <span class="n">versionlist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">flagtype</span> <span class="ow">in</span> <span class="n">version_name</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">version_num</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">version_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">version_num</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">version_num</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">version_num</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">dt_string</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
    <span class="n">af</span><span class="o">.</span><span class="n">saveflagversion</span><span class="p">(</span>
        <span class="n">flagtype</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">version_num</span><span class="p">),</span> <span class="s2">&quot;Flags autosave on &quot;</span> <span class="o">+</span> <span class="n">dt_string</span>
    <span class="p">)</span>
    <span class="n">af</span><span class="o">.</span><span class="n">done</span><span class="p">()</span></div>



<div class="viewcode-block" id="merge_caltables">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.merge_caltables">[docs]</a>
<span class="k">def</span> <span class="nf">merge_caltables</span><span class="p">(</span><span class="n">caltables</span><span class="p">,</span> <span class="n">merged_caltable</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">keepcopy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge multiple same type of caltables</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    caltables : list</span>
<span class="sd">        Caltable list</span>
<span class="sd">    merged_caltable : str</span>
<span class="sd">        Merged caltable name</span>
<span class="sd">    append : bool, optional</span>
<span class="sd">        Append with exisiting caltable</span>
<span class="sd">    keepcopy : bool, opitonal</span>
<span class="sd">        Keep input caltables or not</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Merged caltable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">caltables</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">caltables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide a list of caltable.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">merged_caltable</span><span class="p">)</span> <span class="ow">and</span> <span class="n">append</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">merged_caltable</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">merged_caltable</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keepcopy</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;cp -r &quot;</span> <span class="o">+</span> <span class="n">caltables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">merged_caltable</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mv &quot;</span> <span class="o">+</span> <span class="n">caltables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">merged_caltable</span><span class="p">)</span>
        <span class="n">caltables</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">caltables</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">caltables</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">table</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">caltable</span> <span class="ow">in</span> <span class="n">caltables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">caltable</span><span class="p">):</span>
                <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">caltable</span><span class="p">)</span>
                <span class="n">tb</span><span class="o">.</span><span class="n">copyrows</span><span class="p">(</span><span class="n">merged_caltable</span><span class="p">)</span>
                <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">keepcopy</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">caltable</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">merged_caltable</span></div>


<div class="viewcode-block" id="get_nprocess_meersolar">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_nprocess_meersolar">[docs]</a>
<span class="k">def</span> <span class="nf">get_nprocess_meersolar</span><span class="p">(</span><span class="n">jobid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get numbers of MeerSOLAR processes currently running</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Work directory name</span>
<span class="sd">    jobid : int</span>
<span class="sd">        MeerSOLAR Job ID</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Number of running processes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">get_datadir</span><span class="p">()</span>
    <span class="n">pid_file</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/pids/pids_</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">.txt&quot;</span>
    <span class="n">pids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">pid_file</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">n_process</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">psutil</span><span class="o">.</span><span class="n">pid_exists</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pid</span><span class="p">)):</span>
            <span class="n">n_process</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">n_process</span></div>



<div class="viewcode-block" id="save_pid">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.save_pid">[docs]</a>
<span class="k">def</span> <span class="nf">save_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">pid_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save PID</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pid : int</span>
<span class="sd">        Process ID</span>
<span class="sd">    pid_file : str</span>
<span class="sd">        File to save</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pid_file</span><span class="p">):</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">pid_file</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pids</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pid</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">pid_file</span><span class="p">,</span> <span class="n">pids</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_jobid">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_jobid">[docs]</a>
<span class="k">def</span> <span class="nf">get_jobid</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get MeerSOLAR Job ID with millisecond-level uniqueness.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Job ID in the format YYYYMMDDHHMMSSmmm (milliseconds)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">get_datadir</span><span class="p">()</span>
    <span class="n">jobid_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;jobids.txt&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">jobid_file</span><span class="p">):</span>
        <span class="n">prev_jobids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">jobid_file</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prev_jobids</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">prev_jobids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">prev_jobids</span><span class="p">):</span>
            <span class="n">prev_jobids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">prev_jobids</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prev_jobids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span> <span class="k">for</span> <span class="n">jid</span> <span class="ow">in</span> <span class="n">prev_jobids</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prev_jobids</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prev_jobids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S</span><span class="si">%f</span><span class="s2">&quot;</span>
        <span class="n">CUTOFF</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">filtered_prev_jobids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">prev_jobids</span><span class="p">:</span>
            <span class="n">job_time</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">job_id</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span> <span class="n">FORMAT</span><span class="p">)</span>  <span class="c1"># pad if truncated</span>
            <span class="k">if</span> <span class="n">job_time</span> <span class="o">&gt;=</span> <span class="n">CUTOFF</span><span class="p">:</span>
                <span class="n">filtered_prev_jobids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="n">prev_jobids</span> <span class="o">=</span> <span class="n">filtered_prev_jobids</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="n">cur_jobid</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">microsecond</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># ms = first 3 digits of microseconds</span>
    <span class="n">prev_jobids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_jobid</span><span class="p">)</span>

    <span class="n">job_ids_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prev_jobids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">jobid_file</span><span class="p">,</span> <span class="n">job_ids_int</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">cur_jobid</span><span class="p">)</span></div>



<div class="viewcode-block" id="save_main_process_info">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.save_main_process_info">[docs]</a>
<span class="k">def</span> <span class="nf">save_main_process_info</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">basedir</span><span class="p">,</span> <span class="n">cpu_frac</span><span class="p">,</span> <span class="n">mem_frac</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save MeerSOLAR main processes info</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pid : int</span>
<span class="sd">        Main job process id</span>
<span class="sd">    jobid : int</span>
<span class="sd">        MeerSOLAR Job ID</span>
<span class="sd">    basedir : str</span>
<span class="sd">        Base directory</span>
<span class="sd">    cpu_frac : float</span>
<span class="sd">        CPU fraction of the job</span>
<span class="sd">    mem_frac : float</span>
<span class="sd">        Mempry fraction of the job</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Job info file name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">get_datadir</span><span class="p">()</span>
    <span class="n">prev_main_pids</span><span class="o">=</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datadir</span><span class="si">}</span><span class="s2">/main_pids_*.txt&quot;</span><span class="p">)</span>
    <span class="n">prev_jobids</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;.txt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;main_pids_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prev_main_pids</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prev_jobids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S</span><span class="si">%f</span><span class="s2">&quot;</span>
        <span class="n">CUTOFF</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">filtered_prev_jobids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prev_jobids</span><span class="p">)):</span>
            <span class="n">job_id</span><span class="o">=</span><span class="n">prev_jobids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">job_time</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">job_id</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span> <span class="n">FORMAT</span><span class="p">)</span>  <span class="c1"># pad if truncated</span>
            <span class="k">if</span> <span class="n">job_time</span> <span class="o">&lt;</span> <span class="n">CUTOFF</span><span class="p">:</span>
                <span class="n">filtered_prev_jobids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">prev_main_pids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datadir</span><span class="si">}</span><span class="s2">/pids/pids_</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">datadir</span><span class="si">}</span><span class="s2">/pids/pids_</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>    
    <span class="n">main_job_file</span> <span class="o">=</span> <span class="n">datadir</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/main_pids_</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2">.txt&quot;</span>
    <span class="n">main_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jobid</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">basedir</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cpu_frac</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">mem_frac</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">main_job_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">main_str</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">main_job_file</span></div>



<div class="viewcode-block" id="create_batch_script_nonhpc">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.create_batch_script_nonhpc">[docs]</a>
<span class="k">def</span> <span class="nf">create_batch_script_nonhpc</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">write_logfile</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to make a batch script not non-HPC environment</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cmd : str</span>
<span class="sd">        Command to run</span>
<span class="sd">    workdir : str</span>
<span class="sd">        Work directory of the measurement set</span>
<span class="sd">    basename : str</span>
<span class="sd">        Base name of the batch files</span>
<span class="sd">    write_logfile : bool, optional</span>
<span class="sd">        Write log file or not</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Batch file name</span>
<span class="sd">    str</span>
<span class="sd">        Log file name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">datadir</span> <span class="o">=</span> <span class="n">get_datadir</span><span class="p">()</span>
    <span class="n">batch_file</span> <span class="o">=</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s2">&quot;.batch&quot;</span>
    <span class="n">cmd_batch</span> <span class="o">=</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s2">&quot;_cmd.batch&quot;</span>
    <span class="n">finished_touch_file</span> <span class="o">=</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/.Finished_&quot;</span> <span class="o">+</span> <span class="n">basename</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">finished_touch_file</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
    <span class="n">finished_touch_file_error</span> <span class="o">=</span> <span class="n">finished_touch_file</span> <span class="o">+</span> <span class="s2">&quot;_1&quot;</span>
    <span class="n">finished_touch_file_success</span> <span class="o">=</span> <span class="n">finished_touch_file</span> <span class="o">+</span> <span class="s2">&quot;_0&quot;</span>
    <span class="n">cmd_file_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">; exit_code=$?; if [ $exit_code -ne 0 ]; then touch </span><span class="si">{</span><span class="n">finished_touch_file_error</span><span class="si">}</span><span class="s2">; else touch </span><span class="si">{</span><span class="n">finished_touch_file_success</span><span class="si">}</span><span class="s2">; fi&quot;</span>
    <span class="k">if</span> <span class="n">write_logfile</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs&quot;</span><span class="p">)</span>
        <span class="n">outputfile</span> <span class="o">=</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/logs/&quot;</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputfile</span> <span class="o">=</span> <span class="s2">&quot;/dev/null&quot;</span>
    <span class="n">batch_file_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;export PYTHONUNBUFFERED=1</span><span class="se">\n</span><span class="s2">nohup sh </span><span class="si">{</span><span class="n">cmd_batch</span><span class="si">}</span><span class="s2">&gt; </span><span class="si">{</span><span class="n">outputfile</span><span class="si">}</span><span class="s2"> 2&gt;&amp;1 &amp;</span><span class="se">\n</span><span class="s2">sleep 2</span><span class="se">\n</span><span class="s2"> rm -rf </span><span class="si">{</span><span class="n">batch_file</span><span class="si">}</span><span class="se">\n</span><span class="s2"> rm -rf </span><span class="si">{</span><span class="n">cmd_batch</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cmd_batch</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">cmd_batch</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">batch_file</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">batch_file</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cmd_batch</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cmd_batch_file</span><span class="p">:</span>
        <span class="n">cmd_batch_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cmd_file_content</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">batch_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">b_file</span><span class="p">:</span>
        <span class="n">b_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">batch_file_content</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;chmod a+rwx &quot;</span> <span class="o">+</span> <span class="n">batch_file</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;chmod a+rwx &quot;</span> <span class="o">+</span> <span class="n">cmd_batch</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">cmd</span>
    <span class="k">return</span> <span class="n">workdir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">basename</span> <span class="o">+</span> <span class="s2">&quot;.batch&quot;</span></div>



<div class="viewcode-block" id="get_dask_client">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_dask_client">[docs]</a>
<span class="k">def</span> <span class="nf">get_dask_client</span><span class="p">(</span>
    <span class="n">n_jobs</span><span class="p">,</span>
    <span class="n">dask_dir</span><span class="p">,</span>
    <span class="n">cpu_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">mem_frac</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">spill_frac</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
    <span class="n">min_mem_per_job</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">min_cpu_per_job</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">only_cal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a Dask client optimized for one-task-per-worker execution,</span>
<span class="sd">    where each worker is a separate process that can use multiple threads internally.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_jobs : int</span>
<span class="sd">        Number of MS tasks (ideally = number of MS files)</span>
<span class="sd">    dask_dir : str</span>
<span class="sd">        Dask temporary directory</span>
<span class="sd">    cpu_frac : float</span>
<span class="sd">        Fraction of total CPUs to use</span>
<span class="sd">    mem_frac : float</span>
<span class="sd">        Fraction of total memory to use</span>
<span class="sd">    spill_frac : float, optional</span>
<span class="sd">        Spill to disk at this fraction</span>
<span class="sd">    min_mem_per_job : float, optional</span>
<span class="sd">        Minimum memory per job</span>
<span class="sd">    min_cpu_per_job : int, optional</span>
<span class="sd">        Minimum CPU threads per job</span>
<span class="sd">    only_cal : bool, optional</span>
<span class="sd">        Only calculate number of workers</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    client : dask.distributed.Client</span>
<span class="sd">        Dask clinet</span>
<span class="sd">    cluster : dask.distributed.LocalCluster</span>
<span class="sd">        Dask cluster</span>
<span class="sd">    n_workers : int</span>
<span class="sd">        Number of workers</span>
<span class="sd">    threads_per_worker : int</span>
<span class="sd">        Threads per worker to use</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create the Dask temporary working directory if it does not already exist</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dask_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dask_dir_tmp</span> <span class="o">=</span> <span class="n">dask_dir</span> <span class="o">+</span> <span class="s2">&quot;/tmp&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dask_dir_tmp</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Detect total system resources</span>
    <span class="n">total_cpus</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(</span><span class="n">logical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Total logical CPU cores</span>
    <span class="n">total_mem</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">total</span>  <span class="c1"># Total system memory (bytes)</span>
    <span class="k">if</span> <span class="n">cpu_frac</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Given CPU fraction is more than 80%. Resetting to 80% to avoid system crash.&quot;</span>
        <span class="p">)</span>
        <span class="n">cpu_frac</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="k">if</span> <span class="n">mem_frac</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Given memory fraction is more than 80%. Resetting to 80% to avoid system crash.&quot;</span>
        <span class="p">)</span>
        <span class="n">mem_frac</span> <span class="o">=</span> <span class="mf">0.8</span>

    <span class="c1">############################################</span>
    <span class="c1"># Wait until enough free CPU is available</span>
    <span class="c1">############################################</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">available_cpu_pct</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">(</span>
            <span class="n">interval</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>  <span class="c1"># Percent CPUs currently free</span>
        <span class="n">available_cpus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">total_cpus</span> <span class="o">*</span> <span class="n">available_cpu_pct</span> <span class="o">/</span> <span class="mf">100.0</span>
        <span class="p">)</span>  <span class="c1"># Number of free CPU cores</span>
        <span class="n">usable_cpus</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_cpus</span> <span class="o">*</span> <span class="n">cpu_frac</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># Target number of CPU cores we want available based on cpu_frac</span>
        <span class="k">if</span> <span class="n">available_cpus</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="mf">0.5</span> <span class="o">*</span> <span class="n">usable_cpus</span>
        <span class="p">):</span>  <span class="c1"># Enough free CPUs (at-least more than 50%), exit loop</span>
            <span class="n">usable_cpus</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">usable_cpus</span><span class="p">,</span> <span class="n">available_cpus</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting for available free CPUs...&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Wait a bit and retry</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1">############################################</span>
    <span class="c1"># Wait until enough free memory is available</span>
    <span class="c1">############################################</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">available_mem</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">available</span>
        <span class="p">)</span>  <span class="c1"># Current available system memory (bytes)</span>
        <span class="n">usable_mem</span> <span class="o">=</span> <span class="n">total_mem</span> <span class="o">*</span> <span class="n">mem_frac</span>  <span class="c1"># Target usable memory based on mem_frac</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">available_mem</span> <span class="o">&gt;=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">usable_mem</span>
        <span class="p">):</span>  <span class="c1"># Enough free memory, (at-least more than 50%) exit loop</span>
            <span class="n">usable_mem</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">usable_mem</span><span class="p">,</span> <span class="n">available_mem</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting for available free memory...&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Wait and retry</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1">############################################</span>
    <span class="c1"># Calculate memory per worker</span>
    <span class="c1">############################################</span>
    <span class="n">mem_per_worker</span> <span class="o">=</span> <span class="n">usable_mem</span> <span class="o">/</span> <span class="n">n_jobs</span>  <span class="c1"># Assume initially one job per worker</span>
    <span class="c1"># Apply minimum memory per worker constraint</span>
    <span class="n">min_mem_per_job</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
        <span class="n">min_mem_per_job</span><span class="p">,</span> <span class="mi">2</span>
    <span class="p">)</span>  <span class="c1"># Ensure min_mem_per_job is a clean float</span>
    <span class="k">if</span> <span class="n">min_mem_per_job</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mem_per_worker</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">min_mem_per_job</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">):</span>
        <span class="c1"># If calculated memory per worker is smaller than user-requested minimum, adjust number of workers</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Total memory per job is smaller than </span><span class="si">{</span><span class="n">min_mem_per_job</span><span class="si">}</span><span class="s2"> GB. Adjusting total number of workers to meet this.&quot;</span>
        <span class="p">)</span>
        <span class="n">mem_per_worker</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">min_mem_per_job</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span>
        <span class="p">)</span>  <span class="c1"># Reset memory per worker to minimum allowed</span>
        <span class="n">n_workers</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="n">n_jobs</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">usable_mem</span> <span class="o">/</span> <span class="n">mem_per_worker</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># Reduce number of workers accordingly</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Otherwise, just keep n_jobs workers</span>
        <span class="n">n_workers</span> <span class="o">=</span> <span class="n">n_jobs</span>

    <span class="c1">#########################################</span>
    <span class="c1"># Cap number of workers to available CPUs</span>
    <span class="n">n_workers</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_workers</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">usable_cpus</span> <span class="o">/</span> <span class="n">min_cpu_per_job</span><span class="p">))</span>
    <span class="p">)</span>  <span class="c1"># Prevent CPU oversubscription</span>
    <span class="c1"># Recalculate final memory per worker based on capped n_workers</span>
    <span class="n">mem_per_worker</span> <span class="o">=</span> <span class="n">usable_mem</span> <span class="o">/</span> <span class="n">n_workers</span>
    <span class="c1"># Calculate threads per worker</span>
    <span class="n">threads_per_worker</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="mi">1</span><span class="p">,</span> <span class="n">usable_cpus</span> <span class="o">//</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_workers</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># Each worker gets min_cpu_per_job or more threads</span>

    <span class="c1">##########################################</span>
    <span class="k">if</span> <span class="n">only_cal</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#################################&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Dask workers: </span><span class="si">{</span><span class="n">n_workers</span><span class="si">}</span><span class="s2">, Threads per worker: </span><span class="si">{</span><span class="n">threads_per_worker</span><span class="si">}</span><span class="s2">, Mem/worker: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_per_worker</span><span class="o">/</span><span class="p">(</span><span class="mf">1024.0</span><span class="o">**</span><span class="mi">3</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> GB&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#################################&quot;</span><span class="p">)</span>
    <span class="c1"># Memory control settings</span>
    <span class="n">swap</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">swap_memory</span><span class="p">()</span>
    <span class="n">swap_gb</span> <span class="o">=</span> <span class="n">swap</span><span class="o">.</span><span class="n">total</span> <span class="o">/</span> <span class="mf">1024.0</span><span class="o">**</span><span class="mi">3</span>
    <span class="k">if</span> <span class="n">swap_gb</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">swap_gb</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">spill_frac</span> <span class="o">=</span> <span class="mf">0.6</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spill_frac</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="k">if</span> <span class="n">spill_frac</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>
        <span class="n">spill_frac</span> <span class="o">=</span> <span class="mf">0.7</span>
    <span class="k">if</span> <span class="n">only_cal</span><span class="p">:</span>
        <span class="n">final_mem_per_worker</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">mem_per_worker</span> <span class="o">*</span> <span class="n">spill_frac</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1024.0</span><span class="o">**</span><span class="mi">3</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_workers</span><span class="p">,</span> <span class="n">threads_per_worker</span><span class="p">,</span> <span class="n">final_mem_per_worker</span>

    <span class="n">soft</span><span class="p">,</span> <span class="n">hard</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_NOFILE</span><span class="p">)</span>
    <span class="n">new_soft</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hard</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">),</span> <span class="n">hard</span><span class="p">)</span>  <span class="c1"># safe cap</span>
    <span class="k">if</span> <span class="n">soft</span> <span class="o">&lt;</span> <span class="n">new_soft</span><span class="p">:</span>
        <span class="n">resource</span><span class="o">.</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_NOFILE</span><span class="p">,</span> <span class="p">(</span><span class="n">new_soft</span><span class="p">,</span> <span class="n">hard</span><span class="p">))</span>
    <span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">({</span><span class="s2">&quot;temporary-directory&quot;</span><span class="p">:</span> <span class="n">dask_dir</span><span class="p">})</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="n">LocalCluster</span><span class="p">(</span>
        <span class="n">n_workers</span><span class="o">=</span><span class="n">n_workers</span><span class="p">,</span>
        <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># one python-thread per worker, in workers OpenMP threads can be used</span>
        <span class="n">memory_limit</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">mem_per_worker</span><span class="o">/</span><span class="p">(</span><span class="mf">1024.0</span><span class="o">**</span><span class="mi">3</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">GB&quot;</span><span class="p">,</span>
        <span class="n">local_directory</span><span class="o">=</span><span class="n">dask_dir</span><span class="p">,</span>
        <span class="n">processes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># one process per worker</span>
        <span class="n">dashboard_address</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;TMPDIR&quot;</span><span class="p">:</span> <span class="n">dask_dir_tmp</span><span class="p">,</span>
            <span class="s2">&quot;TMP&quot;</span><span class="p">:</span> <span class="n">dask_dir_tmp</span><span class="p">,</span>
            <span class="s2">&quot;TEMP&quot;</span><span class="p">:</span> <span class="n">dask_dir_tmp</span><span class="p">,</span>
            <span class="s2">&quot;DASK_TEMPORARY_DIRECTORY&quot;</span><span class="p">:</span> <span class="n">dask_dir</span><span class="p">,</span>
            <span class="s2">&quot;MALLOC_TRIM_THRESHOLD_&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
        <span class="p">},</span>  <span class="c1"># Explicitly set for workers</span>
    <span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="s2">&quot;60s&quot;</span><span class="p">,</span> <span class="n">heartbeat_interval</span><span class="o">=</span><span class="s2">&quot;5s&quot;</span><span class="p">)</span>
    <span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;distributed.worker.memory.target&quot;</span><span class="p">:</span> <span class="n">spill_frac</span><span class="p">,</span>
            <span class="s2">&quot;distributed.worker.memory.spill&quot;</span><span class="p">:</span> <span class="n">spill_frac</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="s2">&quot;distributed.worker.memory.pause&quot;</span><span class="p">:</span> <span class="n">spill_frac</span> <span class="o">+</span> <span class="mf">0.2</span><span class="p">,</span>
            <span class="s2">&quot;distributed.worker.memory.terminate&quot;</span><span class="p">:</span> <span class="n">spill_frac</span> <span class="o">+</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">client</span><span class="o">.</span><span class="n">run_on_scheduler</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">)</span>
    <span class="n">final_mem_per_worker</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">mem_per_worker</span> <span class="o">*</span> <span class="n">spill_frac</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1024.0</span><span class="o">**</span><span class="mi">3</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">client</span><span class="p">,</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">n_workers</span><span class="p">,</span> <span class="n">threads_per_worker</span><span class="p">,</span> <span class="n">final_mem_per_worker</span></div>



<div class="viewcode-block" id="run_limited_memory_task">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.run_limited_memory_task">[docs]</a>
<span class="k">def</span> <span class="nf">run_limited_memory_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">dask_dir</span><span class="o">=</span><span class="s2">&quot;/tmp&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a task for a limited time, then kill and return memory usage.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    task : dask.delayed</span>
<span class="sd">        Dask delayed task object</span>
<span class="sd">    timeout : int</span>
<span class="sd">        Time in seconds to let the task run</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Memory used by task (in GB)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">warnings</span>

    <span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">({</span><span class="s2">&quot;temporary-directory&quot;</span><span class="p">:</span> <span class="n">dask_dir</span><span class="p">})</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="n">LocalCluster</span><span class="p">(</span>
        <span class="n">n_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># one python-thread per worker, in workers OpenMP threads can be used</span>
        <span class="n">local_directory</span><span class="o">=</span><span class="n">dask_dir</span><span class="p">,</span>
        <span class="n">processes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># one process per worker</span>
        <span class="n">dashboard_address</span><span class="o">=</span><span class="s2">&quot;:0&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_worker_memory_info</span><span class="p">():</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;rss_GB&quot;</span><span class="p">:</span> <span class="n">proc</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;vms_GB&quot;</span><span class="p">:</span> <span class="n">proc</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">vms</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">future</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mem_info</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">get_worker_memory_info</span><span class="p">)</span>
                <span class="n">total_rss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;rss_GB&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mem_info</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">per_worker_mem</span> <span class="o">=</span> <span class="n">total_rss</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">per_worker_mem</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">cluster</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">per_worker_mem</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mem_info</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">get_worker_memory_info</span><span class="p">)</span>
    <span class="n">total_rss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;rss_GB&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mem_info</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">per_worker_mem</span> <span class="o">=</span> <span class="n">total_rss</span>
    <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">cluster</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">per_worker_mem</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>



<div class="viewcode-block" id="baseline_names">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.baseline_names">[docs]</a>
<span class="k">def</span> <span class="nf">baseline_names</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get baseline names</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Measurement set name</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Baseline names list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mstool</span> <span class="o">=</span> <span class="n">casamstool</span><span class="p">()</span>
    <span class="n">mstool</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">ants</span> <span class="o">=</span> <span class="n">mstool</span><span class="o">.</span><span class="n">getdata</span><span class="p">([</span><span class="s2">&quot;antenna1&quot;</span><span class="p">,</span> <span class="s2">&quot;antenna2&quot;</span><span class="p">])</span>
    <span class="n">mstool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">baseline_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ants</span><span class="p">[</span><span class="s2">&quot;antenna1&quot;</span><span class="p">],</span> <span class="n">ants</span><span class="p">[</span><span class="s2">&quot;antenna2&quot;</span><span class="p">]))</span>
    <span class="n">baseline_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ant1</span><span class="p">,</span> <span class="n">ant2</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">baseline_ids</span><span class="p">):</span>
        <span class="n">baseline_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ant1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&amp;&amp;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ant2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">baseline_names</span></div>



<div class="viewcode-block" id="get_ms_size">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_ms_size">[docs]</a>
<span class="k">def</span> <span class="nf">get_ms_size</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get measurement set total size</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Size in GB</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">total_size</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">total_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># in GB</span></div>



<div class="viewcode-block" id="get_column_size">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_column_size">[docs]</a>
<span class="k">def</span> <span class="nf">get_column_size</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get time chunk size for a memory limit</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Measurement set</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        A single datacolumn data size in GB</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">nrow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">nrows</span><span class="p">())</span>
    <span class="n">nchan</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">nchan</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">npol</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">ncorrforpol</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">datasize</span> <span class="o">=</span> <span class="n">nrow</span> <span class="o">*</span> <span class="n">nchan</span> <span class="o">*</span> <span class="n">npol</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1024.0</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">datasize</span></div>



<div class="viewcode-block" id="get_chunk_size">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.get_chunk_size">[docs]</a>
<span class="k">def</span> <span class="nf">get_chunk_size</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">memory_limit</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get time chunk size for a memory limit</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Measurement set</span>
<span class="sd">    memory_limit : int, optional</span>
<span class="sd">        Memory limit</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Number of chunks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">memory_limit</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">memory_limit</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">available</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span>  <span class="c1"># In GB</span>
    <span class="n">col_size</span> <span class="o">=</span> <span class="n">get_column_size</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">nchunk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_size</span> <span class="o">/</span> <span class="n">memory_limit</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nchunk</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">nchunk</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">nchunk</span></div>



<div class="viewcode-block" id="check_datacolumn_valid">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.check_datacolumn_valid">[docs]</a>
<span class="k">def</span> <span class="nf">check_datacolumn_valid</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">datacolumn</span><span class="o">=</span><span class="s2">&quot;DATA&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check whether a data column exists and valid</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Measurement set</span>
<span class="sd">    datacolumn : str, optional</span>
<span class="sd">        Data column string in table (e.g.,DATA, CORRECTED_DATA&#39;, MODEL_DATA, FLAG, WEIGHT, WEIGHT_SPECTRUM, SIGMA, SIGMA_SPECTRUM)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        Whether valid data column is present or not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">table</span><span class="p">()</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">colnames</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">datacolumn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
            <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">model_data</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="n">datacolumn</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">model_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">model_data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">model_data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="create_circular_mask">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.create_circular_mask">[docs]</a>
<span class="k">def</span> <span class="nf">create_circular_mask</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">cellsize</span><span class="p">,</span> <span class="n">imsize</span><span class="p">,</span> <span class="n">mask_radius</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create fits solar mask</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    cellsize : float</span>
<span class="sd">        Cell size in arcsec</span>
<span class="sd">    imsize : int</span>
<span class="sd">        Imsize in number of pixels</span>
<span class="sd">    mask_radius : float</span>
<span class="sd">        Mask radius in arcmin</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Fits mask file name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">msname</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">imagename_prefix</span> <span class="o">=</span> <span class="n">msname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.ms&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_solar&quot;</span>
        <span class="n">wsclean_args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;-quiet&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-scale &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cellsize</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;asec&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-size &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">imsize</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">imsize</span><span class="p">),</span>
            <span class="s2">&quot;-nwlayers 1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-niter 0 -name &quot;</span> <span class="o">+</span> <span class="n">imagename_prefix</span><span class="p">,</span>
            <span class="s2">&quot;-channel-range 0 1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-interval 0 1&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">wsclean_cmd</span> <span class="o">=</span> <span class="s2">&quot;wsclean &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wsclean_args</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">msname</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">run_wsclean</span><span class="p">(</span><span class="n">wsclean_cmd</span><span class="p">,</span> <span class="s2">&quot;meerwsclean&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">imsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">imsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">mask_radius</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">/</span> <span class="n">cellsize</span>
            <span class="n">Y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[:</span><span class="n">imsize</span><span class="p">,</span> <span class="p">:</span><span class="n">imsize</span><span class="p">]</span>
            <span class="n">dist_from_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">X</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">dist_from_center</span> <span class="o">&lt;=</span> <span class="n">radius</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span>
                <span class="s2">&quot;cp -r &quot;</span>
                <span class="o">+</span> <span class="n">imagename_prefix</span>
                <span class="o">+</span> <span class="s2">&quot;-image.fits mask-&quot;</span>
                <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">imagename_prefix</span><span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span>
            <span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf &quot;</span> <span class="o">+</span> <span class="n">imagename_prefix</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="s2">&quot;mask-&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">imagename_prefix</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span>
                <span class="s2">&quot;mask-&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">imagename_prefix</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span>
            <span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">][</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span>
                <span class="n">imagename_prefix</span> <span class="o">+</span> <span class="s2">&quot;-mask.fits&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span>
                <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf mask-&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">imagename_prefix</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.fits&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">imagename_prefix</span> <span class="o">+</span> <span class="s2">&quot;-mask.fits&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">imagename_prefix</span> <span class="o">+</span> <span class="s2">&quot;-mask.fits&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Circular mask could not be created.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Circular mask could not be created.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span></div>



<div class="viewcode-block" id="calc_fractional_bandwidth">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.calc_fractional_bandwidth">[docs]</a>
<span class="k">def</span> <span class="nf">calc_fractional_bandwidth</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate fractional bandwidh</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of measurement set</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Fraction bandwidth in percentage</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanfreqs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bw</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
    <span class="n">frac_bandwidth</span> <span class="o">=</span> <span class="n">bw</span> <span class="o">/</span> <span class="n">msmd</span><span class="o">.</span><span class="n">meanfreq</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">frac_bandwidth</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>



<div class="viewcode-block" id="calc_dyn_range">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.calc_dyn_range">[docs]</a>
<span class="k">def</span> <span class="nf">calc_dyn_range</span><span class="p">(</span><span class="n">imagename</span><span class="p">,</span> <span class="n">modelname</span><span class="p">,</span> <span class="n">residualname</span><span class="p">,</span> <span class="n">fits_mask</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate dynamic ranges.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    imagename : list or str</span>
<span class="sd">        Image FITS file(s)</span>
<span class="sd">    modelname : list or str</span>
<span class="sd">        Model FITS file(s)</span>
<span class="sd">    residualname : list ot str</span>
<span class="sd">        Residual FITS file(s)</span>
<span class="sd">    fits_mask : str, optional</span>
<span class="sd">        FITS file mask</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model_flux : float</span>
<span class="sd">        Total model flux.</span>
<span class="sd">    dyn_range_rms : float</span>
<span class="sd">        Max/RMS dynamic range.</span>
<span class="sd">    rms : float</span>
<span class="sd">        RMS of the image</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_list</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>

    <span class="n">imagename</span> <span class="o">=</span> <span class="n">to_list</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span>
    <span class="n">modelname</span> <span class="o">=</span> <span class="n">to_list</span><span class="p">(</span><span class="n">modelname</span><span class="p">)</span>
    <span class="n">residualname</span> <span class="o">=</span> <span class="n">to_list</span><span class="p">(</span><span class="n">residualname</span><span class="p">)</span>

    <span class="n">use_mask</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">fits_mask</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fits_mask</span><span class="p">))</span>
    <span class="n">mask_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">fits_mask</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_mask</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">model_flux</span><span class="p">,</span> <span class="n">dr1</span><span class="p">,</span> <span class="n">rmsvalue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imagename</span><span class="p">)):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">imagename</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">residualname</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_mask</span><span class="p">:</span>
            <span class="n">maxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">mask_data</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">maxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">dr1</span> <span class="o">+=</span> <span class="n">maxval</span> <span class="o">/</span> <span class="n">rms</span> <span class="k">if</span> <span class="n">rms</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">rmsvalue</span> <span class="o">+=</span> <span class="n">rms</span>

    <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">modelname</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="n">model_flux</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">mask_data</span><span class="p">]</span> <span class="k">if</span> <span class="n">use_mask</span> <span class="k">else</span> <span class="n">model</span><span class="p">)</span>

    <span class="n">rmsvalue</span> <span class="o">=</span> <span class="n">rmsvalue</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">residualname</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">model_flux</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">dr1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">rmsvalue</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>



<div class="viewcode-block" id="generate_tb_map">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.generate_tb_map">[docs]</a>
<span class="k">def</span> <span class="nf">generate_tb_map</span><span class="p">(</span><span class="n">imagename</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to generate brightness temperature map</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    imagename : str</span>
<span class="sd">        Name of the flux calibrated image</span>
<span class="sd">    outfile : str, optional</span>
<span class="sd">        Output brightess temperature image name</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Output image name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating brightness temperature map for image: </span><span class="si">{</span><span class="n">imagename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outfile</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">imagename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.fits&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_TB.fits&quot;</span>
    <span class="n">image_header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span>
    <span class="n">image_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span>
    <span class="n">major</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">image_header</span><span class="p">[</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mf">3600.0</span>  <span class="c1"># In arcsec</span>
    <span class="n">minor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">image_header</span><span class="p">[</span><span class="s2">&quot;BMIN&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mf">3600.0</span>  <span class="c1"># In arcsec</span>
    <span class="k">if</span> <span class="n">image_header</span><span class="p">[</span><span class="s2">&quot;CTYPE3&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FREQ&quot;</span><span class="p">:</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">image_header</span><span class="p">[</span><span class="s2">&quot;CRVAL3&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>  <span class="c1"># In GHz</span>
    <span class="k">elif</span> <span class="n">image_header</span><span class="p">[</span><span class="s2">&quot;CTYPE4&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FREQ&quot;</span><span class="p">:</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">image_header</span><span class="p">[</span><span class="s2">&quot;CRVAL4&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>  <span class="c1"># In GHz</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No frequency information is present in header.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">TB_conv_factor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.222e6</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">freq</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">major</span> <span class="o">*</span> <span class="n">minor</span><span class="p">)</span>
    <span class="n">TB_data</span> <span class="o">=</span> <span class="n">image_data</span> <span class="o">*</span> <span class="n">TB_conv_factor</span>
    <span class="n">image_header</span><span class="p">[</span><span class="s2">&quot;BUNIT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;K&quot;</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">TB_data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">image_header</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outfile</span></div>



<span class="c1">####################</span>
<span class="c1"># uDOCKER related</span>
<span class="c1">####################</span>
<div class="viewcode-block" id="check_udocker_container">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.check_udocker_container">[docs]</a>
<span class="k">def</span> <span class="nf">check_udocker_container</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check whether a docker container is present or not</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Container name</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        Whether present or not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">tmp1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tmp1_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.txt&quot;</span>
    <span class="n">tmp2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tmp2_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.txt&quot;</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;udocker --insecure --quiet inspect &quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; &gt;&gt; </span><span class="si">{</span><span class="n">tmp1</span><span class="si">}</span><span class="s2"> &gt;&gt; </span><span class="si">{</span><span class="n">tmp2</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">tmp1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tmp2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="initialize_wsclean_container">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.initialize_wsclean_container">[docs]</a>
<span class="k">def</span> <span class="nf">initialize_wsclean_container</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;meerwsclean&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize WSClean container</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of the container</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        Whether initialized successfully or not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="s2">&quot;devojyoti96/wsclean-solar:latest&quot;</span>
    <span class="n">check_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;udocker images | grep -q &#39;</span><span class="si">{</span><span class="n">image_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="n">image_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">check_cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">image_exists</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;udocker pull </span><span class="si">{</span><span class="n">image_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image &#39;</span><span class="si">{</span><span class="n">image_name</span><span class="si">}</span><span class="s2">&#39; already present.&quot;</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;udocker create --name=</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">image_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Container started with name : </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Container could not be created with name : </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>



<div class="viewcode-block" id="run_wsclean">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.run_wsclean">[docs]</a>
<span class="k">def</span> <span class="nf">run_wsclean</span><span class="p">(</span>
    <span class="n">wsclean_cmd</span><span class="p">,</span>
    <span class="n">container_name</span><span class="o">=</span><span class="s2">&quot;meerwsclean&quot;</span><span class="p">,</span>
    <span class="n">check_container</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run WSClean inside a udocker container (no root permission required).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wsclean_cmd : str</span>
<span class="sd">        Full WSClean command as a string.</span>
<span class="sd">    container_name : str, optional</span>
<span class="sd">        Container name</span>
<span class="sd">    check_container : bool, optional</span>
<span class="sd">        Check container presence or not</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Verbose output or not</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">tmp1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tmp1_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.txt&quot;</span>
    <span class="n">tmp2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tmp2_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.txt&quot;</span>

    <span class="k">def</span> <span class="nf">show_file</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">check_container</span><span class="p">:</span>
        <span class="n">container_present</span> <span class="o">=</span> <span class="n">check_udocker_container</span><span class="p">(</span><span class="n">container_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">container_present</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">container_name</span> <span class="o">=</span> <span class="n">initialize_wsclean_container</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">container_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">container_name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Container </span><span class="si">{container_name}</span><span class="s2"> is not initiated. First initiate container and then run.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;chgenter &gt;&gt; </span><span class="si">{</span><span class="n">tmp1</span><span class="si">}</span><span class="s2"> &gt;&gt; </span><span class="si">{</span><span class="n">tmp2</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">full_command</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;udocker --quiet run --nobanner --volume=</span><span class="si">{</span><span class="n">cwd</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">cwd</span><span class="si">}</span><span class="s2"> meerwsclean </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">full_command</span><span class="p">)</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># in GB</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">tmp1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tmp2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mem</span>

    <span class="n">msname</span> <span class="o">=</span> <span class="n">wsclean_cmd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">mspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">temp_docker_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;wsclean_udocker_&quot;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">mspath</span><span class="p">)</span>
    <span class="n">wsclean_cmd_args</span> <span class="o">=</span> <span class="n">wsclean_cmd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;-fits-mask&quot;</span> <span class="ow">in</span> <span class="n">wsclean_cmd_args</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">wsclean_cmd_args</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;-fits-mask&quot;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">wsclean_cmd_args</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">namedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">wsclean_cmd_args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">wsclean_cmd_args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">temp_docker_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">basename</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;-name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wsclean_cmd_args</span><span class="p">:</span>
        <span class="n">wsclean_cmd_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;-name &quot;</span> <span class="o">+</span> <span class="n">temp_docker_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.ms&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">wsclean_cmd_args</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;-name&quot;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">wsclean_cmd_args</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">namedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">wsclean_cmd_args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">wsclean_cmd_args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">temp_docker_path</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">basename</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;-temp-dir&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wsclean_cmd_args</span><span class="p">:</span>
        <span class="n">wsclean_cmd_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-temp-dir &quot;</span> <span class="o">+</span> <span class="n">temp_docker_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">wsclean_cmd_args</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;-temp-dir&quot;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">wsclean_cmd_args</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">wsclean_cmd_args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">wsclean_cmd_args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">temp_docker_path</span><span class="p">)</span>
    <span class="n">wsclean_cmd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wsclean_cmd_args</span><span class="p">)</span>
        <span class="o">+</span> <span class="s2">&quot; &quot;</span>
        <span class="o">+</span> <span class="n">temp_docker_path</span>
        <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
        <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">full_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;udocker run --nobanner --volume=</span><span class="si">{</span><span class="n">mspath</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">temp_docker_path</span><span class="si">}</span><span class="s2"> --workdir </span><span class="si">{</span><span class="n">temp_docker_path</span><span class="si">}</span><span class="s2"> meerwsclean </span><span class="si">{</span><span class="n">wsclean_cmd</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">full_command</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; &gt;&gt; </span><span class="si">{</span><span class="n">mspath</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">tmp1</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">wsclean_cmd</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">exit_code</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">full_command</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;##########################&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;##########################&quot;</span><span class="p">)</span>
            <span class="n">show_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mspath</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">tmp1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">temp_docker_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">mspath</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">tmp1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">temp_docker_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="run_solar_sidereal_cor">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.run_solar_sidereal_cor">[docs]</a>
<span class="k">def</span> <span class="nf">run_solar_sidereal_cor</span><span class="p">(</span>
    <span class="n">msname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">only_uvw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">container_name</span><span class="o">=</span><span class="s2">&quot;meerwsclean&quot;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run chgcenter inside a udocker container to correct solar sidereal motion (no root permission required).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    only_uvw : bool, optional</span>
<span class="sd">        Update only UVW values</span>
<span class="sd">        Note: This is required when visibilities are properly phase rotated in correlator to track the Sun,</span>
<span class="sd">        but while creating the MS, UVW values are estimated using the first phasecenter of the Sun.</span>
<span class="sd">    container_name : str, optional</span>
<span class="sd">        Container name</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Verbose output or not</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">tmp1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tmp1_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.txt&quot;</span>
    <span class="n">tmp2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tmp2_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.txt&quot;</span>
    <span class="n">container_present</span> <span class="o">=</span> <span class="n">check_udocker_container</span><span class="p">(</span><span class="n">container_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">container_present</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">container_name</span> <span class="o">=</span> <span class="n">initialize_wsclean_container</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">container_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">container_name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Container </span><span class="si">{container_name}</span><span class="s2"> is not initiated. First initiate container and then run.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;chgcentre &gt;&gt; </span><span class="si">{</span><span class="n">tmp1</span><span class="si">}</span><span class="s2"> &gt;&gt; </span><span class="si">{</span><span class="n">tmp2</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">full_command</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;udocker --quiet run --nobanner --volume=</span><span class="si">{</span><span class="n">cwd</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">cwd</span><span class="si">}</span><span class="s2"> meerwsclean </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">full_command</span><span class="p">)</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># in GB</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">tmp1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tmp2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mem</span>

    <span class="n">msname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">mspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">temp_docker_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;chgcenter_udocker_&quot;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">mspath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">only_uvw</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;chgcentre -only-uvw -solarcenter &quot;</span>
            <span class="o">+</span> <span class="n">temp_docker_path</span>
            <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
            <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;chgcentre -solarcenter &quot;</span>
            <span class="o">+</span> <span class="n">temp_docker_path</span>
            <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
            <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">full_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;udocker --quiet run --nobanner --volume=</span><span class="si">{</span><span class="n">mspath</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">temp_docker_path</span><span class="si">}</span><span class="s2"> --workdir </span><span class="si">{</span><span class="n">temp_docker_path</span><span class="si">}</span><span class="s2"> meerwsclean </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">full_command</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; &gt;&gt; </span><span class="si">{</span><span class="n">tmp1</span><span class="si">}</span><span class="s2"> &gt;&gt; </span><span class="si">{</span><span class="n">tmp2</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">suppress_casa_output</span><span class="p">():</span>
            <span class="n">exit_code</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">full_command</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">temp_docker_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tmp1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tmp2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">temp_docker_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tmp1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tmp2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="run_chgcenter">
<a class="viewcode-back" href="../../../meersolar.pipeline.html#meersolar.pipeline.basic_func.run_chgcenter">[docs]</a>
<span class="k">def</span> <span class="nf">run_chgcenter</span><span class="p">(</span>
    <span class="n">msname</span><span class="p">,</span>
    <span class="n">ra</span><span class="p">,</span>
    <span class="n">dec</span><span class="p">,</span>
    <span class="n">only_uvw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">container_name</span><span class="o">=</span><span class="s2">&quot;meerwsclean&quot;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run chgcenter inside a udocker container (no root permission required).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msname : str</span>
<span class="sd">        Name of the measurement set</span>
<span class="sd">    ra : str</span>
<span class="sd">        RA can either be 00h00m00.0s or 00:00:00.0</span>
<span class="sd">    dec : str</span>
<span class="sd">        Dec can either be 00d00m00.0s or 00.00.00.0</span>
<span class="sd">    only_uvw : bool, optional</span>
<span class="sd">        Update only UVW values</span>
<span class="sd">        Note: This is required when visibilities are properly phase rotated in correlator,</span>
<span class="sd">        but while creating the MS, UVW values are estimated using a wrong phase center.</span>
<span class="sd">    container_name : str, optional</span>
<span class="sd">        Container name</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Verbose output</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Success message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">tmp1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tmp1_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.txt&quot;</span>
    <span class="n">tmp2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tmp2_</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.txt&quot;</span>
    <span class="n">container_present</span> <span class="o">=</span> <span class="n">check_udocker_container</span><span class="p">(</span><span class="n">container_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">container_present</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">container_name</span> <span class="o">=</span> <span class="n">initialize_wsclean_container</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">container_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">container_name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Container </span><span class="si">{container_name}</span><span class="s2"> is not initiated. First initiate container and then run.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;chgenter &gt;&gt; </span><span class="si">{</span><span class="n">tmp1</span><span class="si">}</span><span class="s2"> &gt;&gt; </span><span class="si">{</span><span class="n">tmp2</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">full_command</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;udocker --quiet run --nobanner --volume=</span><span class="si">{</span><span class="n">cwd</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">cwd</span><span class="si">}</span><span class="s2"> meerwsclean </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">full_command</span><span class="p">)</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># in GB</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">tmp1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tmp2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mem</span>
    <span class="n">msname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">mspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
    <span class="n">temp_docker_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;chgcenter_udocker_&quot;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">mspath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">only_uvw</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;chgcentre -only-uvw &quot;</span>
            <span class="o">+</span> <span class="n">temp_docker_path</span>
            <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
            <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; &quot;</span>
            <span class="o">+</span> <span class="n">ra</span>
            <span class="o">+</span> <span class="s2">&quot; &quot;</span>
            <span class="o">+</span> <span class="n">dec</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;chgcentre &quot;</span>
            <span class="o">+</span> <span class="n">temp_docker_path</span>
            <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
            <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; &quot;</span>
            <span class="o">+</span> <span class="n">ra</span>
            <span class="o">+</span> <span class="s2">&quot; &quot;</span>
            <span class="o">+</span> <span class="n">dec</span>
        <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">full_command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;udocker --quiet run --nobanner --volume=</span><span class="si">{</span><span class="n">mspath</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">temp_docker_path</span><span class="si">}</span><span class="s2"> --workdir </span><span class="si">{</span><span class="n">temp_docker_path</span><span class="si">}</span><span class="s2"> meerwsclean </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">full_command</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; &gt;&gt; </span><span class="si">{</span><span class="n">tmp1</span><span class="si">}</span><span class="s2"> &gt;&gt; </span><span class="si">{</span><span class="n">tmp2</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">exit_code</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">full_command</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">temp_docker_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tmp1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tmp2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">temp_docker_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tmp1</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tmp2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">return</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Devojyoti Kansabanik, Deepan Patra
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=4ebf8126"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    </body>
</html>